Microsoft Windows [Version 10.0.26100.4061]
(c) Microsoft Corporation. All rights reserved.

C:\Users\Mustafa>ssh frappe@84.247.165.136
frappe@84.247.165.136's password:
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-25-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
  _____
 / ___/___  _  _ _____ _   ___  ___
| |   / _ \| \| |_   _/ \ | _ )/ _ \
| |__| (_) | .` | | |/ _ \| _ \ (_) |
 \____\___/|_|\_| |_/_/ \_|___/\___/

Welcome!

This server is hosted by Contabo. If you have any questions or need help,
please don't hesitate to contact us at support@contabo.com.

Last login: Wed Jun 11 11:37:30 2025 from 41.238.220.215
frappe@vmi2187306:~$ cd frappe-bench/apps/svg_mobile_app/
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git fetch
remote: Enumerating objects: 75, done.
remote: Counting objects: 100% (75/75), done.
remote: Compressing objects: 100% (34/34), done.
remote: Total 66 (delta 57), reused 41 (delta 32), pack-reused 0 (from 0)
Unpacking objects: 100% (66/66), 10.38 KiB | 221.00 KiB/s, done.
From https://github.com/mostafamohamed1984/svg_mobile_app
   21a7efc..835edd8  develop    -> origin/develop
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git pull
Updating 21a7efc..835edd8
Fast-forward
 svg_mobile_app/svg_mobile_app/doctype/project_claim/project_claim.py        | 126 +++++++++++++++++++++++-------------
 .../svg_mobile_app/doctype/project_contractors/project_contractors.py       | 118 +++++++++++++++++++++++++++++----
 2 files changed, 186 insertions(+), 58 deletions(-)
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com clear-cache
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
Updating customizations for Projects Collection
Updating customizations for Payment Entry Deduction
Updating customizations for Shift Type
Updating customizations for Item
Updating customizations for Bank
Updating customizations for Payment Entry
Updating customizations for Item Barcode
Updating customizations for Employee
Updating customizations for Employee Advance
Updating customizations for Item Group
Updating customizations for Project Contractors
Updating customizations for Sketch
Queued rebuilding of search index for smartvision.com

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Run in console on both environments
   ...: import frappe
   ...: print(f"Developer Mode: {frappe.conf.get('developer_mode')}")
   ...: print(f"Debug Mode: {frappe.conf.get('debug')}")
Developer Mode: 1
Debug Mode: None


[1]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ cd ..
frappe@vmi2187306:~/frappe-bench/apps$ cd ..
frappe@vmi2187306:~/frappe-bench$ ls
apps      backup.sql  env   node_modules  package-lock.json  Procfile
archived  config      logs  package.json  patches.txt        sites
frappe@vmi2187306:~/frappe-bench$ cd sites
frappe@vmi2187306:~/frappe-bench/sites$ ls
apps.json  apps.txt  assets  common_site_config.json  smartvision.com
frappe@vmi2187306:~/frappe-bench/sites$ cd smartvision.com/
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ cat site_config.json
{
 "background_workers": "4",
 "db_name": "_86b0b85ccf42b383",
 "db_password": "P0VgtXfpXH9l2eBr",
 "db_type": "mariadb",
 "developer_mode": 1,
 "domains": [
  "erp.smartvgroup.com"
 ],
 "encryption_key": "yYLMktTZUVmwFRZP7LNszOijBKxqn-nCZyIhSU6WYo0=",
 "host_name": "https://erp.smartvgroup.com",
 "maintenance_mode": 0,
 "user_type_doctype_limit": {
  "employee_self_service": 40
 }
}
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Console test - run as Administrator on both environments
   ...: import frappe
   ...:
   ...: # Test 1: Basic Sales Invoice creation
   ...: si = frappe.new_doc("Sales Invoice")
   ...: si.customer = "Test Customer"  # Use any existing customer
   ...: si.company = "Your Company"    # Use any existing company
   ...: si.append("items", {
   ...:     "item_code": "Test Item",  # Use any existing item
   ...:     "qty": 1,
   ...:     "rate": 100
   ...: })
   ...:
   ...: try:
   ...:     si.save()
   ...:     print("SAVE: SUCCESS")
   ...:     si.submit()
   ...:     print("SUBMIT: SUCCESS")
   ...:     print(f"Created invoice: {si.name}")
   ...: except Exception as e:
   ...:     print(f"FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
FAILED: 'NoneType' object has no attribute 'payment_terms'
Traceback (most recent call last):
  File "<ipython-input-1-cb8a5deb070a>", line 15, in <module>
    si.save()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 291, in insert
    self.run_before_save_methods()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1091, in run_before_save_methods
    self.run_method("validate")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1322, in composer
    return composed(self, method, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1304, in runner
    add_to_return_value(self, fn(self, *args, **kwargs))
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 959, in fn
    return method_object(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 245, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 29, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/stock_controller.py", line 52, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 180, in validate
    self.set_missing_values(for_validate=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 652, in set_missing_values
    self.due_date = get_due_date(self.posting_date, "Customer", self.customer, self.company)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/party.py", line 574, in get_due_date
    template_name = get_payment_terms_template(party, party_type, company)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/party.py", line 718, in get_payment_terms_template
    template = customer.payment_terms
AttributeError: 'NoneType' object has no attribute 'payment_terms'


   ...: companies = frappe.get_all("Company", limit=1)
   ...: items = frappe.get_all("Item", limit=1)
   ...:
   ...: print(f"Available Customer: {customers}")
   ...: print(f"Available Company: {companies}")
   ...: print(f"Available Item: {items}")
   ...:
   ...: if customers and companies and items:
   ...:     si = frappe.new_doc("Sales Invoice")
   ...:     si.customer = customers[0].name
   ...:     si.company = companies[0].name
   ...:     si.append("items", {
   ...:         "item_code": items[0].name,
   ...:         "qty": 1,
   ...:         "rate": 100
   ...:     })
   ...:
   ...:     try:
   ...:         si.save()
   ...:         print("SAVE: SUCCESS")
   ...:         si.submit()
   ...:         print("SUBMIT: SUCCESS")
   ...:         print(f"Created invoice: {si.name}")
   ...:     except Exception as e:
   ...:         print(f"FAILED: {str(e)}")
   ...:         import traceback
   ...:         print(traceback.format_exc())
   ...: else:
   ...:     print("Missing basic master data!")
   ...:
Available Customer: [{'name': 'SVG-CUST-00009'}]
Available Company: [{'name': 'Smart Vision Engineering Consultant'}]
Available Item: [{'name': 'رسوم امانات'}]
FAILED: Exchange Rate is mandatory. Maybe Currency Exchange record is not created for EGP to AED.
Traceback (most recent call last):
  File "<ipython-input-2-2494aea5b47e>", line 21, in <module>
    si.save()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 291, in insert
    self.run_before_save_methods()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1091, in run_before_save_methods
    self.run_method("validate")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1322, in composer
    return composed(self, method, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1304, in runner
    add_to_return_value(self, fn(self, *args, **kwargs))
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 959, in fn
    return method_object(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 245, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 29, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/stock_controller.py", line 52, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 180, in validate
    self.set_missing_values(for_validate=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 654, in set_missing_values
    super().set_missing_values(for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 51, in set_missing_values
    self.set_price_list_and_item_details(for_validate=for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 110, in set_price_list_and_item_details
    self.set_missing_item_details(for_validate=for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 749, in set_missing_item_details
    ret = get_item_details(args, self, for_validate=for_validate, overwrite_warehouse=False)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 99, in get_item_details
    out.update(get_price_list_rate(args, item))
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 798, in get_price_list_rate
    validate_conversion_rate(args, meta)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 1036, in validate_conversion_rate
    validate_conversion_rate(
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 2584, in validate_conversion_rate
    throw(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 652, in throw
    msgprint(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 617, in msgprint
    _raise_exception()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 568, in _raise_exception
    raise exc
frappe.exceptions.ValidationError: Exchange Rate is mandatory. Maybe Currency Exchange record is not created for EGP toAED.


   ...: companies = frappe.get_all("Company", limit=1)
   ...: items = frappe.get_all("Item", limit=1)
   ...:
   ...: print(f"Available Customer: {customers}")
   ...: print(f"Available Company: {companies}")
   ...: print(f"Available Item: {items}")
   ...:
   ...: if customers and companies and items:
   ...:     si = frappe.new_doc("Sales Invoice")
   ...:     si.customer = customers[0].name
   ...:     si.company = companies[0].name
   ...:     si.append("items", {
   ...:         "item_code": items[0].name,
   ...:         "qty": 1,
   ...:         "rate": 100
   ...:     })
   ...:
   ...:     try:
   ...:         si.save()
   ...:         print("SAVE: SUCCESS")
   ...:         si.submit()
   ...:         print("SUBMIT: SUCCESS")
   ...:         print(f"Created invoice: {si.name}")
   ...:     except Exception as e:
   ...:         print(f"FAILED: {str(e)}")
   ...:         import traceback
   ...:         print(traceback.format_exc())
   ...: else:
   ...:     print("Missing basic master data!")
   ...:
Available Customer: [{'name': 'SVG-CUST-00009'}]
Available Company: [{'name': 'Smart Vision Engineering Consultant'}]
Available Item: [{'name': 'رسوم امانات'}]
FAILED: Exchange Rate is mandatory. Maybe Currency Exchange record is not created for EGP to AED.
Traceback (most recent call last):
  File "<ipython-input-3-2494aea5b47e>", line 21, in <module>
    si.save()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 291, in insert
    self.run_before_save_methods()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1091, in run_before_save_methods
    self.run_method("validate")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1322, in composer
    return composed(self, method, *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 1304, in runner
    add_to_return_value(self, fn(self, *args, **kwargs))
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 959, in fn
    return method_object(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 245, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 29, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/stock_controller.py", line 52, in validate
    super().validate()
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 180, in validate
    self.set_missing_values(for_validate=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/accounts/doctype/sales_invoice/sales_invoice.py", line 654, in set_missing_values
    super().set_missing_values(for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 51, in set_missing_values
    self.set_price_list_and_item_details(for_validate=for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/selling_controller.py", line 110, in set_price_list_and_item_details
    self.set_missing_item_details(for_validate=for_validate)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 749, in set_missing_item_details
    ret = get_item_details(args, self, for_validate=for_validate, overwrite_warehouse=False)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 99, in get_item_details
    out.update(get_price_list_rate(args, item))
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 798, in get_price_list_rate
    validate_conversion_rate(args, meta)
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/stock/get_item_details.py", line 1036, in validate_conversion_rate
    validate_conversion_rate(
  File "/home/frappe/frappe-bench/apps/erpnext/erpnext/controllers/accounts_controller.py", line 2584, in validate_conversion_rate
    throw(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 652, in throw
    msgprint(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 617, in msgprint
    _raise_exception()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 568, in _raise_exception
    raise exc
frappe.exceptions.ValidationError: Exchange Rate is mandatory. Maybe Currency Exchange record is not created for EGP toAED.



[2]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

   ...: companies = frappe.get_all("Company", limit=1)
   ...: items = frappe.get_all("Item", limit=1)
   ...:
   ...: print(f"Available Customer: {customers}")
   ...: print(f"Available Company: {companies}")
   ...: print(f"Available Item: {items}")
   ...:
   ...: if customers and companies and items:
   ...:     si = frappe.new_doc("Sales Invoice")
   ...:     si.customer = customers[0].name
   ...:     si.company = companies[0].name
   ...:     si.append("items", {
   ...:         "item_code": items[0].name,
   ...:         "qty": 1,
   ...:         "rate": 100
   ...:     })
   ...:
   ...:     try:
   ...:         si.save()
   ...:         print("SAVE: SUCCESS")
   ...:         si.submit()
   ...:         print("SUBMIT: SUCCESS")
   ...:         print(f"Created invoice: {si.name}")
   ...:     except Exception as e:
   ...:         print(f"FAILED: {str(e)}")
   ...:         import traceback
   ...:         print(traceback.format_exc())
   ...: else:
   ...:     print("Missing basic master data!")
   ...:
Available Customer: [{'name': 'SVG-CUST-00009'}]
Available Company: [{'name': 'Smart Vision Engineering Consultant'}]
Available Item: [{'name': 'رسوم امانات'}]

^C---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
Cell In[1], line 21
     14 si.append("items", {
     15     "item_code": items[0].name,
     16     "qty": 1,
     17     "rate": 100
     18 })
     20 try:
---> 21     si.save()
     22     print("SAVE: SUCCESS")
     23     si.submit()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:337, in Document.save(self, *args, **kwargs)
    335 def save(self, *args, **kwargs):
    336         """Wrapper for _save"""
--> 337         return self._save(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:359, in Document._save(self, ignore_permissions, ignore_version)
    356 self.flags.ignore_version = frappe.flags.in_test if ignore_version is None else ignore_version
    358 if self.get("__islocal") or not self.get("name"):
--> 359         return self.insert()
    361 self.check_if_locked()
    362 self._set_defaults()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:286, in Document.insert(self, ignore_permissions, ignore_links, ignore_if_duplicate, ignore_mandatory, set_name, set_child_names)
    284 self.check_permission("create")
    285 self.run_method("before_insert")
--> 286 self.set_new_name(set_name=set_name, set_child_names=set_child_names)
    287 self.set_parent_in_children()
    288 self.validate_higher_perm_levels()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:496, in Document.set_new_name(self, force, set_name, set_child_names)
    494         self.name = validate_name(self.doctype, set_name)
    495 else:
--> 496         set_new_name(self)
    498 if set_child_names:
    499         # set name for children
    500         for d in self.get_all_children():

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:166, in set_new_name(doc)
    163         doc.run_method("autoname")
    165 if not doc.name and autoname:
--> 166         set_name_from_naming_options(autoname, doc)
    168 # at this point, we fall back to name generation with the hash option
    169 if not doc.name:

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:204, in set_name_from_naming_options(autoname, doc)
    201                 frappe.throw(_("{0} is required").format(doc.meta.get_label(fieldname)))
    203 elif _autoname.startswith("naming_series:"):
--> 204         set_name_by_naming_series(doc)
    205 elif _autoname.startswith("prompt"):
    206         _prompt_autoname(autoname, doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:245, in set_name_by_naming_series(doc)
    242 if not doc.naming_series:
    243         frappe.throw(frappe._("Naming Series mandatory"))
--> 245 doc.name = make_autoname(doc.naming_series + ".#####", "", doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:271, in make_autoname(key, doctype, doc, ignore_validate)
    268         return _get_timestamp_prefix() + _generate_random_string(6)
    270 series = NamingSeries(key)
--> 271 return series.generate_next_name(doc, ignore_validate=ignore_validate)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:71, in NamingSeries.generate_next_name(self, doc, ignore_validate)
     68         self.validate()
     70 parts = self.series.split(".")
---> 71 return parse_naming_series(parts, doc=doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:329, in parse_naming_series(parts, doctype, doc, number_generator)
    327         if not series_set:
    328                 digits = len(e)
--> 329                 part = number_generator(name, digits)
    330                 series_set = True
    331 elif e == "YY":

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:381, in getseries(key, digits)
    377 def getseries(key, digits):
    378         # series created ?
    379         # Using frappe.qb as frappe.get_values does not allow order_by=None
    380         series = DocType("Series")
--> 381         current = (frappe.qb.from_(series).where(series.name == key).for_update().select("current")).run()
    383         if current and current[0][0] is not None:
    384                 current = current[0][0]

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:563, in Connection.query(self, sql, unbuffered)
    561     sql = sql.encode(self.encoding, "surrogateescape")
    562 self._execute_command(COMMAND.COM_QUERY, sql)
--> 563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:825, in Connection._read_query_result(self,unbuffered)
    823 else:
    824     result = MySQLResult(self)
--> 825     result.read()
    826 self._result = result
    827 if result.server_status is not None:

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:1199, in MySQLResult.read(self)
   1197 def read(self):
   1198     try:
-> 1199         first_packet = self.connection._read_packet()
   1201         if first_packet.is_ok_packet():
   1202             self._read_ok_packet(first_packet)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:744, in Connection._read_packet(self, packet_type)
    742 buff = bytearray()
    743 while True:
--> 744     packet_header = self._read_bytes(4)
    745     # if DEBUG: dump_packet(packet_header)
    747     btrl, btrh, packet_number = struct.unpack("<HBB", packet_header)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:782, in Connection._read_bytes(self, num_bytes)
    780 while True:
    781     try:
--> 782         data = self._rfile.read(num_bytes)
    783         break
    784     except OSError as e:

File /usr/lib/python3.10/socket.py:705, in SocketIO.readinto(self, b)
    703 while True:
    704     try:
--> 705         return self._sock.recv_into(b)
    706     except timeout:
    707         self._timeout_occurred = True

KeyboardInterrupt:

In [2]:

In [2]: # Test the basic sales invoice creation that was failing
   ...: si = frappe.new_doc("Sales Invoice")
   ...: si.customer = "SVG-CUST-00009"
   ...: si.company = "Smart Vision Engineering Consultant"
   ...: si.append("items", {
   ...:     "item_code": "رسوم امانات",
   ...:     "qty": 1,
   ...:     "rate": 100
   ...: })
   ...:
   ...: try:
   ...:     si.save()
   ...:     print("SAVE: SUCCESS")
   ...:     si.submit()
   ...:     print("SUBMIT: SUCCESS")
   ...:     print(f"Created invoice: {si.name}")
   ...: except Exception as e:
   ...:     print(f"FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
FAILED: (0, '')
Traceback (most recent call last):
  File "<ipython-input-2-d03c6f37b6a5>", line 12, in <module>
    si.save()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 279, in insert
    self._set_defaults()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 788, in _set_defaults
    new_doc = frappe.new_doc(df.options, parent_doc=self, parentfield=df.fieldname, as_dict=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1197, in new_doc
    new_doc = get_new_doc(doctype, parent_doc, parentfield, as_dict=as_dict)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/create_new.py", line 26, in get_new_doc
    set_dynamic_default_values(doc, parent_doc, parentfield)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/create_new.py", line 142, in set_dynamic_default_values
    default_value = get_default_based_on_another_field(df, user_permissions, parent_doc)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/create_new.py", line 175, in get_default_based_on_another_field
    default_value = frappe.db.get_value(ref_doctype, reference_name, df.fieldname)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 512, in get_value
    result = self.get_values(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 616, in get_values
    out = self._get_values_from_table(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 889, in _get_values_from_table
    return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 843, in _execute_command
    raise err.InterfaceError(0, "")
pymysql.err.InterfaceError: (0, '')


   ...: test_pc.append("items", {
   ...:     "item": "رسوم امانات",
   ...:     "rate": 1000
   ...: })
   ...:
   ...: # Add a test fee
   ...: test_pc.append("fees_and_deposits", {
   ...:     "item": "رسوم امانات",
   ...:     "rate": 500
   ...: })
   ...:
   ...: try:
   ...:     test_pc.save()
   ...:     print("Test Project Contractors saved")
   ...:
   ...:     test_pc.submit()
   ...:     print("Test Project Contractors submitted")
   ...:     print(f"Created: {test_pc.name}")
   ...:
   ...:     # Check if sales invoices were created automatically
   ...:     if test_pc.sales_invoice_created:
   ...:         print("SUCCESS: Sales invoices created automatically on submission!")
   ...:     else:
   ...:         print("No sales invoices created - checking why...")
   ...:
   ...: except Exception as e:
   ...:     print(f"FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
---------------------------------------------------------------------------
InterfaceError                            Traceback (most recent call last)
Cell In[3], line 2
      1 # Create a test Project Contractors document
----> 2 test_pc = frappe.new_doc("Project Contractors")
      3 test_pc.project_name = "Test Project"
      4 test_pc.customer = "SVG-CUST-00009"

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1197, in new_doc(doctype, parent_doc, parentfield, as_dict, **kwargs)
   1186 """Returns a new document of the given DocType with defaults set.
   1187
   1188 :param doctype: DocType of the new document.
   (...)
   1192 :param kwargs: [optional] You can specify fields as field=value pairs in function call.
   1193 """
   1195 from frappe.model.create_new import get_new_doc
-> 1197 new_doc = get_new_doc(doctype, parent_doc, parentfield, as_dict=as_dict)
   1199 return new_doc.update(kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/create_new.py:22, in get_new_doc(doctype, parent_doc, parentfield, as_dict)
     18 def get_new_doc(doctype, parent_doc=None, parentfield=None, as_dict=False):
     19         if doctype not in frappe.local.new_doc_templates:
     20                 # cache a copy of new doc as it is called
     21                 # frequently for inserts
---> 22                 frappe.local.new_doc_templates[doctype] = make_new_doc(doctype)
     24         doc = copy.deepcopy(frappe.local.new_doc_templates[doctype])
     26         set_dynamic_default_values(doc, parent_doc, parentfield)

File ~/frappe-bench/apps/frappe/frappe/model/create_new.py:35, in make_new_doc(doctype)
     34 def make_new_doc(doctype):
---> 35         doc = frappe.get_doc({"doctype": doctype, "__islocal": 1, "owner": frappe.session.user, "docstatus": 0})
     37         set_user_and_static_default_values(doc)
     39         doc._fix_numeric_types()

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1340, in get_doc(*args, **kwargs)
   1323 """Return a `frappe.model.document.Document` object of the given type and name.
   1324
   1325 :param arg1: DocType name as string **or** document JSON.
   (...)
   1336
   1337 """
   1338 import frappe.model.document
-> 1340 doc = frappe.model.document.get_doc(*args, **kwargs)
   1342 # Replace cache if stale one exists
   1343 if not kwargs.get("for_update") and (key := can_cache_doc(args)) and cache.exists(key):

File ~/frappe-bench/apps/frappe/frappe/model/document.py:83, in get_doc(*args, **kwargs)
     80         else:
     81                 raise ValueError('"doctype" is a required key')
---> 83 controller = get_controller(doctype)
     84 if controller:
     85         return controller(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:70, in get_controller(doctype)
     68 site_controllers = frappe.controllers.setdefault(frappe.local.site, {})
     69 if doctype not in site_controllers:
---> 70         site_controllers[doctype] = import_controller(doctype)
     72 return site_controllers[doctype]

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:81, in import_controller(doctype)
     79 module_name = "Core"
     80 if doctype not in DOCTYPES_FOR_DOCTYPE:
---> 81         doctype_info = frappe.db.get_value("DocType", doctype, fieldname="*")
     82         if doctype_info:
     83                 if doctype_info.custom:

File ~/frappe-bench/apps/frappe/frappe/database/database.py:512, in Database.get_value(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, cache, for_update, run, pluck, distinct, skip_locked, wait)
    464 def get_value(
    465         self,
    466         doctype,
   (...)
    480         wait=True,
    481 ):
    482         """Returns a document property or list of properties.
    483
    484         :param doctype: DocType name.
   (...)
    509                 frappe.db.get_value("System Settings", None, "date_format")
    510         """
--> 512         result = self.get_values(
    513                 doctype,
    514                 filters,
    515                 fieldname,
    516                 ignore,
    517                 as_dict,
    518                 debug,
    519                 order_by,
    520                 cache=cache,
    521                 for_update=for_update,
    522                 run=run,
    523                 pluck=pluck,
    524                 distinct=distinct,
    525                 limit=1,
    526                 skip_locked=skip_locked,
    527                 wait=wait,
    528         )
    530         if not run:
    531                 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:616, in Database.get_values(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, update, cache, for_update, run, pluck, distinct, limit, skip_locked, wait)
    614         if order_by:
    615                 order_by = "modified" if order_by == DefaultOrderBy else order_by
--> 616         out = self._get_values_from_table(
    617                 fields=fields,
    618                 filters=filters,
    619                 doctype=doctype,
    620                 as_dict=as_dict,
    621                 debug=debug,
    622                 order_by=order_by,
    623                 update=update,
    624                 run=run,
    625                 pluck=pluck,
    626                 distinct=distinct,
    627                 limit=limit,
    628                 for_update=for_update,
    629                 skip_locked=skip_locked,
    630                 wait=wait,
    631         )
    632 except Exception as e:
    633         if ignore and (
    634                 frappe.db.is_missing_column(e)
    635                 or frappe.db.is_table_missing(e)
    636                 or str(e).startswith("Invalid DocType")
    637         ):

File ~/frappe-bench/apps/frappe/frappe/database/database.py:889, in Database._get_values_from_table(self, fields, filters, doctype, as_dict, debug, order_by, update, for_update, skip_locked, wait, run, pluck, distinct, limit)
    886 if isinstance(fields, str) and fields == "*":
    887         as_dict = True
--> 889 return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:562, in Connection.query(self, sql, unbuffered)
    560 if isinstance(sql, str):
    561     sql = sql.encode(self.encoding, "surrogateescape")
--> 562 self._execute_command(COMMAND.COM_QUERY, sql)
    563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:843, in Connection._execute_command(self, command, sql)
    838 """
    839 :raise InterfaceError: If the connection is closed.
    840 :raise ValueError: If no username was specified.
    841 """
    842 if not self._sock:
--> 843     raise err.InterfaceError(0, "")
    845 # If the last query was unbuffered, make sure it finishes before
    846 # sending new commands
    847 if self._result is not None:

InterfaceError: (0, '')

In [4]: # Test currency conversion
   ...: from erpnext.setup.utils import get_exchange_rate
   ...:
   ...: rate_egp_to_aed = get_exchange_rate("EGP", "AED", frappe.utils.today())
   ...: rate_aed_to_egp = get_exchange_rate("AED", "EGP", frappe.utils.today())
   ...:
   ...: print(f"EGP to AED rate: {rate_egp_to_aed}")
   ...: print(f"AED to EGP rate: {rate_aed_to_egp}")
   ...:
   ...: if rate_egp_to_aed and rate_aed_to_egp:
   ...:     print("SUCCESS: Exchange rates are working!")
   ...: else:
   ...:     print("WARNING: Exchange rates still not working properly")
   ...:
---------------------------------------------------------------------------
InterfaceError                            Traceback (most recent call last)
Cell In[4], line 4
      1 # Test currency conversion
      2 from erpnext.setup.utils import get_exchange_rate
----> 4 rate_egp_to_aed = get_exchange_rate("EGP", "AED", frappe.utils.today())
      5 rate_aed_to_egp = get_exchange_rate("AED", "EGP", frappe.utils.today())
      7 print(f"EGP to AED rate: {rate_egp_to_aed}")

File ~/frappe-bench/apps/frappe/frappe/utils/typing_validations.py:31, in validate_argument_types.<locals>.wrapper(*args, **kwargs)
     28 if apply_condition():
     29         args, kwargs = transform_parameter_types(func, args, kwargs)
---> 31 return func(*args, **kwargs)

File ~/frappe-bench/apps/erpnext/erpnext/setup/utils.py:58, in get_exchange_rate(from_currency, to_currency, transaction_date, args)
     56 if not transaction_date:
     57         transaction_date = nowdate()
---> 58 currency_settings = frappe.get_doc("Accounts Settings").as_dict()
     59 allow_stale_rates = currency_settings.get("allow_stale")
     61 filters = [
     62         ["date", "<=", get_datetime_str(transaction_date)],
     63         ["from_currency", "=", from_currency],
     64         ["to_currency", "=", to_currency],
     65 ]

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1340, in get_doc(*args, **kwargs)
   1323 """Return a `frappe.model.document.Document` object of the given type and name.
   1324
   1325 :param arg1: DocType name as string **or** document JSON.
   (...)
   1336
   1337 """
   1338 import frappe.model.document
-> 1340 doc = frappe.model.document.get_doc(*args, **kwargs)
   1342 # Replace cache if stale one exists
   1343 if not kwargs.get("for_update") and (key := can_cache_doc(args)) and cache.exists(key):

File ~/frappe-bench/apps/frappe/frappe/model/document.py:83, in get_doc(*args, **kwargs)
     80         else:
     81                 raise ValueError('"doctype" is a required key')
---> 83 controller = get_controller(doctype)
     84 if controller:
     85         return controller(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:70, in get_controller(doctype)
     68 site_controllers = frappe.controllers.setdefault(frappe.local.site, {})
     69 if doctype not in site_controllers:
---> 70         site_controllers[doctype] = import_controller(doctype)
     72 return site_controllers[doctype]

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:81, in import_controller(doctype)
     79 module_name = "Core"
     80 if doctype not in DOCTYPES_FOR_DOCTYPE:
---> 81         doctype_info = frappe.db.get_value("DocType", doctype, fieldname="*")
     82         if doctype_info:
     83                 if doctype_info.custom:

File ~/frappe-bench/apps/frappe/frappe/database/database.py:512, in Database.get_value(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, cache, for_update, run, pluck, distinct, skip_locked, wait)
    464 def get_value(
    465         self,
    466         doctype,
   (...)
    480         wait=True,
    481 ):
    482         """Returns a document property or list of properties.
    483
    484         :param doctype: DocType name.
   (...)
    509                 frappe.db.get_value("System Settings", None, "date_format")
    510         """
--> 512         result = self.get_values(
    513                 doctype,
    514                 filters,
    515                 fieldname,
    516                 ignore,
    517                 as_dict,
    518                 debug,
    519                 order_by,
    520                 cache=cache,
    521                 for_update=for_update,
    522                 run=run,
    523                 pluck=pluck,
    524                 distinct=distinct,
    525                 limit=1,
    526                 skip_locked=skip_locked,
    527                 wait=wait,
    528         )
    530         if not run:
    531                 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:616, in Database.get_values(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, update, cache, for_update, run, pluck, distinct, limit, skip_locked, wait)
    614         if order_by:
    615                 order_by = "modified" if order_by == DefaultOrderBy else order_by
--> 616         out = self._get_values_from_table(
    617                 fields=fields,
    618                 filters=filters,
    619                 doctype=doctype,
    620                 as_dict=as_dict,
    621                 debug=debug,
    622                 order_by=order_by,
    623                 update=update,
    624                 run=run,
    625                 pluck=pluck,
    626                 distinct=distinct,
    627                 limit=limit,
    628                 for_update=for_update,
    629                 skip_locked=skip_locked,
    630                 wait=wait,
    631         )
    632 except Exception as e:
    633         if ignore and (
    634                 frappe.db.is_missing_column(e)
    635                 or frappe.db.is_table_missing(e)
    636                 or str(e).startswith("Invalid DocType")
    637         ):

File ~/frappe-bench/apps/frappe/frappe/database/database.py:889, in Database._get_values_from_table(self, fields, filters, doctype, as_dict, debug, order_by, update, for_update, skip_locked, wait, run, pluck, distinct, limit)
    886 if isinstance(fields, str) and fields == "*":
    887         as_dict = True
--> 889 return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:562, in Connection.query(self, sql, unbuffered)
    560 if isinstance(sql, str):
    561     sql = sql.encode(self.encoding, "surrogateescape")
--> 562 self._execute_command(COMMAND.COM_QUERY, sql)
    563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:843, in Connection._execute_command(self, command, sql)
    838 """
    839 :raise InterfaceError: If the connection is closed.
    840 :raise ValueError: If no username was specified.
    841 """
    842 if not self._sock:
--> 843     raise err.InterfaceError(0, "")
    845 # If the last query was unbuffered, make sure it finishes before
    846 # sending new commands
    847 if self._result is not None:

InterfaceError: (0, '')


[3]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ sudo systemctl status mysql
[sudo] password for frappe:
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2025-06-01 14:13:51 CEST; 1 week 3 days ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
   Main PID: 1769618 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 23 (limit: 126178)
     Memory: 1.9G
        CPU: 1h 12min 41.997s
     CGroup: /system.slice/mariadb.service
             └─1769618 /usr/sbin/mariadbd

Jun 11 09:23:07 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11  9:23:07 225906 [Warning] Aborted connection>
Jun 11 13:34:02 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 13:34:02 232507 [Warning] Aborted connection>
Jun 11 13:38:41 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 13:38:41 232631 [Warning] Aborted connection>
Jun 11 15:02:04 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:02:04 236579 [Warning] Aborted connection>
Jun 11 15:17:34 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:17:34 237066 [Warning] Aborted connection>
Jun 11 15:17:39 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:17:39 237068 [Warning] Aborted connection>
Jun 11 17:28:10 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 17:28:10 240792 [Warning] Aborted connection>
Jun 11 18:00:06 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 18:00:06 239899 [Warning] Aborted connection>
Jun 12 10:15:49 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-12 10:15:49 256926 [Warning] Aborted connection>
Jun 12 10:22:28 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-12 10:22:28 257084 [Warning] Aborted connection>
lines 1-23/23 (END)
[4]+  Stopped                 sudo systemctl status mysql
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ sudo systemctl status mariadb
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2025-06-01 14:13:51 CEST; 1 week 3 days ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
   Main PID: 1769618 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 23 (limit: 126178)
     Memory: 1.9G
        CPU: 1h 12min 42.030s
     CGroup: /system.slice/mariadb.service
             └─1769618 /usr/sbin/mariadbd

Jun 11 09:23:07 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11  9:23:07 225906 [Warning] Aborted connection>
Jun 11 13:34:02 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 13:34:02 232507 [Warning] Aborted connection>
Jun 11 13:38:41 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 13:38:41 232631 [Warning] Aborted connection>
Jun 11 15:02:04 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:02:04 236579 [Warning] Aborted connection>
Jun 11 15:17:34 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:17:34 237066 [Warning] Aborted connection>
Jun 11 15:17:39 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 15:17:39 237068 [Warning] Aborted connection>
Jun 11 17:28:10 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 17:28:10 240792 [Warning] Aborted connection>
Jun 11 18:00:06 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-11 18:00:06 239899 [Warning] Aborted connection>
Jun 12 10:15:49 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-12 10:15:49 256926 [Warning] Aborted connection>
Jun 12 10:22:28 vmi2187306.contaboserver.net mariadbd[1769618]: 2025-06-12 10:22:28 257084 [Warning] Aborted connection>
lines 1-23/23 (END)
[5]+  Stopped                 sudo systemctl status mariadb
frappe@vmi2187306:~/frappe-bench/sites/smartvision.com$ cd ~/frappe-bench
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"
Enter password:
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| Threads_connected | 2     |
+-------------------+-------+
frappe@vmi2187306:~/frappe-bench$ mysql -u root -p -e "SHOW STATUS LIKE 'Max_used_connections';"
Enter password:
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| Max_used_connections | 13    |
+----------------------+-------+
frappe@vmi2187306:~/frappe-bench$ mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections';"
Enter password:
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 151   |
+-----------------+-------+
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Test basic functionality
   ...: import frappe
   ...: print("Frappe loaded successfully")
   ...:
   ...: # Test database connection
   ...: result = frappe.db.sql("SELECT 1 as test")
   ...: print(f"Database test: {result}")
   ...:
   ...: # Test document creation
   ...: si = frappe.new_doc("Sales Invoice")
   ...: print("Document creation successful!")
Frappe loaded successfully
Database test: ((1,),)
Document creation successful!

   ...:     "rate": 1000
   ...: })
   ...:
   ...: # Add a test fee
   ...: test_pc.append("fees_and_deposits", {
   ...:     "item": "رسوم امانات",
   ...:     "rate": 500
   ...: })
   ...:
   ...: try:
   ...:     test_pc.save()
   ...:     print("✅ Project Contractors SAVE: SUCCESS")
   ...:
   ...:     test_pc.submit()
   ...:     print("✅ Project Contractors SUBMIT: SUCCESS")
   ...:     print(f"Created: {test_pc.name}")
   ...:
   ...:     # Check if sales invoices were created automatically
   ...:     if hasattr(test_pc, 'sales_invoice_created') and test_pc.sales_invoice_created:
   ...:         print("🎉 SUCCESS: Sales invoices created automatically on submission!")
   ...:     else:
   ...:         print("ℹ️  Checking for automatic invoice creation...")
   ...:
   ...:         # Check if any sales invoices were created for this project
   ...:         invoices = frappe.get_all("Sales Invoice",
   ...:             filters={"custom_for_project": test_pc.name},
   ...:             fields=["name", "status", "grand_total"]
   ...:         )
   ...:
   ...:         if invoices
  Cell In[2], line 39
    if invoices
               ^
SyntaxError: expected ':'


   ...:     print("✅ Project Contractors SAVE: SUCCESS")
   ...:
   ...:     test_pc.submit()
   ...:     print("✅ Project Contractors SUBMIT: SUCCESS")
   ...:     print(f"Created: {test_pc.name}")
   ...:
   ...:     # Check if sales invoices were created automatically
   ...:     if hasattr(test_pc, 'sales_invoice_created') and test_pc.sales_invoice_created:
   ...:         print("🎉 SUCCESS: Sales invoices created automatically on submission!")
   ...:     else:
   ...:         print("ℹ️  Checking for automatic invoice creation...")
   ...:
   ...:         # Check if any sales invoices were created for this project
   ...:         invoices = frappe.get_all("Sales Invoice",
   ...:             filters={"custom_for_project": test_pc.name},
   ...:             fields=["name", "status", "grand_total"]
   ...:         )
   ...:
   ...:         if invoices:
   ...:             print(f"🎉 SUCCESS: Found {len(invoices)} sales invoice(s) created:")
   ...:             for inv in invoices:
   ...:                 print(f"  - {inv.name}: {inv.status}, Total: {inv.grand_total}")
   ...:         else:
   ...:             print("❌ No sales invoices found - need to investigate why")
   ...:
   ...: except Exception as e:
   ...:     print(f"❌ FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
✅ Project Contractors SAVE: SUCCESS
^C---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
Cell In[3], line 23
     20 test_pc.save()
     21 print("✅ Project Contractors SAVE: SUCCESS")
---> 23 test_pc.submit()
     24 print("✅ Project Contractors SUBMIT: SUCCESS")
     25 print(f"Created: {test_pc.name}")

File ~/frappe-bench/apps/frappe/frappe/utils/typing_validations.py:31, in validate_argument_types.<locals>.wrapper(*args, **kwargs)
     28 if apply_condition():
     29         args, kwargs = transform_parameter_types(func, args, kwargs)
---> 31 return func(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1048, in Document.submit(self)
   1045 @frappe.whitelist()
   1046 def submit(self):
   1047         """Submit the document. Sets `docstatus` = 1, then saves."""
-> 1048         return self._submit()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1031, in Document._submit(self)
   1029 """Submit the document. Sets `docstatus` = 1, then saves."""
   1030 self.docstatus = DocStatus.submitted()
-> 1031 return self.save()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:337, in Document.save(self, *args, **kwargs)
    335 def save(self, *args, **kwargs):
    336         """Wrapper for _save"""
--> 337         return self._save(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:390, in Document._save(self, ignore_permissions, ignore_version)
    387         self.db_update()
    389 self.update_children()
--> 390 self.run_post_save_methods()
    392 # clear unsaved flag
    393 if hasattr(self, "__unsaved"):

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1131, in Document.run_post_save_methods(self)
   1129 elif self._action == "submit":
   1130         self.run_method("on_update")
-> 1131         self.run_method("on_submit")
   1132 elif self._action == "cancel":
   1133         self.run_method("on_cancel")

File ~/frappe-bench/apps/frappe/frappe/model/document.py:962, in Document.run_method(self, method, *args, **kwargs)
    959                 return method_object(*args, **kwargs)
    961 fn.__name__ = str(method)
--> 962 out = Document.hook(fn)(self, *args, **kwargs)
    964 self.run_notifications(method)
    965 run_webhooks(self, method)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1322, in Document.hook.<locals>.composer(self, *args, **kwargs)
   1319         hooks.append(frappe.get_attr(handler))
   1321 composed = compose(f, *hooks)
-> 1322 return composed(self, method, *args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1304, in Document.hook.<locals>.compose.<locals>.runner(self, method, *args, **kwargs)
   1303 def runner(self, method, *args, **kwargs):
-> 1304         add_to_return_value(self, fn(self, *args, **kwargs))
   1305         for f in hooks:
   1306                 add_to_return_value(self, f(self, method, *args, **kwargs))

File ~/frappe-bench/apps/frappe/frappe/model/document.py:959, in Document.run_method.<locals>.fn(self, *args, **kwargs)
    956 # Cannot have a field with same name as method
    957 # If method found in __dict__, expect it to be callable
    958 if method in self.__dict__ or callable(method_object):
--> 959         return method_object(*args, **kwargs)

File ~/frappe-bench/apps/svg_mobile_app/svg_mobile_app/svg_mobile_app/doctype/project_contractors/project_contractors.py:17, in ProjectContractors.on_submit(self)
     15 """Automatically create sales invoices when document is submitted"""
     16 if not self.sales_invoice_created:
---> 17         self.create_automatic_sales_invoices()

File ~/frappe-bench/apps/svg_mobile_app/svg_mobile_app/svg_mobile_app/doctype/project_contractors/project_contractors.py:62, in ProjectContractors.create_automatic_sales_invoices(self)
     60 frappe.logger().info("Creating taxable sales invoice for project items")
     61 try:
---> 62         taxable_invoice = self.create_taxable_sales_invoice()
     63         if taxable_invoice:
     64                 created_invoices.append(f"Taxable Invoice: {taxable_invoice}")

File ~/frappe-bench/apps/svg_mobile_app/svg_mobile_app/svg_mobile_app/doctype/project_contractors/project_contractors.py:179, in ProjectContractors.create_taxable_sales_invoice(self)
    177 try:
    178         frappe.logger().info("Saving sales invoice")
--> 179         sales_invoice.save()
    180         frappe.logger().info(f"Sales invoice saved with name: {sales_invoice.name}")
    182         frappe.logger().info("Submitting sales invoice")

File ~/frappe-bench/apps/frappe/frappe/model/document.py:337, in Document.save(self, *args, **kwargs)
    335 def save(self, *args, **kwargs):
    336         """Wrapper for _save"""
--> 337         return self._save(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:359, in Document._save(self, ignore_permissions, ignore_version)
    356 self.flags.ignore_version = frappe.flags.in_test if ignore_version is None else ignore_version
    358 if self.get("__islocal") or not self.get("name"):
--> 359         return self.insert()
    361 self.check_if_locked()
    362 self._set_defaults()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:286, in Document.insert(self, ignore_permissions, ignore_links, ignore_if_duplicate, ignore_mandatory, set_name, set_child_names)
    284 self.check_permission("create")
    285 self.run_method("before_insert")
--> 286 self.set_new_name(set_name=set_name, set_child_names=set_child_names)
    287 self.set_parent_in_children()
    288 self.validate_higher_perm_levels()

File ~/frappe-bench/apps/frappe/frappe/model/document.py:496, in Document.set_new_name(self, force, set_name, set_child_names)
    494         self.name = validate_name(self.doctype, set_name)
    495 else:
--> 496         set_new_name(self)
    498 if set_child_names:
    499         # set name for children
    500         for d in self.get_all_children():

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:166, in set_new_name(doc)
    163         doc.run_method("autoname")
    165 if not doc.name and autoname:
--> 166         set_name_from_naming_options(autoname, doc)
    168 # at this point, we fall back to name generation with the hash option
    169 if not doc.name:

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:204, in set_name_from_naming_options(autoname, doc)
    201                 frappe.throw(_("{0} is required").format(doc.meta.get_label(fieldname)))
    203 elif _autoname.startswith("naming_series:"):
--> 204         set_name_by_naming_series(doc)
    205 elif _autoname.startswith("prompt"):
    206         _prompt_autoname(autoname, doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:245, in set_name_by_naming_series(doc)
    242 if not doc.naming_series:
    243         frappe.throw(frappe._("Naming Series mandatory"))
--> 245 doc.name = make_autoname(doc.naming_series + ".#####", "", doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:271, in make_autoname(key, doctype, doc, ignore_validate)
    268         return _get_timestamp_prefix() + _generate_random_string(6)
    270 series = NamingSeries(key)
--> 271 return series.generate_next_name(doc, ignore_validate=ignore_validate)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:71, in NamingSeries.generate_next_name(self, doc, ignore_validate)
     68         self.validate()
     70 parts = self.series.split(".")
---> 71 return parse_naming_series(parts, doc=doc)

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:329, in parse_naming_series(parts, doctype, doc, number_generator)
    327         if not series_set:
    328                 digits = len(e)
--> 329                 part = number_generator(name, digits)
    330                 series_set = True
    331 elif e == "YY":

File ~/frappe-bench/apps/frappe/frappe/model/naming.py:381, in getseries(key, digits)
    377 def getseries(key, digits):
    378         # series created ?
    379         # Using frappe.qb as frappe.get_values does not allow order_by=None
    380         series = DocType("Series")
--> 381         current = (frappe.qb.from_(series).where(series.name == key).for_update().select("current")).run()
    383         if current and current[0][0] is not None:
    384                 current = current[0][0]

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:563, in Connection.query(self, sql, unbuffered)
    561     sql = sql.encode(self.encoding, "surrogateescape")
    562 self._execute_command(COMMAND.COM_QUERY, sql)
--> 563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:825, in Connection._read_query_result(self,unbuffered)
    823 else:
    824     result = MySQLResult(self)
--> 825     result.read()
    826 self._result = result
    827 if result.server_status is not None:

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:1199, in MySQLResult.read(self)
   1197 def read(self):
   1198     try:
-> 1199         first_packet = self.connection._read_packet()
   1201         if first_packet.is_ok_packet():
   1202             self._read_ok_packet(first_packet)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:744, in Connection._read_packet(self, packet_type)
    742 buff = bytearray()
    743 while True:
--> 744     packet_header = self._read_bytes(4)
    745     # if DEBUG: dump_packet(packet_header)
    747     btrl, btrh, packet_number = struct.unpack("<HBB", packet_header)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:782, in Connection._read_bytes(self, num_bytes)
    780 while True:
    781     try:
--> 782         data = self._rfile.read(num_bytes)
    783         break
    784     except OSError as e:

File /usr/lib/python3.10/socket.py:705, in SocketIO.readinto(self, b)
    703 while True:
    704     try:
--> 705         return self._sock.recv_into(b)
    706     except timeout:
    707         self._timeout_occurred = True

KeyboardInterrupt:

   ...:     "rate": 1000
   ...: })
   ...:
   ...: try:
   ...:     test_pc.save()
   ...:     print("✅ Project Contractors SAVE: SUCCESS")
   ...:
   ...:     # Test the sales invoice creation method directly but without submission
   ...:     si = frappe.new_doc("Sales Invoice")
   ...:     si.customer = test_pc.customer
   ...:     si.company = test_pc.company
   ...:     si.project_name = test_pc.project_name
   ...:     si.custom_for_project = test_pc.name
   ...:
   ...:     si.append("items", {
   ...:         "item_code": "رسوم امانات",
   ...:         "qty": 1,
   ...:         "rate": 1000,
   ...:         "amount": 1000
   ...:     })
   ...:
   ...:     si.save()
   ...:     print("✅ Sales Invoice SAVE: SUCCESS")
   ...:     print(f"Sales Invoice created: {si.name}")
   ...:
   ...: except Exception as e:
   ...:     print(f"❌ FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
❌ FAILED: (0, '')
Traceback (most recent call last):
  File "<ipython-input-4-2e6827a52e53>", line 14, in <module>
    test_pc.save()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 283, in insert
    self._validate_links()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 921, in _validate_links
    invalid_links, cancelled_links = self.get_invalid_links()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 811, in get_invalid_links
    values = frappe.db.get_value(doctype, docname, values_to_fetch, as_dict=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 512, in get_value
    result = self.get_values(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 616, in get_values
    out = self._get_values_from_table(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 889, in _get_values_from_table
    return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 843, in _execute_command
    raise err.InterfaceError(0, "")
pymysql.err.InterfaceError: (0, '')



[6]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
frappe@vmi2187306:~/frappe-bench$ sudo systemctl restart mariadb
frappe@vmi2187306:~/frappe-bench$ sudo systemctl status mariadb
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2025-06-12 10:30:19 CEST; 26s ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
    Process: 2218816 ExecStartPre=/usr/bin/install -m 755 -o mysql -g root -d /var/run/mysqld (code=exited, status=0/SU>
    Process: 2218817 ExecStartPre=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/S>
    Process: 2218819 ExecStartPre=/bin/sh -c [ ! -e /usr/bin/galera_recovery ] && VAR= ||   VAR=`cd /usr/bin/..; /usr/b>
    Process: 2218896 ExecStartPost=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/>
    Process: 2218898 ExecStartPost=/etc/mysql/debian-start (code=exited, status=0/SUCCESS)
   Main PID: 2218885 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 15 (limit: 126178)
     Memory: 651.0M
        CPU: 5.505s
     CGroup: /system.slice/mariadb.service
             └─2218885 /usr/sbin/mariadbd

Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:19 0 [Note] Server socket created on I>
Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:19 0 [Note] /usr/sbin/mariadbd: ready >
Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: Version: '10.6.18-MariaDB-0ubuntu0.22.04.1'  socket: '/>
Jun 12 10:30:19 vmi2187306.contaboserver.net systemd[1]: Started MariaDB 10.6.18 database server.
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: Looking for 'mariadb' as: /usr/bin/maria>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: Looking for 'mariadb-check' as: /usr/bin>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: This installation of MariaDB is already >
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: There is no need to run mysql_upgrade ag>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: You can use --force if you still want to>
Jun 12 10:30:24 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:24 0 [Note] InnoDB: Buffer pool(s) loa>
lines 1-28/28 (END)
[7]+  Stopped                 sudo systemctl status mariadb
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

   ...:
   ...:     # Test 3: Document submission (this was hanging before)
   ...:     print("\n=== Testing Document Submission ===")
   ...:     test_pc.submit()
   ...:     print("✅ Project Contractors SUBMIT: SUCCESS")
   ...:     print(f"✅ Created: {test_pc.name}")
   ...:
   ...:     # Test 4: Check if sales invoices were created
   ...:     print("\n=== Checking Sales Invoice Creation ===")
   ...:     if hasattr(test_pc, 'sales_invoice_created') and test_pc.sales_invoice_created:
   ...:         print("🎉 SUCCESS: Sales invoices created automatically!")
   ...:
   ...:     # Check for created invoices
   ...:     invoices = frappe.get_all("Sales Invoice",
   ...:         filters={"custom_for_project": test_pc.name},
   ...:         fields=["name", "status", "grand_total"]
   ...:     )
   ...:
   ...:     if invoices:
   ...:         print(f"🎉 Found {len(invoices)} sales invoice(s):")
   ...:         for inv in invoices:
   ...:             print(f"  - {inv.name}: {inv.status}, Total: {inv.grand_total}")
   ...:     else:
   ...:         print("ℹ️  No sales invoices found yet")
   ...:
   ...: except Exception as e:
   ...:     print(f"❌ FAILED: {str(e)}")
   ...:     import traceback
   ...:     print(traceback.format_exc())
   ...:
=== Testing Database Connection ===
✅ Database test: ((1,),)

=== Testing Document Creation ===
✅ Project Contractors SAVE: SUCCESS

=== Testing Document Submission ===
✅ Project Contractors SUBMIT: SUCCESS
✅ Created: PRO-00059

=== Checking Sales Invoice Creation ===
🎉 SUCCESS: Sales invoices created automatically!
🎉 Found 2 sales invoice(s):
  - ACC-SINV-2025-00083: Unpaid, Total: 500.0
  - ACC-SINV-2025-00082: Unpaid, Total: 1000.0


[8]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ bench status
Usage: bench frappe [OPTIONS] COMMAND [ARGS]...
Try 'bench frappe --help' for help.

Error: No such command 'status'.
frappe@vmi2187306:~/frappe-bench$ sudo supervisorctl status
frappe-bench-redis:frappe-bench-redis-cache               RUNNING   pid 2130609, uptime 1 day, 22:08:03
frappe-bench-redis:frappe-bench-redis-queue               RUNNING   pid 2130610, uptime 1 day, 22:08:03
frappe-bench-web:frappe-bench-frappe-web                  RUNNING   pid 2218992, uptime 0:03:25
frappe-bench-web:frappe-bench-node-socketio               RUNNING   pid 2218993, uptime 0:03:25
frappe-bench-workers:frappe-bench-frappe-long-worker-0    RUNNING   pid 2219021, uptime 0:03:23
frappe-bench-workers:frappe-bench-frappe-schedule         RUNNING   pid 2219019, uptime 0:03:23
frappe-bench-workers:frappe-bench-frappe-short-worker-0   RUNNING   pid 2219020, uptime 0:03:23
test-bench-redis:test-bench-redis-cache                   RUNNING   pid 2130624, uptime 1 day, 22:08:03
test-bench-redis:test-bench-redis-queue                   RUNNING   pid 2130625, uptime 1 day, 22:08:03
test-bench-web:test-bench-frappe-web                      RUNNING   pid 2219162, uptime 0:00:04
test-bench-web:test-bench-node-socketio                   RUNNING   pid 2171907, uptime 22:30:14
test-bench-workers:test-bench-frappe-long-worker-0        RUNNING   pid 2171919, uptime 22:30:12
test-bench-workers:test-bench-frappe-schedule             RUNNING   pid 2171917, uptime 22:30:12
test-bench-workers:test-bench-frappe-short-worker-0       RUNNING   pid 2171918, uptime 22:30:12
frappe@vmi2187306:~/frappe-bench$ ps aux | grep frappe
frappe    673733  0.0  0.0  17100  9512 ?        Ss   Apr17   0:00 /lib/systemd/systemd --user
frappe    673734  0.0  0.0 170136  4824 ?        S    Apr17   0:00 (sd-pam)
frappe    675862  0.1  0.0  72404  6876 ?        Ssl  Apr17 150:06 redis-server 127.0.0.1:18003
frappe    675876  0.1  0.0 107732 14784 ?        Ssl  Apr17 158:43 redis-server 127.0.0.1:18001
frappe    675882  0.1  0.0  72404  6748 ?        Ssl  Apr17 150:53 redis-server 127.0.0.1:18002
frappe    758639  0.0  0.4 109556 80700 ?        S    Apr22   0:02 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe serve --port 8001
frappe   2130609  0.2  0.1  83124 16460 ?        Sl   Jun10   7:08 /usr/bin/redis-server 127.0.0.1:13000
frappe   2130610  0.2  0.0  72372 10364 ?        Sl   Jun10   6:51 /usr/bin/redis-server 127.0.0.1:11000
frappe   2130624  0.2  0.1  88244 17760 ?        Sl   Jun10   6:12 /usr/bin/redis-server 127.0.0.1:18010
frappe   2130625  0.2  0.0  72372 10504 ?        Sl   Jun10   5:42 /usr/bin/redis-server 127.0.0.1:18004
frappe   2171907  0.0  0.3 638040 59640 ?        Sl   Jun11   0:04 /home/frappe/.nvm/versions/node/v18.20.4/bin/node /home/frappe/test-bench/apps/frappe/socketio.js
frappe   2171917  0.0  0.4 100544 71832 ?        SN   Jun11   1:07 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe schedule
frappe   2171918  0.1  0.4 170004 68180 ?        SNl  Jun11   1:36 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue short,default
frappe   2171919  0.1  0.4 169864 68496 ?        SNl  Jun11   1:35 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue long,default,short
frappe   2187643 12.0  2.0 1745924 337732 ?      Sl   Jun11 122:08 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe serve --port 8001
root     2217649  0.0  0.0  17188 11020 ?        Ss   10:10   0:00 sshd: frappe [priv]
frappe   2217679  0.0  0.0  17320  8180 ?        S    10:10   0:00 sshd: frappe@pts/0
frappe   2217682  0.0  0.0  15216  9296 pts/0    Ss   10:10   0:00 -bash
frappe   2218206  0.1  0.5 257536 85516 pts/0    Tl   10:16   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218248  0.2  0.6 288148 113208 pts/0   Tl   10:17   0:02 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218374  0.3  0.8 308396 132360 pts/0   Tl   10:20   0:03 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218624  0.7  0.7 305984 130216 pts/0   Tl   10:25   0:04 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218992  0.5  0.4 107900 80144 ?        S    10:31   0:01 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2218993  0.5  0.3 933196 63136 ?        Sl   10:31   0:01 /home/frappe/.nvm/versions/node/v18.20.4/bin/node /home/frappe/frappe-bench/apps/frappe/socketio.js
frappe   2219004  0.1  0.4 115924 72320 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219005  0.2  0.4 121316 79548 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219006  0.4  0.4 123300 81704 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219011  0.4  0.5 131292 89900 ?        S    10:31   0:01 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219012  0.4  0.4 123312 81668 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219013  0.0  0.4 116448 75032 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219014  0.1  0.4 109976 66428 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219015  0.3  0.4 120804 79684 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219016  0.1  0.4 116292 74920 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219017  0.1  0.4 114400 70208 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219018  0.2  0.4 119288 78320 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219019  0.3  0.3  86196 60860 ?        SN   10:31   0:00 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe schedule
frappe   2219020  0.3  0.3 158096 59260 ?        SNl  10:31   0:00 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue short,default
frappe   2219021  0.3  0.3 158096 59116 ?        SNl  10:31   0:00 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue long,default,short
frappe   2219022  0.1  0.4 114404 70836 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219023  0.0  0.4 110868 67116 ?        S    10:31   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2219041  1.2  0.7 290864 115496 pts/0   Tl   10:31   0:02 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219166 23.6  0.5 112160 83104 ?        S    10:34   0:00 /home/frappe/test-bench/env/bin/python /home/frappe/test-bench/env/bin/gunicorn -b 127.0.0.1:8001 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 10000 --graceful-timeout 30 frappe.app:application --preload
frappe   2219167  0.0  0.0  12672  3432 pts/0    R+   10:34   0:00 ps aux
frappe   2219168  0.0  0.0   9212  2252 pts/0    S+   10:34   0:00 grep --color=auto frappe
frappe@vmi2187306:~/frappe-bench$ curl -I https://erp.smartvgroup.com
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 12 Jun 2025 08:34:38 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 346953
Connection: keep-alive
Vary: Accept-Encoding
X-Page-Name: login
X-From-Cache: False
Link: </assets/frappe/dist/css/website.bundle.HA7LD4VZ.css>; rel=preload; as=style,</assets/erpnext/dist/css/erpnext-web.bundle.GOXCVPOJ.css>; rel=preload; as=style,</assets/frappe/dist/css/login.bundle.TXS56UIH.css>; rel=preload; as=style,</assets/frappe/dist/js/frappe-web.bundle.FWWFRIJG.js>; rel=preload; as=script,</website_script.js>; rel=preload; as=script,</assets/erpnext/dist/js/erpnext-web.bundle.J4A2DQB4.js>; rel=preload; as=script
Set-Cookie: sid=Guest; Expires=Thu, 19 Jun 2025 10:34:38 GMT; Max-Age=612000; Secure; HttpOnly; Path=/; SameSite=Lax
Set-Cookie: system_user=yes; Secure; Path=/; SameSite=Lax
Set-Cookie: full_name=Guest; Secure; Path=/; SameSite=Lax
Set-Cookie: user_id=Guest; Secure; Path=/; SameSite=Lax
Set-Cookie: user_image=; Secure; Path=/; SameSite=Lax
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: same-origin, strict-origin-when-cross-origin

frappe@vmi2187306:~/frappe-bench$ tail -20 ~/frappe-bench/logs/web.error.log
[2025-06-12 10:31:02 +0200] [2218545] [INFO] Worker exiting (pid: 2218545)
[2025-06-12 10:31:02 +0200] [2218544] [INFO] Worker exiting (pid: 2218544)
[2025-06-12 10:31:02 +0200] [2218546] [INFO] Worker exiting (pid: 2218546)
[2025-06-12 10:31:02 +0200] [2218523] [INFO] Shutting down: Master
[2025-06-12 10:31:03 +0200] [2218992] [INFO] Starting gunicorn 22.0.0
[2025-06-12 10:31:03 +0200] [2218992] [INFO] Listening at: http://127.0.0.1:8000 (2218992)
[2025-06-12 10:31:03 +0200] [2218992] [INFO] Using worker: sync
[2025-06-12 10:31:03 +0200] [2219004] [INFO] Booting worker with pid: 2219004
[2025-06-12 10:31:03 +0200] [2219005] [INFO] Booting worker with pid: 2219005
[2025-06-12 10:31:03 +0200] [2219006] [INFO] Booting worker with pid: 2219006
[2025-06-12 10:31:03 +0200] [2219011] [INFO] Booting worker with pid: 2219011
[2025-06-12 10:31:03 +0200] [2219012] [INFO] Booting worker with pid: 2219012
[2025-06-12 10:31:03 +0200] [2219013] [INFO] Booting worker with pid: 2219013
[2025-06-12 10:31:04 +0200] [2219014] [INFO] Booting worker with pid: 2219014
[2025-06-12 10:31:04 +0200] [2219015] [INFO] Booting worker with pid: 2219015
[2025-06-12 10:31:04 +0200] [2219016] [INFO] Booting worker with pid: 2219016
[2025-06-12 10:31:04 +0200] [2219017] [INFO] Booting worker with pid: 2219017
[2025-06-12 10:31:04 +0200] [2219018] [INFO] Booting worker with pid: 2219018
[2025-06-12 10:31:04 +0200] [2219022] [INFO] Booting worker with pid: 2219022
[2025-06-12 10:31:04 +0200] [2219023] [INFO] Booting worker with pid: 2219023
frappe@vmi2187306:~/frappe-bench$ tail -20 ~/frappe-bench/logs/worker.error.log
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/background_jobs.py", line 244, in execute_job
    frappe.db.rollback()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1054, in rollback
    self.sql("rollback")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 204, in sql
    self.connect()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 109, in connect
    self._conn: "MariadbConnection" | "PostgresConnection" = self.get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 107, in get_connection
    conn = self._get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 113, in _get_connection
    return self.create_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 116, in create_connection
    return pymysql.connect(**self.get_connection_settings())
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 361, in __init__
    self.connect()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 716, in connect
    raise exc
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([Errno 111] Connection refused)")

frappe@vmi2187306:~/frappe-bench$ sudo systemctl status mariadb
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2025-06-12 10:30:19 CEST; 5min ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
    Process: 2218816 ExecStartPre=/usr/bin/install -m 755 -o mysql -g root -d /var/run/mysqld (code=exited, status=0/SU>
    Process: 2218817 ExecStartPre=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/S>
    Process: 2218819 ExecStartPre=/bin/sh -c [ ! -e /usr/bin/galera_recovery ] && VAR= ||   VAR=`cd /usr/bin/..; /usr/b>
    Process: 2218896 ExecStartPost=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/>
    Process: 2218898 ExecStartPost=/etc/mysql/debian-start (code=exited, status=0/SUCCESS)
   Main PID: 2218885 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 15 (limit: 126178)
     Memory: 677.8M
        CPU: 7.039s
     CGroup: /system.slice/mariadb.service
             └─2218885 /usr/sbin/mariadbd

Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:19 0 [Note] Server socket created on I>
Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:19 0 [Note] /usr/sbin/mariadbd: ready >
Jun 12 10:30:19 vmi2187306.contaboserver.net mariadbd[2218885]: Version: '10.6.18-MariaDB-0ubuntu0.22.04.1'  socket: '/>
Jun 12 10:30:19 vmi2187306.contaboserver.net systemd[1]: Started MariaDB 10.6.18 database server.
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: Looking for 'mariadb' as: /usr/bin/maria>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: Looking for 'mariadb-check' as: /usr/bin>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: This installation of MariaDB is already >
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: There is no need to run mysql_upgrade ag>
Jun 12 10:30:19 vmi2187306.contaboserver.net /etc/mysql/debian-start[2218903]: You can use --force if you still want to>
Jun 12 10:30:24 vmi2187306.contaboserver.net mariadbd[2218885]: 2025-06-12 10:30:24 0 [Note] InnoDB: Buffer pool(s) loa>
lines 1-28/28 (END)
[9]+  Stopped                 sudo systemctl status mariadb
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: import frappe
   ...: result = frappe.db.sql("SELECT 1 as test")
   ...: print(f"Database test: {result}")
Database test: ((1,),)


[10]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ # Monitor logs in real-time (optional)
tail -f ~/frappe-bench/logs/web.error.log
[2025-06-12 10:35:49 +0200] [2219239] [INFO] Booting worker with pid: 2219239
[2025-06-12 10:35:49 +0200] [2219240] [INFO] Booting worker with pid: 2219240
[2025-06-12 10:35:49 +0200] [2219241] [INFO] Booting worker with pid: 2219241
[2025-06-12 10:35:49 +0200] [2219242] [INFO] Booting worker with pid: 2219242
[2025-06-12 10:35:49 +0200] [2219243] [INFO] Booting worker with pid: 2219243
[2025-06-12 10:35:49 +0200] [2219247] [INFO] Booting worker with pid: 2219247
[2025-06-12 10:35:49 +0200] [2219248] [INFO] Booting worker with pid: 2219248
[2025-06-12 10:35:49 +0200] [2219249] [INFO] Booting worker with pid: 2219249
[2025-06-12 10:35:49 +0200] [2219250] [INFO] Booting worker with pid: 2219250
[2025-06-12 10:35:49 +0200] [2219251] [INFO] Booting worker with pid: 2219251

^Z
[11]+  Stopped                 tail -f ~/frappe-bench/logs/web.error.log
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
^C
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 187, in run
    self.post_schema_updates()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 44, in wrapper
    ret = method(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 142, in post_schema_updates
    sync_customizations()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 117, in sync_customizations
    sync_customizations_for_doctype(data, folder, fname)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 193, in sync_customizations_for_doctype
    frappe.db.updatedb(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 443, in updatedb
    db_table.sync()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/schema.py", line 44, in sync
    self.alter()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/schema.py", line 111, in alter
    frappe.db.sql_ddl(query)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 410, in sql_ddl
    self.sql(query, debug=debug)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 825, in _read_query_result
    result.read()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 744, in _read_packet
    packet_header = self._read_bytes(4)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 782, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "/usr/lib/python3.10/socket.py", line 705, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: 5740354900026072187

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: 6078761364020573367

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 114, in <module>
    main()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 20, in main
    click.Group(commands=commands)(prog_name="bench")
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1157, in __call__
    return self.main(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1078, in main
    rv = self.invoke(ctx)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1434, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 783, in invoke
    return __callback(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/__init__.py", line 29, in _func
    ret = f(frappe._dict(ctx.obj), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/site.py", line 660, in migrate
    SiteMigration(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 189, in run
    self.tearDown()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 93, in tearDown
    clear_website_cache()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 406, in clear_website_cache
    clear_cache(path)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 401, in clear_cache
    for method in frappe.get_hooks("website_clear_cache"):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1648, in get_hooks
    hooks = _dict(_load_app_hooks())
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1613, in _load_app_hooks
    apps = [app_name] if app_name else get_installed_apps(_ensure_on_bench=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1582, in get_installed_apps
    installed = json.loads(db.get_global("installed_apps") or "[]")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 998, in get_global
    return self.get_default(key, user)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1002, in get_default
    d = self.get_defaults(key, parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1018, in get_defaults
    defaults = frappe.defaults.get_defaults_for(parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/defaults.py", line 236, in get_defaults_for
    frappe.qb.from_(table)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 843, in _execute_command
    raise err.InterfaceError(0, "")
pymysql.err.InterfaceError: (0, '')
frappe@vmi2187306:~/frappe-bench$ # Test if database is responsive
mysql -u root -p -e "SHOW PROCESSLIST;"
Enter password:
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id  | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
|  71 | _86b0b85ccf42b383 | localhost:49960 | _86b0b85ccf42b383 | Sleep   |  513 |          | NULL             |    0.000 |
| 228 | _86b0b85ccf42b383 | localhost:50284 | _86b0b85ccf42b383 | Sleep   |  239 |          | NULL             |    0.000 |
| 287 | root              | localhost       | NULL              | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench$ mysql -u root -p -e "SHOW FULL PROCESSLIST;" | grep -v "Sleep"
Enter password:
Id      User    Host    db      Command Time    State   Info    Progress
288     root    localhost       NULL    Query   0       starting        SHOW FULL PROCESSLIST   0.000
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate --verbose
Usage: bench  migrate [OPTIONS]
Try 'bench  migrate --help' for help.

Error: No such option: --verbose
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate --skip-failing
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
^C
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 187, in run
    self.post_schema_updates()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 44, in wrapper
    ret = method(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 142, in post_schema_updates
    sync_customizations()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 117, in sync_customizations
    sync_customizations_for_doctype(data, folder, fname)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 193, in sync_customizations_for_doctype
    frappe.db.updatedb(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 443, in updatedb
    db_table.sync()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/schema.py", line 44, in sync
    self.alter()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/schema.py", line 111, in alter
    frappe.db.sql_ddl(query)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 410, in sql_ddl
    self.sql(query, debug=debug)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 825, in _read_query_result
    result.read()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 744, in _read_packet
    packet_header = self._read_bytes(4)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 782, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "/usr/lib/python3.10/socket.py", line 705, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: 5740354900026072187

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: 1252436901408538272

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 114, in <module>
    main()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 20, in main
    click.Group(commands=commands)(prog_name="bench")
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1157, in __call__
    return self.main(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1078, in main
    rv = self.invoke(ctx)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1434, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 783, in invoke
    return __callback(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/__init__.py", line 29, in _func
    ret = f(frappe._dict(ctx.obj), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/site.py", line 660, in migrate
    SiteMigration(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 189, in run
    self.tearDown()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 93, in tearDown
    clear_website_cache()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 406, in clear_website_cache
    clear_cache(path)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 401, in clear_cache
    for method in frappe.get_hooks("website_clear_cache"):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1648, in get_hooks
    hooks = _dict(_load_app_hooks())
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1613, in _load_app_hooks
    apps = [app_name] if app_name else get_installed_apps(_ensure_on_bench=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1582, in get_installed_apps
    installed = json.loads(db.get_global("installed_apps") or "[]")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 998, in get_global
    return self.get_default(key, user)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1002, in get_default
    d = self.get_defaults(key, parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1018, in get_defaults
    defaults = frappe.defaults.get_defaults_for(parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/defaults.py", line 236, in get_defaults_for
    frappe.qb.from_(table)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 843, in _execute_command
    raise err.InterfaceError(0, "")
pymysql.err.InterfaceError: (0, '')
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 375
Server version: 10.6.18-MariaDB-0ubuntu0.22.04.1 Ubuntu 22.04

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [_86b0b85ccf42b383]> SHOW PROCESSLIST;
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+------->
| Id  | User              | Host            | db                | Command | Time | State    | Info             | Progre>
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+------->
|  71 | _86b0b85ccf42b383 | localhost:49960 | _86b0b85ccf42b383 | Sleep   |  693 |          | NULL             |    0.0>
| 228 | _86b0b85ccf42b383 | localhost:50284 | _86b0b85ccf42b383 | Sleep   |  419 |          | NULL             |    0.0>
| 375 | _86b0b85ccf42b383 | localhost:50590 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.0>
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+------->

[12]+  Stopped                 bench --site smartvision.com mariadb
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: frappe.get_doc("DocType", "Fees and Deposits")
Out[1]: <DocType: Fees and Deposits>

In [2]: # In the console you already have open:
   ...: doc = frappe.get_doc("DocType", "Fees and Deposits")
   ...: print("DocType exists and is accessible")
   ...:
   ...: # Check for any custom fields
   ...: custom_fields = frappe.get_all("Custom Field", filters={"dt": "Fees and Deposits"})
   ...: print(f"Custom fields count: {len(custom_fields)}")
   ...:
   ...: # Check for any property setters (customizations)
   ...: property_setters = frappe.get_all("Property Setter", filters={"doc_type": "Fees and Deposits"})
   ...: print(f"Property setters count: {len(property_setters)}")
   ...:
   ...: # Check if there are any problematic customizations
   ...: for ps in property_setters:
   ...:     ps_doc = frappe.get_doc("Property Setter", ps.name)
   ...:     print(f"Property Setter: {ps_doc.property} = {ps_doc.value}")
   ...:
DocType exists and is accessible
Custom fields count: 4
Property setters count: 0

In [3]: # Still in console:
   ...: frappe.clear_cache(doctype="Fees and Deposits")
   ...: frappe.db.commit()

In [4]: exit

frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate --skip-search-index
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
^C
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 187, in run
    self.post_schema_updates()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 44, in wrapper
    ret = method(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 142, in post_schema_updates
    sync_customizations()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 117, in sync_customizations
    sync_customizations_for_doctype(data, folder, fname)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/modules/utils.py", line 193, in sync_customizations_for_doctype
    frappe.db.updatedb(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 443, in updatedb
    db_table.sync()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/schema.py", line 44, in sync
    self.alter()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/schema.py", line 111, in alter
    frappe.db.sql_ddl(query)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 410, in sql_ddl
    self.sql(query, debug=debug)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 563, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 825, in _read_query_result
    result.read()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 1199, in read
    first_packet = self.connection._read_packet()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 744, in _read_packet
    packet_header = self._read_bytes(4)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 782, in _read_bytes
    data = self._rfile.read(num_bytes)
  File "/usr/lib/python3.10/socket.py", line 705, in readinto
    return self._sock.recv_into(b)
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: 5740354900026072187

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 57, in wrapper
    return frappe.local.request_cache[func][args_key]
KeyError: -3411606626922485752

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 114, in <module>
    main()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 20, in main
    click.Group(commands=commands)(prog_name="bench")
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1157, in __call__
    return self.main(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1078, in main
    rv = self.invoke(ctx)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1434, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 783, in invoke
    return __callback(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/__init__.py", line 29, in _func
    ret = f(frappe._dict(ctx.obj), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/site.py", line 660, in migrate
    SiteMigration(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 189, in run
    self.tearDown()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 93, in tearDown
    clear_website_cache()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 406, in clear_website_cache
    clear_cache(path)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/website/utils.py", line 401, in clear_cache
    for method in frappe.get_hooks("website_clear_cache"):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1648, in get_hooks
    hooks = _dict(_load_app_hooks())
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1613, in _load_app_hooks
    apps = [app_name] if app_name else get_installed_apps(_ensure_on_bench=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/caching.py", line 59, in wrapper
    return_val = func(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1582, in get_installed_apps
    installed = json.loads(db.get_global("installed_apps") or "[]")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 998, in get_global
    return self.get_default(key, user)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1002, in get_default
    d = self.get_defaults(key, parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 1018, in get_defaults
    defaults = frappe.defaults.get_defaults_for(parent)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/defaults.py", line 236, in get_defaults_for
    frappe.qb.from_(table)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 227, in sql
    self._cursor.execute(query, values)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 153, in execute
    result = self._query(query)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py", line 322, in _query
    conn.query(q)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 562, in query
    self._execute_command(COMMAND.COM_QUERY, sql)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 843, in _execute_command
    raise err.InterfaceError(0, "")
pymysql.err.InterfaceError: (0, '')
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com reload-doctype "Fees and Deposits"
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Get the custom fields that might be causing issues
   ...: custom_fields = frappe.get_all("Custom Field", filters={"dt": "Fees and Deposits"}, fields=["name", "fieldname",
   ...:  "fieldtype"])
   ...: for cf in custom_fields:
   ...:     print(f"Custom Field: {cf.name} - {cf.fieldname} ({cf.fieldtype})")
   ...:
   ...: # Try to manually sync the DocType
   ...: frappe.reload_doctype("Fees and Deposits", force=True)
   ...: frappe.db.commit()
Custom Field: Fees and Deposits-employee_advances - employee_advances (Small Text)
Custom Field: Fees and Deposits-project_claim - project_claim (Link)
Custom Field: Fees and Deposits-employee_advance - employee_advance (Link)
Custom Field: Fees and Deposits-employee_advance_created - employee_advance_created (Check)

^C
---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
Cell In[1], line 7
      4     print(f"Custom Field: {cf.name} - {cf.fieldname} ({cf.fieldtype})")
      6 # Try to manually sync the DocType
----> 7 frappe.reload_doctype("Fees and Deposits", force=True)
      8 frappe.db.commit()

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1420, in reload_doctype(doctype, force, reset_permissions)
   1418 def reload_doctype(doctype, force=False, reset_permissions=False):
   1419         """Reload DocType from model (`[module]/[doctype]/[name]/[name].json`) files."""
-> 1420         reload_doc(
   1421                 scrub(db.get_value("DocType", doctype, "module")),
   1422                 "doctype",
   1423                 scrub(doctype),
   1424                 force=force,
   1425                 reset_permissions=reset_permissions,
   1426         )

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1446, in reload_doc(module, dt, dn, force, reset_permissions)
   1436 """Reload Document from model (`[module]/[doctype]/[name]/[name].json`) files.
   1437
   1438 :param module: Module name.
   (...)
   1441 :param force: Reload even if `modified` timestamp matches.
   1442 """
   1444 import frappe.modules
-> 1446 return frappe.modules.reload_doc(module, dt, dn, force=force, reset_permissions=reset_permissions)

File ~/frappe-bench/apps/frappe/frappe/modules/utils.py:216, in reload_doc(module, dt, dn, force, reset_permissions)
    213 """Reload Document from model (`[module]/<doctype>/[name]/[name].json`) files"""
    214 from frappe.modules.import_file import import_files
--> 216 return import_files(module, dt, dn, force=force, reset_permissions=reset_permissions)

File ~/frappe-bench/apps/frappe/frappe/modules/import_file.py:57, in import_files(module, dt, dn, force, pre_process, reset_permissions)
     45         return [
     46                 import_file(
     47                         m[0],
   (...)
     54                 for m in module
     55         ]
     56 else:
---> 57         return import_file(
     58                 module, dt, dn, force=force, pre_process=pre_process, reset_permissions=reset_permissions
     59         )

File ~/frappe-bench/apps/frappe/frappe/modules/import_file.py:65, in import_file(module, dt, dn, force, pre_process, reset_permissions)
     63 """Sync a file from txt if modifed, return false if not updated"""
     64 path = get_file_path(module, dt, dn)
---> 65 return import_file_by_path(path, force, pre_process=pre_process, reset_permissions=reset_permissions)

File ~/frappe-bench/apps/frappe/frappe/modules/import_file.py:146, in import_file_by_path(path, force, data_import, pre_process, ignore_version, reset_permissions)
    143         if is_db_timestamp_latest and doc["doctype"] != "DocType":
    144                 continue
--> 146 import_doc(
    147         docdict=doc,
    148         data_import=data_import,
    149         pre_process=pre_process,
    150         ignore_version=ignore_version,
    151         reset_permissions=reset_permissions,
    152         path=path,
    153 )
    155 if doc["doctype"] == "DocType":
    156         doctype_table = DocType("DocType")

File ~/frappe-bench/apps/frappe/frappe/modules/import_file.py:239, in import_doc(docdict, data_import, pre_process, ignore_version, reset_permissions, path)
    236         doc.flags.ignore_permissions = True
    237         doc.flags.ignore_mandatory = True
--> 239 doc.insert()
    241 frappe.flags.in_import = False
    243 return doc

File ~/frappe-bench/apps/frappe/frappe/model/document.py:315, in Document.insert(self, ignore_permissions, ignore_links, ignore_if_duplicate, ignore_mandatory, set_name, set_child_names)
    312         self.copy_attachments_from_amended_from()
    314 relink_mismatched_files(self)
--> 315 self.run_post_save_methods()
    316 self.flags.in_insert = False
    318 # delete __islocal

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1128, in Document.run_post_save_methods(self)
   1120 """Run standard methods after `INSERT` or `UPDATE`. Standard Methods are:
   1121
   1122 - `on_update` for **Save**.
   1123 - `on_update`, `on_submit` for **Submit**.
   1124 - `on_cancel` for **Cancel**
   1125 - `update_after_submit` for **Update after Submit**"""
   1127 if self._action == "save":
-> 1128         self.run_method("on_update")
   1129 elif self._action == "submit":
   1130         self.run_method("on_update")

File ~/frappe-bench/apps/frappe/frappe/model/document.py:962, in Document.run_method(self, method, *args, **kwargs)
    959                 return method_object(*args, **kwargs)
    961 fn.__name__ = str(method)
--> 962 out = Document.hook(fn)(self, *args, **kwargs)
    964 self.run_notifications(method)
    965 run_webhooks(self, method)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1322, in Document.hook.<locals>.composer(self, *args, **kwargs)
   1319         hooks.append(frappe.get_attr(handler))
   1321 composed = compose(f, *hooks)
-> 1322 return composed(self, method, *args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/document.py:1304, in Document.hook.<locals>.compose.<locals>.runner(self, method, *args, **kwargs)
   1303 def runner(self, method, *args, **kwargs):
-> 1304         add_to_return_value(self, fn(self, *args, **kwargs))
   1305         for f in hooks:
   1306                 add_to_return_value(self, f(self, method, *args, **kwargs))

File ~/frappe-bench/apps/frappe/frappe/model/document.py:959, in Document.run_method.<locals>.fn(self, *args, **kwargs)
    956 # Cannot have a field with same name as method
    957 # If method found in __dict__, expect it to be callable
    958 if method in self.__dict__ or callable(method_object):
--> 959         return method_object(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/core/doctype/doctype/doctype.py:508, in DocType.on_update(self)
    505         self.setup_autoincrement_and_sequence()
    507 try:
--> 508         frappe.db.updatedb(self.name, Meta(self))
    509 except Exception as e:
    510         print(f"\n\nThere was an issue while migrating the DocType: {self.name}\n")

File ~/frappe-bench/apps/frappe/frappe/database/mariadb/database.py:443, in MariaDBDatabase.updatedb(self, doctype, meta)
    440 db_table = MariaDBTable(doctype, meta)
    441 db_table.validate()
--> 443 db_table.sync()
    444 self.commit()

File ~/frappe-bench/apps/frappe/frappe/database/schema.py:44, in DBTable.sync(self)
     42 else:
     43         frappe.cache.hdel("table_columns", self.table_name)
---> 44         self.alter()

File ~/frappe-bench/apps/frappe/frappe/database/mariadb/schema.py:111, in MariaDBTable.alter(self)
    109                         query_body = ", ".join(query_parts)
    110                         query = f"ALTER TABLE `{self.table_name}` {query_body}"
--> 111                         frappe.db.sql_ddl(query)
    113 except Exception as e:
    114         if query := locals().get("query"):  # this weirdness is to avoid potentially unbounded vars

File ~/frappe-bench/apps/frappe/frappe/database/database.py:410, in Database.sql_ddl(self, query, debug)
    407 """Commit and execute a query. DDL (Data Definition Language) queries that alter schema
    408 autocommit in MariaDB."""
    409 self.commit()
--> 410 self.sql(query, debug=debug)

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:563, in Connection.query(self, sql, unbuffered)
    561     sql = sql.encode(self.encoding, "surrogateescape")
    562 self._execute_command(COMMAND.COM_QUERY, sql)
--> 563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:825, in Connection._read_query_result(self,unbuffered)
    823 else:
    824     result = MySQLResult(self)
--> 825     result.read()
    826 self._result = result
    827 if result.server_status is not None:

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:1199, in MySQLResult.read(self)
   1197 def read(self):
   1198     try:
-> 1199         first_packet = self.connection._read_packet()
   1201         if first_packet.is_ok_packet():
   1202             self._read_ok_packet(first_packet)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:744, in Connection._read_packet(self, packet_type)
    742 buff = bytearray()
    743 while True:
--> 744     packet_header = self._read_bytes(4)
    745     # if DEBUG: dump_packet(packet_header)
    747     btrl, btrh, packet_number = struct.unpack("<HBB", packet_header)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:782, in Connection._read_bytes(self, num_bytes)
    780 while True:
    781     try:
--> 782         data = self._rfile.read(num_bytes)
    783         break
    784     except OSError as e:

File /usr/lib/python3.10/socket.py:705, in SocketIO.readinto(self, b)
    703 while True:
    704     try:
--> 705         return self._sock.recv_into(b)
    706     except timeout:
    707         self._timeout_occurred = True

KeyboardInterrupt:

In [2]:


[13]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Check if there are any pending patches
   ...: patches = frappe.get_all("Patch Log", filters={"skipped": 0}, fields=["patch"])
   ...: print(f"Total patches: {len(patches)}")
   ...:
   ...: # Check the last few patches
   ...: recent_patches = frappe.get_all("Patch Log", order_by="creation desc", limit=10, fields=["patch", "skipped"])
   ...: for p in recent_patches:
   ...:     print(f"Patch: {p.patch}, Skipped: {p.skipped}")
   ...: exit
Total patches: 635
Patch: erpnext.patches.v15_0.link_purchase_item_to_asset_doc, Skipped: 0
Patch: erpnext.patches.v15_0.set_standard_stock_entry_type, Skipped: 0
Patch: erpnext.patches.v15_0.add_disassembly_order_stock_entry_type #1, Skipped: 0
Patch: erpnext.patches.v15_0.drop_index_posting_datetime_from_sle, Skipped: 0
Patch: erpnext.patches.v14_0.update_reports_with_range, Skipped: 0
Patch: erpnext.patches.v15_0.update_invoice_remarks, Skipped: 0
Patch: erpnext.patches.v15_0.do_not_use_batchwise_valuation, Skipped: 0
Patch: erpnext.patches.v15_0.update_total_number_of_booked_depreciations, Skipped: 0
Patch: erpnext.patches.v15_0.update_asset_repair_field_in_stock_entry, Skipped: 0
Patch: erpnext.patches.v15_0.update_warehouse_field_in_asset_repair_consumed_item_doctype, Skipped: 0
Out[1]: <IPython.core.autocall.ExitAutocall at 0x7f89a5fb3e50>

In [2]: bench --site smartvision.com console
  Cell In[2], line 1
    bench --site smartvision.com console
                 ^
SyntaxError: invalid syntax


In [3]: # Try to manually trigger just the schema sync without customizations
   ...: import frappe
   ...: from frappe.model.sync import sync_for
   ...:
   ...: # Sync just the Fees and Deposits doctype without customizations
   ...: try:
   ...:     sync_for("svg_mobile_app", force=True, reset_permissions=False)
   ...:     print("Schema sync completed")
   ...: except Exception as e:
   ...:     print(f"Error: {e}")
   ...:
   ...: frappe.db.commit()
   ...: exit

^C^Z
[14]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com set-maintenance-mode on
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
bench --site smartvision.com set-maintenance-mode off
^Z
[15]+  Stopped                 bench --site smartvision.com migrate
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com set-maintenance-mode off
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 519
Server version: 10.6.18-MariaDB-0ubuntu0.22.04.1 Ubuntu 22.04

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [_86b0b85ccf42b383]> SHOW ENGINE INNODB STATUS\G
ERROR 1227 (42000): Access denied; you need (at least one of) the PROCESS privilege(s) for this operation
MariaDB [_86b0b85ccf42b383]> SHOW PROCESSLIST;
+-----+-------------------+-----------------+-------------------+---------+------+---------------------------------+--->
| Id  | User              | Host            | db                | Command | Time | State                           | In>
+-----+-------------------+-----------------+-------------------+---------+------+---------------------------------+--->
|  71 | _86b0b85ccf42b383 | localhost:49960 | _86b0b85ccf42b383 | Sleep   | 1080 |                                 | NU>
| 228 | _86b0b85ccf42b383 | localhost:50284 | _86b0b85ccf42b383 | Sleep   |  806 |                                 | NU>
| 375 | _86b0b85ccf42b383 | localhost:50590 | _86b0b85ccf42b383 | Sleep   |  387 |                                 | NU>
| 507 | _86b0b85ccf42b383 | localhost:50868 | _86b0b85ccf42b383 | Query   |  140 | Waiting for table metadata lock | AL>
| 519 | _86b0b85ccf42b383 | localhost:50892 | _86b0b85ccf42b383 | Query   |    0 | starting                        | SH>
+-----+-------------------+-----------------+-------------------+---------+------+---------------------------------+--->

[16]+  Stopped                 bench --site smartvision.com mariadb
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com set-maintenance-mode off
frappe@vmi2187306:~/frappe-bench$ sudo systemctl restart mariadb
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate
Migrating smartvision.com

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/synchronization.py", line 40, in filelock
    with _StrongFileLock(lock_path, timeout=timeout):
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/filelock/_api.py", line 314, in __enter__
    self.acquire()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/filelock/_api.py", line 279, in acquire
    raise Timeout(lock_filename)  # noqa: TRY301
filelock._error.Timeout: The file lock '/home/frappe/frappe-bench/sites/smartvision.com/locks/bench_migrate.lock' couldnot be acquired.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 114, in <module>
    main()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/bench_helper.py", line 20, in main
    click.Group(commands=commands)(prog_name="bench")
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1157, in __call__
    return self.main(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1078, in main
    rv = self.invoke(ctx)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1688, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 1434, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/core.py", line 783, in invoke
    return __callback(*args, **kwargs)
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/click/decorators.py", line 33, in new_func
    return f(get_current_context(), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/__init__.py", line 29, in _func
    ret = f(frappe._dict(ctx.obj), *args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/commands/site.py", line 660, in migrate
    SiteMigration(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/migrate.py", line 182, in run
    with filelock("bench_migrate", timeout=1):
  File "/usr/lib/python3.10/contextlib.py", line 135, in __enter__
    return next(self.gen)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/synchronization.py", line 45, in filelock
    raise LockTimeoutError(
frappe.utils.file_lock.LockTimeoutError: Failed to aquire lock: bench_migrate. Lock may be held by another process.<br>You can manually remove the lock if you think it's safe: /home/frappe/frappe-bench/sites/smartvision.com/locks/bench_migrate.lock
frappe@vmi2187306:~/frappe-bench$ rm /home/frappe/frappe-bench/sites/smartvision.com/locks/bench_migrate.lock
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
Updating customizations for Projects Collection
Updating customizations for Payment Entry Deduction
Updating customizations for Shift Type
Updating customizations for Item
Updating customizations for Bank
Updating customizations for Payment Entry
Updating customizations for Item Barcode
Updating customizations for Employee
Updating customizations for Employee Advance
Updating customizations for Item Group
Updating customizations for Project Contractors
Updating customizations for Sketch
Queued rebuilding of search index for smartvision.com

frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Check recent error logs
   ...: import frappe
   ...: logs = frappe.get_all("Error Log", order_by="creation desc", limit=5, fields=["name", "error", "creation"])
   ...: for log in logs:
   ...:     print(f"Error: {log.name} - {log.creation}")
   ...:     error_doc = frappe.get_doc("Error Log", log.name)
   ...:     print(f"Details: {error_doc.error[:500]}...")
   ...:     print("-" * 50)
   ...:
Error: kdgggvdjd7 - 2025-06-12 12:33:53.639226
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder bl...
--------------------------------------------------
Error: kdctb3j4c9 - 2025-06-12 12:33:42.166166
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder bl...
--------------------------------------------------
Error: kcu3275579 - 2025-06-12 12:32:54.713793
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder bl...
--------------------------------------------------
Error: jkit1cesu1 - 2025-06-12 11:51:21.390434
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 99, in application
    init_request(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.reportview.get' [POST]>
      response = None
      rollback = True
      e = SessionStopped('Session Stopped')
  File "apps/frappe/frappe/app.py", line 183, in init_request
    raise frappe.SessionStopped("Session Stopped")
      request = <Request 'https://erp.smartvgroup.com/api/meth...
--------------------------------------------------
Error: jkit9scvvf - 2025-06-12 11:51:21.385277
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 99, in application
    init_request(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.reportview.get' [POST]>
      response = None
      rollback = True
      e = SessionStopped('Session Stopped')
  File "apps/frappe/frappe/app.py", line 183, in init_request
    raise frappe.SessionStopped("Session Stopped")
      request = <Request 'https://erp.smartvgroup.com/api/meth...
--------------------------------------------------

In [2]: # Test the advance account function
   ...: from svg_mobile_app.svg_mobile_app.doctype.project_contractors.project_contractors import get_default_advance_ac
   ...: count
   ...:
   ...: company = "Orbit"  # Your current company
   ...: advance_account = get_default_advance_account(company)
   ...: print(f"Default advance account for {company}: {advance_account}")
   ...:
   ...: # Check if the account exists
   ...: if advance_account:
   ...:     account_exists = frappe.db.exists("Account", advance_account)
   ...:     print(f"Account exists: {account_exists}")
   ...: else:
   ...:     print("No advance account found - this is likely the issue")
   ...:
Default advance account for Orbit: Employee Advances - OR
Account exists: Employee Advances - OR

In [3]: # Check what payable accounts exist for your company
   ...: accounts = frappe.get_all(
   ...:     "Account",
   ...:     filters={
   ...:         "company": "Orbit",
   ...:         "account_type": "Payable",
   ...:         "is_group": 0
   ...:     },
   ...:     fields=["name", "account_name"]
   ...: )
   ...: print("Available Payable accounts:")
   ...: for acc in accounts:
   ...:     print(f"- {acc.name}: {acc.account_name}")
   ...:
Available Payable accounts:
- Supplier / Vendors - OR: Supplier / Vendors

In [4]: # Check for employee advance related errors
   ...: logs = frappe.get_all("Error Log",
   ...:     filters={"error": ["like", "%employee%advance%"]},
   ...:     order_by="creation desc",
   ...:     limit=10,
   ...:     fields=["name", "error", "creation"])
   ...:
   ...: if logs:
   ...:     for log in logs:
   ...:         print(f"Employee Advance Error: {log.name} - {log.creation}")
   ...:         error_doc = frappe.get_doc("Error Log", log.name)
   ...:         print(f"Details: {error_doc.error[:1000]}...")
   ...:         print("-" * 50)
   ...: else:
   ...:     print("No employee advance related errors found")
   ...:
Employee Advance Error: jhcev912t7 - 2025-06-12 11:45:53.402875
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f29e2c56a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", ...
--------------------------------------------------
Employee Advance Error: jhcdm212r6 - 2025-06-12 11:45:53.396511
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f7563752a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", ...
--------------------------------------------------
Employee Advance Error: jhcdh6p7em - 2025-06-12 11:45:53.379085
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f7563752a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", ...
--------------------------------------------------

   ...:         advance.purpose = "Test advance"
   ...:         advance.advance_amount = 100
   ...:         advance.posting_date = frappe.utils.today()
   ...:         advance.company = "Orbit"
   ...:         advance.advance_account = "Employee Advances - OR"
   ...:
   ...:         # Set currency if field exists
   ...:         if frappe.get_meta("Employee Advance").has_field("currency"):
   ...:             advance.currency = "AED"
   ...:
   ...:         # Set exchange rate if field exists
   ...:         if frappe.get_meta("Employee Advance").has_field("exchange_rate"):
   ...:             advance.exchange_rate = 1.0
   ...:
   ...:         print("Attempting to save employee advance...")
   ...:         advance.insert()
   ...:         print(f"Success! Created Employee Advance: {advance.name}")
   ...:
   ...:         # Clean up - delete the test advance
   ...:         frappe.delete_doc("Employee Advance", advance.name)
   ...:         print("Test advance deleted successfully")
   ...:
   ...:     else:
   ...:         print("No active employees found")
   ...:
   ...: except Exception as e:
   ...:     print(f"Error creating employee advance: {str(e)}")
   ...:     import traceback
   ...:     traceback.print_exc()
   ...:
Testing with employee: SVG-092
Attempting to save employee advance...
Error creating employee advance: [Employee Advance, HR-EAD-2025-00005]: advance_account
Traceback (most recent call last):
  File "<ipython-input-5-eaf7022962f2>", line 26, in <module>
    advance.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 292, in insert
    self._validate()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 574, in _validate
    self._validate_mandatory()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 911, in _validate_mandatory
    raise frappe.MandatoryError(
frappe.exceptions.MandatoryError: [Employee Advance, HR-EAD-2025-00005]: advance_account

In [6]: # Check if there are any validation issues with the Employee Advance doctype
   ...: meta = frappe.get_meta("Employee Advance")
   ...: print("Employee Advance required fields:")
   ...: for field in meta.fields:
   ...:     if field.reqd:
   ...:         print(f"- {field.fieldname} ({field.fieldtype}): {field.label}")
   ...:
Employee Advance required fields:
- employee (Link): Employee
- posting_date (Date): Posting Date
- company (Link): Company
- currency (Link): Currency
- exchange_rate (Float): Exchange Rate
- purpose (Small Text): Purpose
- advance_amount (Currency): Advance Amount
- advance_account (Link): Advance Account

In [7]: # Check the account details
   ...: account_details = frappe.get_doc("Account", "Employee Advances - OR")
   ...: print(f"Account Name: {account_details.name}")
   ...: print(f"Account Type: {account_details.account_type}")
   ...: print(f"Company: {account_details.company}")
   ...: print(f"Is Group: {account_details.is_group}")
   ...: print(f"Disabled: {account_details.disabled}")
Account Name: Employee Advances - OR
Account Type:
Company: Orbit
Is Group: 0
Disabled: 0

In [8]: # Check what account type is expected for Employee Advance
   ...: advance_account_field = frappe.get_meta("Employee Advance").get_field("advance_account")
   ...: print(f"Advance Account field options: {advance_account_field.options}")
   ...: print(f"Advance Account field description: {advance_account_field.description}")
Advance Account field options: Account
Advance Account field description: None

In [9]: # Try to find the correct account type for employee advances
   ...: # Check if there's a specific account type filter
   ...: from frappe.model.utils import get_link_filters
   ...: filters = get_link_filters("Employee Advance", "advance_account")
   ...: print(f"Link filters for advance_account: {filters}")
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
Cell In[9], line 3
      1 # Try to find the correct account type for employee advances
      2 # Check if there's a specific account type filter
----> 3 from frappe.model.utils import get_link_filters
      4 filters = get_link_filters("Employee Advance", "advance_account")
      5 print(f"Link filters for advance_account: {filters}")

ImportError: cannot import name 'get_link_filters' from 'frappe.model.utils' (/home/frappe/frappe-bench/apps/frappe/frappe/model/utils/__init__.py)

    ...:     for acc in valid_accounts:
    ...:         print(f"- {acc.name} ({acc.account_type}): {acc.account_name}")
    ...:
    ...:     # Try with a different account type
    ...:     payable_account = "Supplier / Vendors - OR"
    ...:
    ...:     employee = "SVG-092"
    ...:     advance = frappe.new_doc("Employee Advance")
    ...:     advance.employee = employee
    ...:     advance.purpose = "Test advance"
    ...:     advance.advance_amount = 100
    ...:     advance.posting_date = frappe.utils.today()
    ...:     advance.company = "Orbit"
    ...:     advance.currency = "AED"
    ...:     advance.exchange_rate = 1.0
    ...:     advance.advance_account = payable_account
    ...:
    ...:     print(f"Trying with account: {payable_account}")
    ...:     advance.insert()
    ...:     print(f"Success! Created Employee Advance: {advance.name}")
    ...:
    ...:     # Clean up
    ...:     frappe.delete_doc("Employee Advance", advance.name)
    ...:     print("Test advance deleted successfully")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error: {str(e)}")
    ...:     import traceback
    ...:     traceback.print_exc()
    ...:
All available accounts for Orbit:
- Employee Advances - OR (): Employee Advances
- Stock In Hand - OR (Stock): Stock In Hand
- Capital Equipments - OR (Fixed Asset): Capital Equipments
- Accumulated Depreciation - OR (Accumulated Depreciation): Accumulated Depreciation
- CWIP Account - OR (Capital Work in Progress): CWIP Account
- Temporary Opening - OR (Temporary): Temporary Opening
- Cost of Goods Sold - OR (Cost of Goods Sold): Cost of Goods Sold
- Expenses Included In Asset Valuation - OR (Expenses Included In Asset Valuation): Expenses Included In Asset Valuation
- Expenses Included In Valuation - OR (Expenses Included In Valuation): Expenses Included In Valuation
- Stock Adjustment - OR (Stock Adjustment): Stock Adjustment
- Depreciation - OR (Depreciation): Depreciation
- Round Off - OR (Round Off): Round Off
- Write Off - OR (): Write Off
- Exchange Gain/Loss - OR (): Exchange Gain/Loss
- Gain/Loss on Asset Disposal - OR (): Gain/Loss on Asset Disposal
- Payroll Payable - OR (): Payroll Payable
- Stock Received But Not Billed - OR (Stock Received But Not Billed): Stock Received But Not Billed
- Asset Received But Not Billed - OR (Asset Received But Not Billed): Asset Received But Not Billed
- Secured Loans - OR (): Secured Loans
- Unsecured Loans - OR (): Unsecured Loans
- Bank Overdraft Account - OR (): Bank Overdraft Account
- VAT 5% - OR (Tax): VAT 5%
- VAT Zero - OR (Tax): VAT Zero
- VAT Exempted - OR (Tax): VAT Exempted
- Excise 50% - OR (Tax): Excise 50%
- Excise 100% - OR (Tax): Excise 100%
- ADCB Account (AED) - OR (Bank): ADCB Account (AED)
- Treasury (AED) - OR (Cash): Treasury (AED)
- Treasury (USD) - OR (Cash): Treasury (USD)
- Customers / Clients - OR (Receivable): Customers / Clients
- Supplier / Vendors - OR (Payable): Supplier / Vendors
- Reconciled Taxs - OR (): Reconciled Taxs
- Said Treasury (AED) - OR (Cash): Said Treasury (AED)
- Elmehiry Treasury (AED) - OR (Cash): Elmehiry Treasury (AED)
- رسوم امانات - OR (): رسوم امانات
- 110101 - Buildings - Cost - OR (): Buildings - Cost
- 110102 - Accumulated Depreciation on Buildings - OR (): Accumulated Depreciation on Buildings
- 110201 - Computer Hardware - Cost - OR (): Computer Hardware - Cost
- 110202 - Accumulated Depreciation on Computer Hardware - OR (): Accumulated Depreciation on Computer Hardware
- 110203 - Computer Software - Cost - OR (): Computer Software - Cost
- 110204 - Accumulated Depreciation on Computer Software - OR (): Accumulated Depreciation on Computer Software
- 110301 - Furniture and Fixture - Cost - OR (): Furniture and Fixture - Cost
- 110302 - Accumulated Depreciation on Furniture and Fixture - OR (): Accumulated Depreciation on Furniture and Fixture
- 110401 - Motor Vehicles - Cost - OR (): Motor Vehicles - Cost
- 110402 - Accumulated Impairment Motor Vehicles - OR (): Accumulated Impairment Motor Vehicles
- 110501 - Office Equipment - Cost - OR (): Office Equipment - Cost
- 110502 - Accumulated Office Equipment - Cost - OR (): Accumulated Office Equipment - Cost
- 130101 - Prepaid Expense - Insurance - OR (): Prepaid Expense - Insurance
- 130102 - Prepaid Expense - Rent - OR (): Prepaid Expense - Rent
- 130103 - Prepaid Expense - Salaries and Wages - OR (): Prepaid Expense - Salaries and Wages
- 130104 - Prepaid Expense - Others - OR (): Prepaid Expense - Others
- 130105 - Accrued Revenue - OR (): Accrued Revenue
- 130106 - Accrued Interest Receivable - OR (): Accrued Interest Receivable
- 141001 - Letter of Credit - OR (): Letter of Credit
- 141002 - Refundable Deposits Others - OR (): Refundable Deposits Others
- 220101 - Provision For Gratuity - OR (): Provision For Gratuity
- 230101 - Accounts Payable - Supplier - OR (): Accounts Payable - Supplier
- 230102 - Receipts Accrual Account - OR (): Receipts Accrual Account
- 240101 - Accrued Salaries and Wages - OR (): Accrued Salaries and Wages
- 240102 - Accrued Utilities Expenses - OR (): Accrued Utilities Expenses
- 240103 - Accrued 20% Retirement on Salaries - OR (): Accrued 20% Retirement on Salaries
- 240104 - Accrued Other Expenses - OR (): Accrued Other Expenses
- 240105 - End of service provision - OR (): End of service provision
- 240201 - Deposits Payable - OR (): Deposits Payable
- 240202 - Output VAT - OR (): Output VAT
- 240203 - Retention Payable - OR (): Retention Payable
- 240204 - Advances received from Customers - OR (): Advances received from Customers
- 310101 - OWNER - OR (): OWNER
- 320101 - Retained Earnings - OR (): Retained Earnings
- 510101 - Basic Salary - OR (): Basic Salary
- 510102 - Casual - Part Time Salary - OR (): Casual - Part Time Salary
- 510103 - Over Time Salaries - OR (): Over Time Salaries
- 510201 - Cost of Living Allowance - OR (): Cost of Living Allowance
- 510202 - Housing Allowance - OR (): Housing Allowance
- 510203 - Ticket Allowance - OR (): Ticket Allowance
- 510204 - Children Allowance - OR (): Children Allowance
- 510205 - Social Allowance - OR (): Social Allowance
- 510206 - Electricity and Water Allowance - OR (): Electricity and Water Allowance
- 510207 - Transport Allowance - OR (): Transport Allowance
- 510208 - Furniture Allowance - OR (): Furniture Allowance
- 510209 - Management Allowance - OR (): Management Allowance
- 510210 - Other Allowances - OR (): Other Allowances
- 510301 - Medical Insurance - OR (): Medical Insurance
- 510302 - Schooling Fees - OR (): Schooling Fees
- 510303 - Leave Salary - OR (): Leave Salary
- 510304 - Rewards and Bonuses - OR (): Rewards and Bonuses
- 510305 - End of Service Indemnity - OR (): End of Service Indemnity
- 510306 - Contribution To Pension Fund - OR (): Contribution To Pension Fund
- 510401 - Outsourced Staff Cost - OR (): Outsourced Staff Cost
- 520101 - Airfare - OR (): Airfare
- 520102 - Accommodation - OR (): Accommodation
- 520105 - Conference Registration Fees - OR (): Conference Registration Fees
- 520201 - Staff Training and Professional Development - OR (): Staff Training and Professional Development
- 520301 - Catering - OR (): Catering
- 520302 - Office Hospitality Supplies - OR (): Office Hospitality Supplies
- 520303 - Office Hospitality Services - OR (): Office Hospitality Services
- 520401 - Printing Expenses - OR (): Printing Expenses
- 520402 - Stationery and office Supplies - OR (): Stationery and office Supplies
- 520403 - Computer Supplies and Accessories - OR (): Computer Supplies and Accessories
- 520404 - Newspapers And Magazines - OR (): Newspapers And Magazines
- 520501 - Petrol and Oil - OR (): Petrol and Oil
- 520502 - Uniforms and other wears - OR (): Uniforms and other wears
- 520503 - Other Consumables - OR (): Other Consumables
- 520601 - Phone - OR (): Phone
- 520602 - Internet - OR (): Internet
- 520603 - Call Centre - OR (): Call Centre
- 520604 - Mail, Postage, Freight, Customs Services - OR (): Mail, Postage, Freight, Customs Services
- 520701 - Software License Renewal - OR (): Software License Renewal
- 520801 - Consultancy Fees - OR (): Consultancy Fees
- 520802 - Audit Fees - OR (): Audit Fees
- 520803 - Affiliation and Accreditation Fees - OR (): Affiliation and Accreditation Fees
- 520804 - Honorarium - OR (): Honorarium
- 520805 - Publication Fees - OR (): Publication Fees
- 520806 - Other Professional Services - OR (): Other Professional Services
- 520901 - Building Rental - OR (): Building Rental
- 520902 - Bus Rental - OR (): Bus Rental
- 520903 - Other Rentals - OR (): Other Rentals
- 520904 - Other Rentals - OR (): Other Rentals
- 521001 - Cleaning and Waste Management - OR (): Cleaning and Waste Management
- 521002 - Cleaning and Waste Material - OR (): Cleaning and Waste Material
- 521101 - Maintenance - Equipment - OR (): Maintenance - Equipment
- 521102 - Maintenance - Air Conditioning - OR (): Maintenance - Air Conditioning
- 521103 - Maintenance - Building- Office - OR (): Maintenance - Building- Office
- 521104 - Maintenance - Furniture - OR (): Maintenance - Furniture
- 521105 - Maintenance - Vehicles - OR (): Maintenance - Vehicles
- 521106 - Maintenance - Other - OR (): Maintenance - Other
- 521201 - Electricity - OR (): Electricity
- 521202 - Water - OR (): Water
- 521203 - Gas and Sewage - OR (): Gas and Sewage
- 521204 - Municipality Charges - OR (): Municipality Charges
- 521301 - Bank Charges - OR (): Bank Charges
- 521302 - Finance Expenses - Loan - OR (): Finance Expenses - Loan
- 521303 - Bank Commission on Credit Card - OR (): Bank Commission on Credit Card
- 521304 - Exchange Rate Difference - OR (): Exchange Rate Difference
- 521305 - Interest on Lease Liability - OR (): Interest on Lease Liability
- 521401 - Advertising Expenses - OR (): Advertising Expenses
- 521402 - Staff Visa and Immigration Expenses - OR (): Staff Visa and Immigration Expenses
- 521403 - Vehicle Insurance - OR (): Vehicle Insurance
- 521404 - Other Insurance - OR (): Other Insurance
- 521405 - Security Services Expenses - OR (): Security Services Expenses
- 521406 - Decoration Expenses - OR (): Decoration Expenses
- 521407 - Membership Expenses - OR (): Membership Expenses
- 521408 - Donations Expense - OR (): Donations Expense
- 521409 - Miscellaneous Expenses - OR (): Miscellaneous Expenses
- 521410 - Gift and Promotional Items - OR (): Gift and Promotional Items
- 521411 - Exhibition Registration Fees - OR (): Exhibition Registration Fees
- 521501 - Bad Debts (Write off Accounts) - OR (): Bad Debts (Write off Accounts)
- 521502 - Expense on Provision for Doubtful Debts - OR (): Expense on Provision for Doubtful Debts
- 521601 - PWD Fee - OR (): PWD Fee
- 521701 - Depreciation on Buildings - OR (): Depreciation on Buildings
- 521702 - Depreciation on Computer Hardware - Cost - OR (): Depreciation on Computer Hardware - Cost
- 521703 - Depreciation on Computer Software - Cost - OR (): Depreciation on Computer Software - Cost
- 521704 - Depreciation on Furniture and Fixture - Cost - OR (): Depreciation on Furniture and Fixture - Cost
- 521705 - Depreciation on Motor Vehicles - Cost - OR (): Depreciation on Motor Vehicles - Cost
- 5212020 - Municipality - OR (): Municipality
- 5212030 - Shakh Zayed Housing Fee - OR (): Shakh Zayed Housing Fee
- 5212040 - Other Gov Fee - OR (): Other Gov Fee
- 121101 - Counter Main Cash - OR (): Counter Main Cash
- 121102 - Advance to Employees - Petty Cash - OR (): Advance to Employees - Petty Cash
- 121103 - Advance to Employees - Petty Cash - OR (): Advance to Employees - Petty Cash
- 121201 - ADCB Bank - OR (): ADCB Bank
- 121202 - ADIB Bank - OR (): ADIB Bank
- 122100 - Main Contractors - OR (): Main Contractors
- 122200 - Sub Contractors - OR (): Sub Contractors
- 123001 - Post Dated Cheques on Hand - OR (): Post Dated Cheques on Hand
- 123002 - POS Machine Collections - OR (): POS Machine Collections
- 124001 - Input VAT - OR (): Input VAT
- 125101 - Advance to Employees - Loans - OR (): Advance to Employees - Loans
- 125201 - Advances To Suppliers - OR (): Advances To Suppliers
- 126001 - Other Advances - OR (): Other Advances
- 210101 - Loan from SIB - OR (): Loan from SIB
- 250101 - Unearned Additional Contractors Revenue - OR (): Unearned Additional Contractors Revenue
- 250102 - Unearned Additional Supervsion Revenue - OR (): Unearned Additional Supervsion Revenue
- 250103 - Unearned Business Development - OR (): Unearned Business Development
- 250104 - Unearned Digital Marketing - OR (): Unearned Digital Marketing
- 250105 - Unearned Engineers Commission Revenue - OR (): Unearned Engineers Commission Revenue
- 250106 - Unearned Human Resources Follow Up - OR (): Unearned Human Resources Follow Up
- 250107 - Unearned Modifcation Revenue - OR (): Unearned Modifcation Revenue
- 250108 - Unearned Revenue Design Fees - OR (): Unearned Revenue Design Fees
- 250109 - Unearned Supervision Revenue - OR (): Unearned Supervision Revenue
- 410001 - Additional Contractors Revenue Income - OR (): Additional Contractors Revenue Income
- 410002 - Additional Supervision Revenue Income - OR (): Additional Supervision Revenue Income
- 410003 - Business Development Fees - OR (Income Account): Business Development Fees
- 410004 - Design Revenue Income - OR (): Design Revenue Income
- 410005 - Development Fees Income - OR (): Development Fees Income
- 410006 - Digital Marketing Income - OR (): Digital Marketing Income
- 410007 - Engineering Comission Income - OR (): Engineering Comission Income
- 410008 - Human Resources Follow Up Fees - OR (): Human Resources Follow Up Fees
- 410009 - Modifcation Fees Income - OR (): Modifcation Fees Income
- 250112 - Unearned Design Update Revenue - OR (): Unearned Design Update Revenue
- 250110 - Unearned Tender Fees Revenue - OR (Liability): Unearned Tender Fees Revenue
- 250111 - Unerarned Development Fees - OR (): Unerarned Development Fees
- 410010 - Supervision Revenue Income - OR (): Supervision Revenue Income
- 410011 - Tender Fees Revenue Income - OR (): Tender Fees Revenue Income
- 410012 - Design Update Fees Revenue - OR (Income Account): Design Update Fees Revenue
- 410013 - Test Incomer - OR (Income Account): Test Incomer
- 410014 - Default Income Account - OR (): Default Income Account
- 230103 - Customer Libaility - OR (): Customer Libaility
Trying with account: Supplier / Vendors - OR
Error: [Employee Advance, HR-EAD-2025-00006]: advance_account
Traceback (most recent call last):
  File "<ipython-input-10-fe0537a249a8>", line 33, in <module>
    advance.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 292, in insert
    self._validate()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 574, in _validate
    self._validate_mandatory()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 911, in _validate_mandatory
    raise frappe.MandatoryError(
frappe.exceptions.MandatoryError: [Employee Advance, HR-EAD-2025-00006]: advance_account

    ...: account_doc.account_type = "Payable"
    ...: account_doc.save()
    ...: print("Updated account type to 'Payable'")
    ...:
    ...: # Now test creating an employee advance again
    ...: try:
    ...:     employee = "SVG-092"
    ...:     advance = frappe.new_doc("Employee Advance")
    ...:     advance.employee = employee
    ...:     advance.purpose = "Test advance"
    ...:     advance.advance_amount = 100
    ...:     advance.posting_date = frappe.utils.today()
    ...:     advance.company = "Orbit"
    ...:     advance.currency = "AED"
    ...:     advance.exchange_rate = 1.0
    ...:     advance.advance_account = "Employee Advances - OR"
    ...:
    ...:     print("Attempting to save employee advance with fixed account...")
    ...:     advance.insert()
    ...:     print(f"Success! Created Employee Advance: {advance.name}")
    ...:
    ...:     # Clean up
    ...:     frappe.delete_doc("Employee Advance", advance.name)
    ...:     print("Test advance deleted successfully")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error: {str(e)}")
    ...:     import traceback
    ...:     traceback.print_exc()
    ...:
Current account type: ''
Updated account type to 'Payable'
Attempting to save employee advance with fixed account...
Error: [Employee Advance, HR-EAD-2025-00007]: advance_account
Traceback (most recent call last):
  File "<ipython-input-11-167c871f68ff>", line 24, in <module>
    advance.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 292, in insert
    self._validate()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 574, in _validate
    self._validate_mandatory()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 911, in _validate_mandatory
    raise frappe.MandatoryError(
frappe.exceptions.MandatoryError: [Employee Advance, HR-EAD-2025-00007]: advance_account

    ...: account_doc.account_type = "Payable"
    ...: account_doc.save()
    ...: print("Updated account type to 'Payable'")
    ...:
    ...: # Now test creating an employee advance again
    ...: try:
    ...:     employee = "SVG-092"
    ...:     advance = frappe.new_doc("Employee Advance")
    ...:     advance.employee = employee
    ...:     advance.purpose = "Test advance"
    ...:     advance.advance_amount = 100
    ...:     advance.posting_date = frappe.utils.today()
    ...:     advance.company = "Orbit"
    ...:     advance.currency = "AED"
    ...:     advance.exchange_rate = 1.0
    ...:     advance.advance_account = "Employee Advances - OR"
    ...:
    ...:     print("Attempting to save employee advance with fixed account...")
    ...:     advance.insert()
    ...:     print(f"Success! Created Employee Advance: {advance.name}")
    ...:
    ...:     # Clean up
    ...:     frappe.delete_doc("Employee Advance", advance.name)
    ...:     print("Test advance deleted successfully")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error: {str(e)}")
    ...:     import traceback
    ...:     traceback.print_exc()
    ...:
Current account type: 'Payable'
Updated account type to 'Payable'
Attempting to save employee advance with fixed account...
Error: [Employee Advance, HR-EAD-2025-00008]: advance_account
Traceback (most recent call last):
  File "<ipython-input-12-167c871f68ff>", line 24, in <module>
    advance.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 292, in insert
    self._validate()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 574, in _validate
    self._validate_mandatory()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 911, in _validate_mandatory
    raise frappe.MandatoryError(
frappe.exceptions.MandatoryError: [Employee Advance, HR-EAD-2025-00008]: advance_account

In [13]: # Also commit the changes
    ...: frappe.db.commit()
    ...: print("Changes committed to database")
Changes committed to database

    ...:
    ...: # Check if there are any custom scripts or validations
    ...: print("Checking for custom validations...")
    ...: if hasattr(meta, 'get_validation_script'):
    ...:     print("Custom validation script found")
    ...: else:
    ...:     print("No custom validation script")
    ...:
    ...: # Let's try a different approach - check what the actual validation is expecting
    ...: print("\nLet's debug the validation...")
    ...:
    ...: # Create the advance object and check its state before validation
    ...: advance = frappe.new_doc("Employee Advance")
    ...: advance.employee = "SVG-092"
    ...: advance.purpose = "Test advance"
    ...: advance.advance_amount = 100
    ...: advance.posting_date = frappe.utils.today()
    ...: advance.company = "Orbit"
    ...: advance.currency = "AED"
    ...: advance.exchange_rate = 1.0
    ...: advance.advance_account = "Employee Advances - OR"
    ...:
    ...: print(f"advance_account value: '{advance.advance_account}'")
    ...: print(f"advance_account type: {type(advance.advance_account)}")
    ...:
    ...: # Check if the field is actually being set
    ...: advance_account_field = advance.meta.get_field("advance_account")
    ...: print(f"Field definition: {advance_account_field}")
    ...: print(f"Field options: {advance_account_field.options}")
    ...: print(f"Field mandatory: {advance_account_field.reqd}")
Checking for custom validations...
No custom validation script

Let's debug the validation...
advance_account value: 'Employee Advances - OR'
advance_account type: <class 'str'>
Field definition: DocField(9hvp7mk95t)
Field options: Account
Field mandatory: 1

In [15]: # Let's try to see what happens during validation
    ...: try:
    ...:     # Try just the mandatory validation
    ...:     advance._validate_mandatory()
    ...: except Exception as e:
    ...:     print(f"Mandatory validation error: {e}")
    ...:
    ...:     # Let's check what fields are actually empty
    ...:     for field in advance.meta.fields:
    ...:         if field.reqd:
    ...:             value = advance.get(field.fieldname)
    ...:             print(f"Required field '{field.fieldname}': '{value}' (type: {type(value)})")
    ...:

    ...:     minimal_advance.posting_date = frappe.utils.today()
    ...:     minimal_advance.company = "Orbit"
    ...:     minimal_advance.currency = "AED"
    ...:     minimal_advance.exchange_rate = 1.0
    ...:     minimal_advance.purpose = "Test"
    ...:     minimal_advance.advance_amount = 100
    ...:
    ...:     print("Testing without advance_account first...")
    ...:     minimal_advance._validate_mandatory()
    ...:     print("Validation passed without advance_account - this shouldn't happen if it's truly required")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error without advance_account: {e}")
    ...:
    ...:     # Now add the advance_account
    ...:     minimal_advance.advance_account = "Employee Advances - OR"
    ...:     print(f"Added advance_account: '{minimal_advance.advance_account}'")
    ...:
    ...:     try:
    ...:         minimal_advance._validate_mandatory()
    ...:         print("Validation passed with advance_account")
    ...:
    ...:         # Try full insert
    ...:         minimal_advance.insert()
    ...:         print(f"Success! Created: {minimal_advance.name}")
    ...:         frappe.delete_doc("Employee Advance", minimal_advance.name)
    ...:
    ...:     except Exception as e2:
    ...:         print(f"Error with advance_account: {e2}")
    ...:
Testing without advance_account first...
Error without advance_account: [Employee Advance, None]: advance_account
Added advance_account: 'Employee Advances - OR'
Validation passed with advance_account
Error with advance_account: [Employee Advance, HR-EAD-2025-00009]: advance_account

    ...:     minimal_advance.purpose = "Test"
    ...:     minimal_advance.advance_amount = 100
    ...:     minimal_advance.posting_date = frappe.utils.today()
    ...:     minimal_advance.company = "Orbit"
    ...:     minimal_advance.advance_account = "Employee Advances - OR"
    ...:
    ...:     # Try to save without validation first
    ...:     print("Trying to save without validation...")
    ...:     minimal_advance.save(ignore_permissions=True)
    ...:     print(f"Success! Created: {minimal_advance.name}")
    ...:
    ...:     # Clean up
    ...:     frappe.delete_doc("Employee Advance", minimal_advance.name, ignore_permissions=True)
    ...:
    ...: except Exception as e:
    ...:     print(f"Error even without validation: {e}")
    ...:
    ...:     # Let's check what fields are actually required
    ...:     required_fields = []
    ...:     for field in meta.fields:
    ...:         if field.reqd:
    ...:             required_fields.append(field.fieldname)
    ...:
    ...:     print(f"Required fields: {required_fields}")
    ...:
    ...:     # Check what values we have
    ...:     for field_name in required_fields:
    ...:         value = getattr(minimal_advance, field_name, None)
    ...:         print(f"Field '{field_name}': '{value}' (type: {type(value)})")
    ...:
Checking Employee Advance meta...
Custom scripts: 0
Server scripts: 0
Trying to save without validation...
Error even without validation: Exchange Rate cannot be zero.
Required fields: ['employee', 'posting_date', 'company', 'currency', 'exchange_rate', 'purpose', 'advance_amount', 'advance_account']
Field 'employee': 'SVG-092' (type: <class 'str'>)
Field 'posting_date': '2025-06-12' (type: <class 'str'>)
Field 'company': 'Smart Vision Group' (type: <class 'str'>)
Field 'currency': 'EGP' (type: <class 'str'>)
Field 'exchange_rate': 'None' (type: <class 'NoneType'>)
Field 'purpose': 'Test' (type: <class 'str'>)
Field 'advance_amount': '100' (type: <class 'int'>)
Field 'advance_account': 'None' (type: <class 'NoneType'>)

    ...:
    ...:     # Set currency to AED (Orbit's currency)
    ...:     minimal_advance.currency = "AED"
    ...:
    ...:     # Set exchange rate to 1.0 for AED
    ...:     minimal_advance.exchange_rate = 1.0
    ...:
    ...:     # Set advance account AFTER setting company and currency
    ...:     minimal_advance.advance_account = "Employee Advances - OR"
    ...:
    ...:     print("Field values before save:")
    ...:     print(f"Company: {minimal_advance.company}")
    ...:     print(f"Currency: {minimal_advance.currency}")
    ...:     print(f"Exchange Rate: {minimal_advance.exchange_rate}")
    ...:     print(f"Advance Account: {minimal_advance.advance_account}")
    ...:
    ...:     # Try to save
    ...:     print("Trying to save...")
    ...:     minimal_advance.save(ignore_permissions=True)
    ...:     print(f"Success! Created: {minimal_advance.name}")
    ...:
    ...:     # Clean up
    ...:     frappe.delete_doc("Employee Advance", minimal_advance.name, ignore_permissions=True)
    ...:     print("Test advance deleted successfully")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error: {e}")
    ...:     import traceback
    ...:     traceback.print_exc()
    ...:
Field values before save:
Company: Orbit
Currency: AED
Exchange Rate: 1.0
Advance Account: Employee Advances - OR
Trying to save...
Error: [Employee Advance, HR-EAD-2025-00011]: advance_account
Traceback (most recent call last):
  File "<ipython-input-18-0f13b327e509>", line 29, in <module>
    minimal_advance.save(ignore_permissions=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 292, in insert
    self._validate()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 574, in _validate
    self._validate_mandatory()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 911, in _validate_mandatory
    raise frappe.MandatoryError(
frappe.exceptions.MandatoryError: [Employee Advance, HR-EAD-2025-00011]: advance_account

    ...:
    ...:     # Try setting advance_account using db_set after creation
    ...:     print("Trying to save without advance_account first...")
    ...:
    ...:     # Let's check what the validation error says exactly
    ...:     try:
    ...:         minimal_advance._validate_mandatory()
    ...:     except Exception as e:
    ...:         print(f"Mandatory validation error: {e}")
    ...:
    ...:         # Let's manually set the advance_account in the document's data
    ...:         minimal_advance.__dict__['advance_account'] = "Employee Advances - OR"
    ...:         print(f"Manually set advance_account: {minimal_advance.__dict__.get('advance_account')}")
    ...:
    ...:         # Try validation again
    ...:         try:
    ...:             minimal_advance._validate_mandatory()
    ...:             print("Validation passed after manual setting")
    ...:         except Exception as e2:
    ...:             print(f"Still failing: {e2}")
    ...:
    ...:             # Let's check if the field is being filtered by company
    ...:             accounts = frappe.get_all("Account",
    ...:                 filters={"company": "Orbit", "name": "Employee Advances - OR"},
    ...:                 fields=["name", "company", "account_type"])
    ...:             print(f"Account query result: {accounts}")
    ...:
    ...: except Exception as e:
    ...:     print(f"Error: {e}")
    ...:
Advance Account field details:
  Options: Account
  Depends on: None
  Read only depends on: None
Property setters for advance_account: []
Trying to save without advance_account first...
Mandatory validation error: [Employee Advance, None]: advance_account
Manually set advance_account: Employee Advances - OR
Validation passed after manual setting


[17]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench$ # Check current MariaDB configuration
sudo mysql -e "SHOW VARIABLES LIKE '%timeout%';"
[sudo] password for frappe:
+---------------------------------------+----------+
| Variable_name                         | Value    |
+---------------------------------------+----------+
| connect_timeout                       | 60       |
| deadlock_timeout_long                 | 50000000 |
| deadlock_timeout_short                | 10000    |
| delayed_insert_timeout                | 300      |
| idle_readonly_transaction_timeout     | 0        |
| idle_transaction_timeout              | 0        |
| idle_write_transaction_timeout        | 0        |
| innodb_flush_log_at_timeout           | 1        |
| innodb_lock_wait_timeout              | 120      |
| innodb_rollback_on_timeout            | ON       |
| interactive_timeout                   | 28800    |
| lock_wait_timeout                     | 86400    |
| net_read_timeout                      | 30       |
| net_write_timeout                     | 60       |
| rpl_semi_sync_master_timeout          | 10000    |
| rpl_semi_sync_slave_kill_conn_timeout | 5        |
| slave_net_timeout                     | 60       |
| thread_pool_idle_timeout              | 60       |
| wait_timeout                          | 28800    |
+---------------------------------------+----------+
frappe@vmi2187306:~/frappe-bench$ # Check for any recent connection errors in MariaDB logs
sudo tail -50 /var/log/mysql/error.log | grep -i "abort\|timeout\|connection"
tail: cannot open '/var/log/mysql/error.log' for reading: No such file or directory
frappe@vmi2187306:~/frappe-bench$ # Check if there are any stuck processes
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+------+-------------------+-----------------+-------------------+---------+------+------------+--------------------------------------------------------------------------+----------+
| Id   | User              | Host            | db                | Command | Time | State      | Info                                                  | Progress |
+------+-------------------+-----------------+-------------------+---------+------+------------+--------------------------------------------------------------------------+----------+
| 1606 | _86b0b85ccf42b383 | localhost:54274 | _86b0b85ccf42b383 | Sleep   |  125 |            | NULL                                                  |    0.000 |
| 2008 | _86b0b85ccf42b383 | localhost:55132 | _86b0b85ccf42b383 | Query   |   98 | Statistics | SELECT `current` FROM `tabSeries` WHERE `name`='HR-EAD-2025-' FOR UPDATE |    0.000 |
| 2060 | _86b0b85ccf42b383 | localhost:55240 | _86b0b85ccf42b383 | Query   |    0 | starting   | SHOW PROCESSLIST                                                  |    0.000 |
+------+-------------------+-----------------+-------------------+---------+------+------------+--------------------------------------------------------------------------+----------+
frappe@vmi2187306:~/frappe-bench$ # Kill the stuck process
bench --site smartvision.com mariadb -e "KILL 2008;"
ERROR 1094 (HY000) at line 1: Unknown thread id: 2008
frappe@vmi2187306:~/frappe-bench$ # Check current processes
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id   | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| 1606 | _86b0b85ccf42b383 | localhost:54274 | _86b0b85ccf42b383 | Sleep   |  163 |          | NULL             |    0.000 |
| 2068 | _86b0b85ccf42b383 | localhost:55256 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench$ # Check if there are any locks on the Series table
bench --site smartvision.com mariadb -e "SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;"
ERROR 1227 (42000) at line 1: Access denied; you need (at least one of) the PROCESS privilege(s) for this operation
frappe@vmi2187306:~/frappe-bench$ # Also check for any lock waits
bench --site smartvision.com mariadb -e "SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;"
ERROR 1227 (42000) at line 1: Access denied; you need (at least one of) the PROCESS privilege(s) for this operation
frappe@vmi2187306:~/frappe-bench$ # Restart bench services to clear any remaining locks
bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ # Check the Series table directly to see if there are any issues
bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Check the Employee Advance series
   ...: series = frappe.get_doc("Series", "HR-EAD-2025-")
   ...: print(f"Current value: {series.current}")
   ...:
   ...: # Try to manually update it if needed
   ...: series.current = series.current + 1
   ...: series.save()
   ...: print("Series updated successfully")
   ...: exit
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
File ~/frappe-bench/apps/frappe/frappe/modules/utils.py:254, in load_doctype_module(doctype, module, prefix, suffix)
    253 try:
--> 254         doctype_python_modules[key] = frappe.get_module(module_name)
    255 except ImportError as e:

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1483, in get_module(modulename)
   1482 """Returns a module object for given Python module name using `importlib.import_module`."""
-> 1483 return importlib.import_module(modulename)

File /usr/lib/python3.10/importlib/__init__.py:126, in import_module(name, package)
    125         level += 1
--> 126 return _bootstrap._gcd_import(name[level:], package, level)

File <frozen importlib._bootstrap>:1050, in _gcd_import(name, package, level)

File <frozen importlib._bootstrap>:1027, in _find_and_load(name, import_)

File <frozen importlib._bootstrap>:992, in _find_and_load_unlocked(name, import_)

File <frozen importlib._bootstrap>:241, in _call_with_frames_removed(f, *args, **kwds)

File <frozen importlib._bootstrap>:1050, in _gcd_import(name, package, level)

File <frozen importlib._bootstrap>:1027, in _find_and_load(name, import_)

File <frozen importlib._bootstrap>:1004, in _find_and_load_unlocked(name, import_)

ModuleNotFoundError: No module named 'frappe.core.doctype.series'

The above exception was the direct cause of the following exception:

ImportError                               Traceback (most recent call last)
Cell In[1], line 2
      1 # Check the Employee Advance series
----> 2 series = frappe.get_doc("Series", "HR-EAD-2025-")
      3 print(f"Current value: {series.current}")
      5 # Try to manually update it if needed

File ~/frappe-bench/apps/frappe/frappe/__init__.py:1340, in get_doc(*args, **kwargs)
   1323 """Return a `frappe.model.document.Document` object of the given type and name.
   1324
   1325 :param arg1: DocType name as string **or** document JSON.
   (...)
   1336
   1337 """
   1338 import frappe.model.document
-> 1340 doc = frappe.model.document.get_doc(*args, **kwargs)
   1342 # Replace cache if stale one exists
   1343 if not kwargs.get("for_update") and (key := can_cache_doc(args)) and cache.exists(key):

File ~/frappe-bench/apps/frappe/frappe/model/document.py:83, in get_doc(*args, **kwargs)
     80         else:
     81                 raise ValueError('"doctype" is a required key')
---> 83 controller = get_controller(doctype)
     84 if controller:
     85         return controller(*args, **kwargs)

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:70, in get_controller(doctype)
     68 site_controllers = frappe.controllers.setdefault(frappe.local.site, {})
     69 if doctype not in site_controllers:
---> 70         site_controllers[doctype] = import_controller(doctype)
     72 return site_controllers[doctype]

File ~/frappe-bench/apps/frappe/frappe/model/base_document.py:95, in import_controller(doctype)
     92         module = frappe.get_module(module_path)
     94 else:
---> 95         module = load_doctype_module(doctype, module_name)
     96         classname = doctype.replace(" ", "").replace("-", "")
     98 class_ = getattr(module, classname, None)

File ~/frappe-bench/apps/frappe/frappe/modules/utils.py:258, in load_doctype_module(doctype, module, prefix, suffix)
    256                 msg = f"Module import failed for {doctype}, the DocType you're trying to open might be deleted."
    257                 msg += f"\nError: {e}"
--> 258                 raise ImportError(msg) from e
    260 return doctype_python_modules[key]

ImportError: Module import failed for Series, the DocType you're trying to open might be deleted.
Error: No module named 'frappe.core.doctype.series'

   ...:
   ...: # Check if there are any Employee Advances created today
   ...: recent_advances = frappe.get_all("Employee Advance",
   ...:     filters={"creation": [">=", frappe.utils.today()]},
   ...:     fields=["name", "creation"])
   ...: print(f"Recent Employee Advances: {recent_advances}")
   ...:
   ...: # Try to create a simple test advance to see if it works now
   ...: try:
   ...:     test_advance = frappe.new_doc("Employee Advance")
   ...:     test_advance.employee = "SVG-092"
   ...:     test_advance.purpose = "Test"
   ...:     test_advance.advance_amount = 100
   ...:     test_advance.posting_date = frappe.utils.today()
   ...:     test_advance.company = "Orbit"
   ...:     test_advance.currency = "AED"
   ...:     test_advance.exchange_rate = 1.0
   ...:     test_advance.set("advance_account", "Employee Advances - OR")
   ...:
   ...:     test_advance.insert()
   ...:     print(f"Success! Created: {test_advance.name}")
   ...:
   ...:     # Clean up
   ...:     frappe.delete_doc("Employee Advance", test_advance.name)
   ...:     print("Test advance deleted")
   ...:
   ...: except Exception as e:
   ...:     print(f"Still failing: {e}")
   ...:
   ...: exit
---------------------------------------------------------------------------
OperationalError                          Traceback (most recent call last)
Cell In[2], line 2
      1 # Check the naming series directly from the database
----> 2 series_data = frappe.db.get_value("Series", "HR-EAD-2025-", ["current"], as_dict=True)
      3 print(f"Series data: {series_data}")
      5 # Check if there are any Employee Advances created today

File ~/frappe-bench/apps/frappe/frappe/database/database.py:512, in Database.get_value(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, cache, for_update, run, pluck, distinct, skip_locked, wait)
    464 def get_value(
    465         self,
    466         doctype,
   (...)
    480         wait=True,
    481 ):
    482         """Returns a document property or list of properties.
    483
    484         :param doctype: DocType name.
   (...)
    509                 frappe.db.get_value("System Settings", None, "date_format")
    510         """
--> 512         result = self.get_values(
    513                 doctype,
    514                 filters,
    515                 fieldname,
    516                 ignore,
    517                 as_dict,
    518                 debug,
    519                 order_by,
    520                 cache=cache,
    521                 for_update=for_update,
    522                 run=run,
    523                 pluck=pluck,
    524                 distinct=distinct,
    525                 limit=1,
    526                 skip_locked=skip_locked,
    527                 wait=wait,
    528         )
    530         if not run:
    531                 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:616, in Database.get_values(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, update, cache, for_update, run, pluck, distinct, limit, skip_locked, wait)
    614         if order_by:
    615                 order_by = "modified" if order_by == DefaultOrderBy else order_by
--> 616         out = self._get_values_from_table(
    617                 fields=fields,
    618                 filters=filters,
    619                 doctype=doctype,
    620                 as_dict=as_dict,
    621                 debug=debug,
    622                 order_by=order_by,
    623                 update=update,
    624                 run=run,
    625                 pluck=pluck,
    626                 distinct=distinct,
    627                 limit=limit,
    628                 for_update=for_update,
    629                 skip_locked=skip_locked,
    630                 wait=wait,
    631         )
    632 except Exception as e:
    633         if ignore and (
    634                 frappe.db.is_missing_column(e)
    635                 or frappe.db.is_table_missing(e)
    636                 or str(e).startswith("Invalid DocType")
    637         ):

File ~/frappe-bench/apps/frappe/frappe/database/database.py:889, in Database._get_values_from_table(self, fields, filters, doctype, as_dict, debug, order_by, update, for_update, skip_locked, wait, run, pluck, distinct, limit)
    886 if isinstance(fields, str) and fields == "*":
    887         as_dict = True
--> 889 return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:563, in Connection.query(self, sql, unbuffered)
    561     sql = sql.encode(self.encoding, "surrogateescape")
    562 self._execute_command(COMMAND.COM_QUERY, sql)
--> 563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:825, in Connection._read_query_result(self,unbuffered)
    823 else:
    824     result = MySQLResult(self)
--> 825     result.read()
    826 self._result = result
    827 if result.server_status is not None:

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:1199, in MySQLResult.read(self)
   1197 def read(self):
   1198     try:
-> 1199         first_packet = self.connection._read_packet()
   1201         if first_packet.is_ok_packet():
   1202             self._read_ok_packet(first_packet)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:775, in Connection._read_packet(self, packet_type)
    773     if self._result is not None and self._result.unbuffered_active is True:
    774         self._result.unbuffered_active = False
--> 775     packet.raise_for_error()
    776 return packet

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/protocol.py:219, in MysqlPacket.raise_for_error(self)
    217 if DEBUG:
    218     print("errno =", errno)
--> 219 err.raise_mysql_exception(self._data)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/err.py:150, in raise_mysql_exception(data)
    148 if errorclass is None:
    149     errorclass = InternalError if errno < 1000 else OperationalError
--> 150 raise errorclass(errno, errval)

OperationalError: (1054, "Unknown column 'modified' in 'order clause'")

In [3]: # Exit the console first
   ...: exit
Out[3]: <IPython.core.autocall.ExitAutocall at 0x7f85678c3e50>

   ...:
   ...: # Check if there are any Employee Advances created today
   ...: recent_advances = frappe.get_all("Employee Advance",
   ...:     filters={"creation": [">=", frappe.utils.today()]},
   ...:     fields=["name", "creation"])
   ...: print(f"Recent Employee Advances: {recent_advances}")
   ...:
   ...: # Try to create a simple test advance to see if it works now
   ...: try:
   ...:     test_advance = frappe.new_doc("Employee Advance")
   ...:     test_advance.employee = "SVG-092"
   ...:     test_advance.purpose = "Test"
   ...:     test_advance.advance_amount = 100
   ...:     test_advance.posting_date = frappe.utils.today()
   ...:     test_advance.company = "Orbit"
   ...:     test_advance.currency = "AED"
   ...:     test_advance.exchange_rate = 1.0
   ...:     test_advance.set("advance_account", "Employee Advances - OR")
   ...:
   ...:     test_advance.insert()
   ...:     print(f"Success! Created: {test_advance.name}")
   ...:
   ...:     # Clean up
   ...:     frappe.delete_doc("Employee Advance", test_advance.name)
   ...:     print("Test advance deleted")
   ...:
   ...: except Exception as e:
   ...:     print(f"Still failing: {e}")
   ...:
   ...: exit()
---------------------------------------------------------------------------
OperationalError                          Traceback (most recent call last)
Cell In[4], line 2
      1 # Check the naming series directly from the database
----> 2 series_data = frappe.db.get_value("Series", "HR-EAD-2025-", ["current"], as_dict=True)
      3 print(f"Series data: {series_data}")
      5 # Check if there are any Employee Advances created today

File ~/frappe-bench/apps/frappe/frappe/database/database.py:512, in Database.get_value(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, cache, for_update, run, pluck, distinct, skip_locked, wait)
    464 def get_value(
    465         self,
    466         doctype,
   (...)
    480         wait=True,
    481 ):
    482         """Returns a document property or list of properties.
    483
    484         :param doctype: DocType name.
   (...)
    509                 frappe.db.get_value("System Settings", None, "date_format")
    510         """
--> 512         result = self.get_values(
    513                 doctype,
    514                 filters,
    515                 fieldname,
    516                 ignore,
    517                 as_dict,
    518                 debug,
    519                 order_by,
    520                 cache=cache,
    521                 for_update=for_update,
    522                 run=run,
    523                 pluck=pluck,
    524                 distinct=distinct,
    525                 limit=1,
    526                 skip_locked=skip_locked,
    527                 wait=wait,
    528         )
    530         if not run:
    531                 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:616, in Database.get_values(self, doctype, filters, fieldname, ignore, as_dict, debug, order_by, update, cache, for_update, run, pluck, distinct, limit, skip_locked, wait)
    614         if order_by:
    615                 order_by = "modified" if order_by == DefaultOrderBy else order_by
--> 616         out = self._get_values_from_table(
    617                 fields=fields,
    618                 filters=filters,
    619                 doctype=doctype,
    620                 as_dict=as_dict,
    621                 debug=debug,
    622                 order_by=order_by,
    623                 update=update,
    624                 run=run,
    625                 pluck=pluck,
    626                 distinct=distinct,
    627                 limit=limit,
    628                 for_update=for_update,
    629                 skip_locked=skip_locked,
    630                 wait=wait,
    631         )
    632 except Exception as e:
    633         if ignore and (
    634                 frappe.db.is_missing_column(e)
    635                 or frappe.db.is_table_missing(e)
    636                 or str(e).startswith("Invalid DocType")
    637         ):

File ~/frappe-bench/apps/frappe/frappe/database/database.py:889, in Database._get_values_from_table(self, fields, filters, doctype, as_dict, debug, order_by, update, for_update, skip_locked, wait, run, pluck, distinct, limit)
    886 if isinstance(fields, str) and fields == "*":
    887         as_dict = True
--> 889 return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)

File ~/frappe-bench/apps/frappe/frappe/query_builder/utils.py:87, in patch_query_execute.<locals>.execute_query(query, *args, **kwargs)
     85 child_queries = query._child_queries if isinstance(query._child_queries, list) else []
     86 query, params = prepare_query(query)
---> 87 result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
     88 execute_child_queries(child_queries, result)
     89 return result

File ~/frappe-bench/apps/frappe/frappe/database/database.py:227, in Database.sql(self, query, values, as_dict, as_list,debug, ignore_ddl, auto_commit, update, explain, run, pluck, as_iterator)
    224         query += f" /* FRAPPE_TRACE_ID: {trace_id} */"
    226 try:
--> 227         self._cursor.execute(query, values)
    228 except Exception as e:
    229         if self.is_syntax_error(e):

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:153, in Cursor.execute(self, query, args)
    149     pass
    151 query = self.mogrify(query, args)
--> 153 result = self._query(query)
    154 self._executed = query
    155 return result

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/cursors.py:322, in Cursor._query(self, q)
    320 conn = self._get_db()
    321 self._clear_result()
--> 322 conn.query(q)
    323 self._do_get_result()
    324 return self.rowcount

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:563, in Connection.query(self, sql, unbuffered)
    561     sql = sql.encode(self.encoding, "surrogateescape")
    562 self._execute_command(COMMAND.COM_QUERY, sql)
--> 563 self._affected_rows = self._read_query_result(unbuffered=unbuffered)
    564 return self._affected_rows

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:825, in Connection._read_query_result(self,unbuffered)
    823 else:
    824     result = MySQLResult(self)
--> 825     result.read()
    826 self._result = result
    827 if result.server_status is not None:

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:1199, in MySQLResult.read(self)
   1197 def read(self):
   1198     try:
-> 1199         first_packet = self.connection._read_packet()
   1201         if first_packet.is_ok_packet():
   1202             self._read_ok_packet(first_packet)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py:775, in Connection._read_packet(self, packet_type)
    773     if self._result is not None and self._result.unbuffered_active is True:
    774         self._result.unbuffered_active = False
--> 775     packet.raise_for_error()
    776 return packet

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/protocol.py:219, in MysqlPacket.raise_for_error(self)
    217 if DEBUG:
    218     print("errno =", errno)
--> 219 err.raise_mysql_exception(self._data)

File ~/frappe-bench/env/lib/python3.10/site-packages/pymysql/err.py:150, in raise_mysql_exception(data)
    148 if errorclass is None:
    149     errorclass = InternalError if errno < 1000 else OperationalError
--> 150 raise errorclass(errno, errval)

OperationalError: (1054, "Unknown column 'modified' in 'order clause'")

In [5]: exit()

frappe@vmi2187306:~/frappe-bench$ # Restart MariaDB completely
sudo systemctl restart mariadb
frappe@vmi2187306:~/frappe-bench$ # Restart bench services
bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench$ # Check if the system is working now
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| 50 | _86b0b85ccf42b383 | localhost:55374 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench$ cd apps/svg_mobile_app/
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git fetch
git remote: Enumerating objects: 13, done.
remote: Counting objects: 100% (13/13), done.
remote: Compressing objects: 100% (1/1), done.
remote: Total 7 (delta 6), reused 7 (delta 6), pack-reused 0 (from 0)
Unpacking objects: 100% (7/7), 1.22 KiB | 178.00 KiB/s, done.
From https://github.com/mostafamohamed1984/svg_mobile_app
   835edd8..7c1980e  develop    -> origin/develop
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git pull
Updating 835edd8..7c1980e
Fast-forward
 .../svg_mobile_app/doctype/project_contractors/project_contractors.py       | 137 ++++++++----------------------------
 1 file changed, 29 insertions(+), 108 deletions(-)
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com clear-cache
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
Updating customizations for Projects Collection
Updating customizations for Payment Entry Deduction
Updating customizations for Shift Type
Updating customizations for Item
Updating customizations for Bank
Updating customizations for Payment Entry
Updating customizations for Item Barcode
Updating customizations for Employee
Updating customizations for Employee Advance
Updating customizations for Item Group
Updating customizations for Project Contractors
Updating customizations for Sketch
Queued rebuilding of search index for smartvision.com

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check for stuck processes
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id  | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| 308 | _86b0b85ccf42b383 | localhost:55934 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Increase the lock wait timeout to prevent these timeouts
sudo mysql -e "SET GLOBAL innodb_lock_wait_timeout = 300;"
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Also restart bench services to ensure clean connections
bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Verify the change
bench --site smartvision.com mariadb -e "SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';"
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| innodb_lock_wait_timeout | 300   |
+--------------------------+-------+
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check recent error logs
bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Check recent error logs
   ...: import frappe
   ...: logs = frappe.get_all("Error Log", order_by="creation desc", limit=3, fields=["name", "error", "creation"])
   ...: for log in logs:
   ...:     print(f"Error: {log.name} - {log.creation}")
   ...:     error_doc = frappe.get_doc("Error Log", log.name)
   ...:     print(f"Details: {error_doc.error[:1000]}...")
   ...:     print("-" * 50)
   ...:
   ...: exit
Error: l3ksgevi5l - 2025-06-12 13:11:40.470921
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f8102256a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", ...
--------------------------------------------------
Error: kdgggvdjd7 - 2025-06-12 12:33:53.639226
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder black_6796227.png'
      unattached_file = None
      file = <File: unsaved>
  File "apps/frappe/frappe/model/document.py", line 285, in insert
    self.run_method("before_insert")
      self = <File: unsaved>
      ignore_permissions = True
      ignore_links = None
      ignore_if_duplicate = False
      ignore_mandatory = None
      set_name = None
      set_child_names = True
  File "apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwarg...
--------------------------------------------------
Error: kdctb3j4c9 - 2025-06-12 12:33:42.166166
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder black_6796227.png'
      unattached_file = None
      file = <File: unsaved>
  File "apps/frappe/frappe/model/document.py", line 285, in insert
    self.run_method("before_insert")
      self = <File: unsaved>
      ignore_permissions = True
      ignore_links = None
      ignore_if_duplicate = False
      ignore_mandatory = None
      set_name = None
      set_child_names = True
  File "apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwarg...
--------------------------------------------------
Out[1]: <IPython.core.autocall.ExitAutocall at 0x7f7bdd2c3e50>

In [2]: # Check recent error logs
   ...: import frappe
   ...: logs = frappe.get_all("Error Log", order_by="creation desc", limit=3, fields=["name", "error", "creation"])
   ...: for log in logs:
   ...:     print(f"Error: {log.name} - {log.creation}")
   ...:     error_doc = frappe.get_doc("Error Log", log.name)
   ...:     print(f"Details: {error_doc.error[:1000]}...")
   ...:     print("-" * 50)
   ...:
   ...: exit()
Error: l3ksgevi5l - 2025-06-12 13:11:40.470921
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f8102256a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", ...
--------------------------------------------------
Error: kdgggvdjd7 - 2025-06-12 12:33:53.639226
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder black_6796227.png'
      unattached_file = None
      file = <File: unsaved>
  File "apps/frappe/frappe/model/document.py", line 285, in insert
    self.run_method("before_insert")
      self = <File: unsaved>
      ignore_permissions = True
      ignore_links = None
      ignore_if_duplicate = False
      ignore_mandatory = None
      set_name = None
      set_child_names = True
  File "apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwarg...
--------------------------------------------------
Error: kdctb3j4c9 - 2025-06-12 12:33:42.166166
Details: Traceback with variables (most recent call last):
  File "apps/frappe/frappe/core/doctype/file/utils.py", line 368, in attach_files_to_document
    file.insert(ignore_permissions=True)
      doc = <User: h.khalel@smartvgroup.com>
      event = 'on_update'
      attach_fields = [<Attach ImageDocField: user_image parent=User>, <Attach ImageDocField: banner_image parent=User>]
      df = <Attach ImageDocField: user_image parent=User>
      value = '/private/files/—Pngtree—user avatar placeholder black_6796227.png'
      unattached_file = None
      file = <File: unsaved>
  File "apps/frappe/frappe/model/document.py", line 285, in insert
    self.run_method("before_insert")
      self = <File: unsaved>
      ignore_permissions = True
      ignore_links = None
      ignore_if_duplicate = False
      ignore_mandatory = None
      set_name = None
      set_child_names = True
  File "apps/frappe/frappe/model/document.py", line 962, in run_method
    out = Document.hook(fn)(self, *args, **kwarg...
--------------------------------------------------

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check for any deadlocks or lock information
sudo mysql -e "SHOW ENGINE INNODB STATUS\G" | grep -A 20 "LATEST DETECTED DEADLOCK"
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Let's try to manually reset the naming series to clear any locks
bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

   ...:     frappe.db.commit()
   ...:     print("Series table updated successfully")
   ...:
   ...: except Exception as e:
   ...:     print(f"Error accessing series table: {e}")
   ...:
   ...: # Try creating a simple Employee Advance to test
   ...: try:
   ...:     test_advance = frappe.new_doc("Employee Advance")
   ...:     test_advance.employee = "SVG-092"
   ...:     test_advance.purpose = "Test"
   ...:     test_advance.advance_amount = 100
   ...:     test_advance.posting_date = frappe.utils.today()
   ...:     test_advance.company = "Orbit"
   ...:     test_advance.currency = "AED"
   ...:     test_advance.exchange_rate = 1.0
   ...:     test_advance.set("advance_account", "Employee Advances - OR")
   ...:
   ...:     # Try to save
   ...:     test_advance.insert()
   ...:     print(f"Success! Created: {test_advance.name}")
   ...:
   ...:     # Clean up
   ...:     frappe.delete_doc("Employee Advance", test_advance.name)
   ...:     print("Test advance deleted")
   ...:
   ...: except Exception as e:
   ...:     print(f"Still failing: {e}")
   ...:
   ...: exit
Current series value: [{'current': 11}]
Series table updated successfully
Still failing: [Employee Advance, HR-EAD-2025-00012]: advance_account
Out[1]: <IPython.core.autocall.ExitAutocall at 0x7f989f4c3e50>

   ...: advance_account_field = meta.get_field("advance_account")
   ...: print(f"Field details: {advance_account_field.as_dict()}")
   ...:
   ...: # Try the direct dictionary assignment method that worked before
   ...: try:
   ...:     test_advance = frappe.new_doc("Employee Advance")
   ...:     test_advance.employee = "SVG-092"
   ...:     test_advance.purpose = "Test"
   ...:     test_advance.advance_amount = 100
   ...:     test_advance.posting_date = frappe.utils.today()
   ...:     test_advance.company = "Orbit"
   ...:     test_advance.currency = "AED"
   ...:     test_advance.exchange_rate = 1.0
   ...:
   ...:     # Use the direct dictionary assignment that worked before
   ...:     test_advance.__dict__['advance_account'] = "Employee Advances - OR"
   ...:     print(f"Set advance_account via dict: {test_advance.get('advance_account')}")
   ...:
   ...:     # Try to save
   ...:     test_advance.insert()
   ...:     print(f"Success! Created: {test_advance.name}")
   ...:
   ...:     # Clean up
   ...:     frappe.delete_doc("Employee Advance", test_advance.name)
   ...:     print("Test advance deleted")
   ...:
   ...: except Exception as e:
   ...:     print(f"Still failing with dict method: {e}")
   ...:
   ...: exit()
Account details: {'name': 'Employee Advances - OR', 'company': 'Orbit', 'account_type': 'Payable', 'is_group': 0, 'disabled': 0}
Field details: {'name': '9hvp7mk95t', 'creation': datetime.datetime(2022, 1, 17, 18, 36, 51, 450395), 'modified': datetime.datetime(2024, 10, 3, 21, 22, 4, 130584), 'modified_by': 'Administrator', 'owner': 'Administrator', 'docstatus': 0, 'parent': 'Employee Advance', 'parentfield': 'fields', 'parenttype': 'DocType', 'idx': 23, 'fieldname': 'advance_account', 'label': 'Advance Account', 'oldfieldname': None, 'fieldtype': 'Link', 'oldfieldtype': None, 'options': 'Account', 'search_index': 0, 'show_dashboard': 0, 'hidden': 0, 'set_only_once': 0, 'allow_in_quick_entry': 0, 'print_hide': 0, 'report_hide': 0, 'reqd': 1, 'bold': 0, 'in_global_search': 0, 'collapsible': 0, 'unique': 0, 'no_copy': 0, 'allow_on_submit': 0, 'show_preview_popup': 0, 'trigger': None, 'collapsible_depends_on': None, 'mandatory_depends_on': None, 'read_only_depends_on': None, 'depends_on': None, 'permlevel': 0, 'ignore_user_permissions': 1, 'width': None, 'print_width': None,'columns': 0, 'default': None, 'description': None, 'in_list_view': 0, 'fetch_if_empty': 0, 'in_filter': 0, 'remember_last_selected_value': 0, 'ignore_xss_filter': 0, 'print_hide_if_no_value': 0, 'allow_bulk_edit': 0, 'in_standard_filter':0, 'in_preview': 0, 'read_only': 0, 'precision': None, 'max_height': None, 'length': 0, 'translatable': 0, 'hide_border': 0, 'hide_days': 0, 'hide_seconds': 0, 'non_negative': 0, 'is_virtual': 0, 'sort_options': 0, 'link_filters': None, 'fetch_from': 'company.default_employee_advance_account', 'show_on_timeline': 0, 'documentation_url': None, 'placeholder':None, 'doctype': 'DocField'}
Set advance_account via dict: Employee Advances - OR
Still failing with dict method: [Employee Advance, HR-EAD-2025-00013]: advance_account

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check if the company has the default_employee_advance_account set
company_advance_account = frappe.db.get_value("Company", "Orbit", "default_employee_advance_account")
print(f"Company default advance account: {company_advance_account}")

# Set the default advance account for the company
if not company_advance_account:
    frappe.db.set_value("Company", "Orbit", "default_employee_advance_account", "Employee Advances - OR")
    frappe.db.commit()
    print("Set default advance account for company")

# Now try creating the Employee Advance again
try:
    test_advance = frappe.new_doc("Employee Advance")
    test_advance.employee = "SVG-092"
    test_advance.purpose = "Test"
    test_advance.advance_amount = 100
    test_advance.posting_date = frappe.utils.today()
    test_advance.company = "Orbit"
    test_advance.currency = "AED"
    test_advance.exchange_rate = 1.0

    # The advance_account should now be automatically fetched from company
    print(f"Advance account after company set: {test_advance.get('advance_account')}")

    # Try to save
    test_advance.insert()
    print(f"Success! Created: {test_advance.name}")

    # Clean up
exitprint(f"Error: {e}")deleted")dvance", test_advance.name)
-bash: syntax error near unexpected token `('
-bash: syntax error near unexpected token `f"Company default advance account: {company_advance_account}"'
-bash: syntax error near unexpected token `"Company",'
-bash: syntax error near unexpected token `print'
try:: command not found
-bash: syntax error near unexpected token `('
test_advance.employee: command not found
test_advance.purpose: command not found
test_advance.advance_amount: command not found
-bash: syntax error near unexpected token `('
test_advance.company: command not found
test_advance.currency: command not found
test_advance.exchange_rate: command not found
-bash: syntax error near unexpected token `f"Advance account after company set: {test_advance.get('advance_account')}"'
-bash: syntax error near unexpected token `print'
-bash: syntax error near unexpected token `"Employee Advance",'
-bash: syntax error near unexpected token `"Test advance deleted"'
except: command not found
-bash: syntax error near unexpected token `f"Error: {e}"'
logout
There are stopped jobs.
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

   ...:     frappe.db.set_value("Company", "Orbit", "default_employee_advance_account", "Employee Advances - OR")
   ...:     frappe.db.commit()
   ...:     print("Set default advance account for company")
   ...:
   ...: # Now try creating the Employee Advance again
   ...: try:
   ...:     test_advance = frappe.new_doc("Employee Advance")
   ...:     test_advance.employee = "SVG-092"
   ...:     test_advance.purpose = "Test"
   ...:     test_advance.advance_amount = 100
   ...:     test_advance.posting_date = frappe.utils.today()
   ...:     test_advance.company = "Orbit"
   ...:     test_advance.currency = "AED"
   ...:     test_advance.exchange_rate = 1.0
   ...:
   ...:     # The advance_account should now be automatically fetched from company
   ...:     print(f"Advance account after company set: {test_advance.get('advance_account')}")
   ...:
   ...:     # Try to save
   ...:     test_advance.insert()
   ...:     print(f"Success! Created: {test_advance.name}")
   ...:
   ...:     # Clean up
   ...:     frappe.delete_doc("Employee Advance", test_advance.name)
   ...:     print("Test advance deleted")
   ...:
   ...: except Exception as e:
   ...:     print(f"Error: {e}")
   ...:
   ...: exit()
Company default advance account: Employee Advances - OR
Advance account after company set: None
Error: [Employee Advance, HR-EAD-2025-00012]: advance_account

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

   ...: except Exception as e:
   ...:     print(f"Error: {e}")
   ...:
   ...:     # If that fails, try using db_set after insert
   ...:     try:
   ...:         test_advance2 = frappe.new_doc("Employee Advance")
   ...:         test_advance2.employee = "SVG-092"
   ...:         test_advance2.purpose = "Test"
   ...:         test_advance2.advance_amount = 100
   ...:         test_advance2.posting_date = frappe.utils.today()
   ...:         test_advance2.company = "Orbit"
   ...:         test_advance2.currency = "AED"
   ...:         test_advance2.exchange_rate = 1.0
   ...:
   ...:         # Save without advance_account first, then set it
   ...:         test_advance2.flags.ignore_mandatory = True
   ...:         test_advance2.insert()
   ...:
   ...:         # Now set the advance_account
   ...:         test_advance2.db_set("advance_account", "Employee Advances - OR")
   ...:         print(f"Success with db_set! Created: {test_advance2.name}")
   ...:
   ...:         # Clean up
   ...:         frappe.delete_doc("Employee Advance", test_advance2.name)
   ...:         print("Test advance deleted")
   ...:
   ...:     except Exception as e2:
   ...:         print(f"Error with db_set: {e2}")
   ...:
   ...: exit()
Advance account manually set: Employee Advances - OR
Error: [Employee Advance, HR-EAD-2025-00012]: advance_account
Success with db_set! Created: HR-EAD-2025-00013
Test advance deleted

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git fetch
remote: Enumerating objects: 13, done.
remote: Counting objects: 100% (13/13), done.
remote: Compressing objects: 100% (1/1), done.
remote: Total 7 (delta 6), reused 7 (delta 6), pack-reused 0 (from 0)
Unpacking objects: 100% (7/7), 749 bytes | 124.00 KiB/s, done.
From https://github.com/mostafamohamed1984/svg_mobile_app
   7c1980e..9334ddf  develop    -> origin/develop
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ git pull
Updating 7c1980e..9334ddf
Fast-forward
 svg_mobile_app/svg_mobile_app/doctype/project_contractors/project_contractors.py | 17 +++++++----------
 1 file changed, 7 insertions(+), 10 deletions(-)
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com clear-cache
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site smartvision.com migrate
Migrating smartvision.com
Updating DocTypes for frappe        : [========================================] 100%
Updating DocTypes for erpnext       : [========================================] 100%
Updating DocTypes for hrms          : [========================================] 100%
Updating DocTypes for zk_integration: [========================================] 100%
Updating DocTypes for svg_mobile_app: [========================================] 100%
Updating DocTypes for esign_app     : [========================================] 100%
Updating Dashboard for frappe
Updating Dashboard for erpnext
Updating Dashboard for hrms
Updating Dashboard for zk_integration
Updating Dashboard for svg_mobile_app
Updating Dashboard for esign_app
Updating customizations for Address
Updating customizations for Contact
Updating customizations for Employee Advance
Updating customizations for Overtime Request
Updating customizations for Employee Checkin
Updating customizations for Fees and Deposits
Updating customizations for Projects Collection
Updating customizations for Payment Entry Deduction
Updating customizations for Shift Type
Updating customizations for Item
Updating customizations for Bank
Updating customizations for Payment Entry
Updating customizations for Item Barcode
Updating customizations for Employee
Updating customizations for Employee Advance
Updating customizations for Item Group
Updating customizations for Project Contractors
Updating customizations for Sketch
Queued rebuilding of search index for smartvision.com

frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check recent error logs to see the specific error
bench --site smartvision.com console
Apps in this namespace:
frappe, erpnext, hrms, zk_integration, svg_mobile_app, esign_app

In [1]: # Check the most recent error
   ...: import frappe
   ...: logs = frappe.get_all("Error Log", order_by="creation desc", limit=1, fields=["name", "error", "creation"])
   ...: if logs:
   ...:     error_doc = frappe.get_doc("Error Log", logs[0].name)
   ...:     print(f"Latest error ({logs[0].creation}):")
   ...:     print(error_doc.error)
   ...: else:
   ...:     print("No recent errors found")
   ...:
   ...: exit
Latest error (2025-06-12 13:11:40.470921):
Traceback with variables (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      response = None
      rollback = True
      e = QueryTimeoutError(OperationalError(1205, 'Lock wait timeout exceeded; try restarting transaction'))
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
      request = <Request 'https://erp.smartvgroup.com/api/method/frappe.desk.form.save.savedocs' [POST]>
      endpoint = <function handle_rpc_call at 0x7f8102256a70>
      arguments = {'method': 'frappe.desk.form.save.savedocs'}
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
      method = 'frappe.desk.form.save.savedocs'
      frappe = <module 'frappe' from 'apps/frappe/frappe/__init__.py'>
  File "apps/frappe/frappe/handler.py", line 49, in handle
    data = execute_cmd(cmd)
      cmd = 'frappe.desk.form.save.savedocs'
      data = None
  File "apps/frappe/frappe/handler.py", line 85, in execute_cmd
    return frappe.call(method, **frappe.form_dict)
      cmd = 'frappe.desk.form.save.savedocs'
      from_async = False
      server_script = None
      method = <function savedocs at 0x7f810026f250>
  File "apps/frappe/frappe/__init__.py", line 1775, in call
    return fn(*args, **newargs)
      fn = <function savedocs at 0x7f810026f250>
      args = ()
      kwargs = {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save', 'cmd': 'frappe.desk.form.save.savedocs'}
      newargs = {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save'}
  File "apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
      args = ()
      kwargs = {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save'}
      apply_condition = <function whitelist.<locals>.innerfn.<locals>.<lambda> at 0x7f810026f1c0>
      func = <function savedocs at 0x7f810026f130>
  File "apps/frappe/frappe/desk/form/save.py", line 39, in savedocs
    doc.save()
      doc = <EmployeeAdvance: unsaved>
      action = 'Save'
  File "apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
      self = <EmployeeAdvance: unsaved>
      args = ()
      kwargs = {}
  File "apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
      self = <EmployeeAdvance: unsaved>
      ignore_permissions = None
      ignore_version = None
  File "apps/frappe/frappe/model/document.py", line 286, in insert
    self.set_new_name(set_name=set_name, set_child_names=set_child_names)
      self = <EmployeeAdvance: unsaved>
      ignore_permissions = None
      ignore_links = None
      ignore_if_duplicate = False
      ignore_mandatory = None
      set_name = None
      set_child_names = True
  File "apps/frappe/frappe/model/document.py", line 496, in set_new_name
    set_new_name(self)
      self = <EmployeeAdvance: unsaved>
      force = False
      set_name = None
      set_child_names = True
      autoname = 'naming_series:'
  File "apps/frappe/frappe/model/naming.py", line 166, in set_new_name
    set_name_from_naming_options(autoname, doc)
      doc = <EmployeeAdvance: unsaved>
      meta = <Meta: Employee Advance>
      autoname = 'naming_series:'
  File "apps/frappe/frappe/model/naming.py", line 204, in set_name_from_naming_options
    set_name_by_naming_series(doc)
      autoname = 'naming_series:'
      doc = <EmployeeAdvance: unsaved>
      _autoname = 'naming_series:'
  File "apps/frappe/frappe/model/naming.py", line 245, in set_name_by_naming_series
    doc.name = make_autoname(doc.naming_series + ".#####", "", doc)
      doc = <EmployeeAdvance: unsaved>
  File "apps/frappe/frappe/model/naming.py", line 271, in make_autoname
    return series.generate_next_name(doc, ignore_validate=ignore_validate)
      key = ********
      doctype = ''
      doc = <EmployeeAdvance: unsaved>
      ignore_validate = False
      series = <frappe.model.naming.NamingSeries object at 0x7f80fee87100>
  File "apps/frappe/frappe/model/naming.py", line 71, in generate_next_name
    return parse_naming_series(parts, doc=doc)
      self = <frappe.model.naming.NamingSeries object at 0x7f80fee87100>
      doc = <EmployeeAdvance: unsaved>
      ignore_validate = False
      parts = ['HR-EAD-', 'YYYY', '-', '#####']
  File "apps/frappe/frappe/model/naming.py", line 329, in parse_naming_series
    part = number_generator(name, digits)
      parts = ['HR-EAD-', 'YYYY', '-', '#####']
      doctype = None
      doc = <EmployeeAdvance: unsaved>
      number_generator = <function getseries at 0x7f81028f39a0>
      name = 'HR-EAD-2025-'
      _sentinel = <exception while printing> Traceback (most recent call last):
          File "env/lib/python3.10/site-packages/traceback_with_variables/core.py", line 222, in _to_cropped_str
            raw = print_(obj)
          File "apps/frappe/frappe/utils/__init__.py", line 328, in dict_printer
            if key in v:
        TypeError: argument of type 'object' is not iterable

      series_set = False
      today = datetime.datetime(2025, 6, 12, 13, 3, 53, 601007)
      e = '#####'
      part = ''
      digits = 5
      method = None
  File "apps/frappe/frappe/model/naming.py", line 381, in getseries
    current = (frappe.qb.from_(series).where(series.name == key).for_update().select("current")).run()
      key = ********
      digits = 5
      series = Table('tabSeries')
  File "apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
      query = 'SELECT `current` FROM `tabSeries` WHERE `name`=%(param1)s FOR UPDATE'
      args = ()
      kwargs = {}
      child_queries = []
      params = {'param1': 'HR-EAD-2025-'}
      execute_child_queries = <function patch_query_execute.<locals>.execute_child_queries at 0x7f80feaf9000>
      prepare_query = <function patch_query_execute.<locals>.prepare_query at 0x7f80feaf9bd0>
  File "apps/frappe/frappe/database/database.py", line 236, in sql
    raise frappe.QueryTimeoutError(e) from e
      self = <frappe.database.mariadb.database.MariaDBDatabase object at 0x7f80ffafbd00>
      query = 'SELECT `current` FROM `tabSeries` WHERE `name`=%(param1)s FOR UPDATE'
      values = {'param1': 'HR-EAD-2025-'}
      as_dict = 0
      as_list = 0
      debug = False
      ignore_ddl = 0
      auto_commit = 0
      update = None
      explain = False
      run = True
      pluck = False
      as_iterator = False
      trace_id = None
frappe.exceptions.QueryTimeoutError: (1205, 'Lock wait timeout exceeded; try restarting transaction')
Out[1]: <IPython.core.autocall.ExitAutocall at 0x7fe4ccdb3e50>

In [2]: # Check company settings
   ...: current_company = frappe.defaults.get_user_default('company')
   ...: print(f"Current default company: {current_company}")
   ...:
   ...: # Check if this company has the default advance account set
   ...: if current_company:
   ...:     advance_account = frappe.db.get_value("Company", current_company, "default_employee_advance_account")
   ...:     print(f"Default advance account for {current_company}: {advance_account}")
   ...:
   ...:     # Check if the account exists
   ...:     if advance_account:
   ...:         account_exists = frappe.db.exists("Account", advance_account)
   ...:         print(f"Account {advance_account} exists: {account_exists}")
   ...:
   ...: # Also check for Orbit company specifically
   ...: orbit_advance_account = frappe.db.get_value("Company", "Orbit", "default_employee_advance_account")
   ...: print(f"Orbit advance account: {orbit_advance_account}")
   ...:
   ...:
Current default company: Orbit
Default advance account for Orbit: Employee Advances - OR
Account Employee Advances - OR exists: Employee Advances - OR
Orbit advance account: Employee Advances - OR


[18]+  Stopped                 bench --site smartvision.com console
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Check for stuck processes
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id  | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| 895 | _86b0b85ccf42b383 | localhost:57180 | _86b0b85ccf42b383 | Sleep   |   45 |          | NULL             |    0.000 |
| 910 | _86b0b85ccf42b383 | localhost:57214 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Restart bench to load the updated code
bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ # Verify the restart completed successfully
bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id  | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| 895 | _86b0b85ccf42b383 | localhost:57180 | _86b0b85ccf42b383 | Sleep   |   75 |          | NULL             |    0.000 |
| 920 | _86b0b85ccf42b383 | localhost:57234 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+-----+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ cd ~/test-bench/apps/svg_mobile_app/
frappe@vmi2187306:~/test-bench/apps/svg_mobile_app$ git fetch
remote: Enumerating objects: 27, done.
remote: Counting objects: 100% (27/27), done.
remote: Compressing objects: 100% (9/9), done.
remote: Total 21 (delta 18), reused 15 (delta 12), pack-reused 0 (from 0)
Unpacking objects: 100% (21/21), 3.46 KiB | 141.00 KiB/s, done.
From https://github.com/mostafamohamed1984/svg_mobile_app
   7451d31..9334ddf  develop    -> origin/develop
frappe@vmi2187306:~/test-bench/apps/svg_mobile_app$ git pull
Updating 7451d31..9334ddf
Fast-forward
 svg_mobile_app/svg_mobile_app/doctype/project_contractors/project_contractors.py | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)
frappe@vmi2187306:~/test-bench/apps/svg_mobile_app$ bench restart
$ sudo supervisorctl restart test-bench-web:
test-bench-web:test-bench-node-socketio: stopped
test-bench-web:test-bench-frappe-web: stopped
test-bench-web:test-bench-frappe-web: started
test-bench-web:test-bench-node-socketio: started
$ sudo supervisorctl restart test-bench-workers:
test-bench-workers:test-bench-frappe-schedule: stopped
test-bench-workers:test-bench-frappe-long-worker-0: stopped
test-bench-workers:test-bench-frappe-short-worker-0: stopped
test-bench-workers:test-bench-frappe-schedule: started
test-bench-workers:test-bench-frappe-short-worker-0: started
test-bench-workers:test-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.1
frappe@vmi2187306:~/test-bench/apps/svg_mobile_app$ cd ~/frappe-bench/apps/svg_mobile_app/
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site all status
Usage: bench frappe [OPTIONS] COMMAND [ARGS]...
Try 'bench frappe --help' for help.

Error: No such command 'status'.
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench doctor
-----Checking scheduler status-----
Workers online: 2
-----None Jobs-----
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ supervisorctl status
error: <class 'PermissionError'>, [Errno 13] Permission denied: file: /usr/lib/python3/dist-packages/supervisor/xmlrpc.py line: 560
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ sudo supervisorctl status
frappe-bench-redis:frappe-bench-redis-cache               RUNNING   pid 2130609, uptime 2 days, 0:10:01
frappe-bench-redis:frappe-bench-redis-queue               RUNNING   pid 2130610, uptime 2 days, 0:10:01
frappe-bench-web:frappe-bench-frappe-web                  RUNNING   pid 2224031, uptime 0:10:27
frappe-bench-web:frappe-bench-node-socketio               RUNNING   pid 2224032, uptime 0:10:27
frappe-bench-workers:frappe-bench-frappe-long-worker-0    RUNNING   pid 2224061, uptime 0:10:26
frappe-bench-workers:frappe-bench-frappe-schedule         RUNNING   pid 2224059, uptime 0:10:26
frappe-bench-workers:frappe-bench-frappe-short-worker-0   RUNNING   pid 2224060, uptime 0:10:26
test-bench-redis:test-bench-redis-cache                   RUNNING   pid 2130624, uptime 2 days, 0:10:01
test-bench-redis:test-bench-redis-queue                   RUNNING   pid 2130625, uptime 2 days, 0:10:01
test-bench-web:test-bench-frappe-web                      RUNNING   pid 2224586, uptime 0:00:04
test-bench-web:test-bench-node-socketio                   RUNNING   pid 2224231, uptime 0:07:47
test-bench-workers:test-bench-frappe-long-worker-0        RUNNING   pid 2224243, uptime 0:07:45
test-bench-workers:test-bench-frappe-schedule             RUNNING   pid 2224241, uptime 0:07:45
test-bench-workers:test-bench-frappe-short-worker-0       RUNNING   pid 2224242, uptime 0:07:45
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ bench --site all mariadb -e "SHOW PROCESSLIST;"
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id   | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
|  895 | _86b0b85ccf42b383 | localhost:57180 | _86b0b85ccf42b383 | Sleep   |  725 |          | NULL             |    0.000 |
| 1215 | _86b0b85ccf42b383 | localhost:57862 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ tail -50 logs/web.err.log
tail: cannot open 'logs/web.err.log' for reading: No such file or directory
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ tail -50 logs/worker.err.log
tail: cannot open 'logs/worker.err.log' for reading: No such file or directory
frappe@vmi2187306:~/frappe-bench/apps/svg_mobile_app$ cd ..
frappe@vmi2187306:~/frappe-bench/apps$ cd ..
frappe@vmi2187306:~/frappe-bench$ tail -50 logs/worker.err.log
tail: cannot open 'logs/worker.err.log' for reading: No such file or directory
frappe@vmi2187306:~/frappe-bench$ tail -50 logs/web.err.log
tail: cannot open 'logs/web.err.log' for reading: No such file or directory
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SELECT 1;"
+---+
| 1 |
+---+
| 1 |
+---+
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com show-pending-jobs
-----Pending Jobs-----
frappe@vmi2187306:~/frappe-bench$ sudo systemctl status nginx
● nginx.service - A high performance web server and a reverse proxy server
     Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2025-05-26 12:31:18 CEST; 2 weeks 3 days ago
       Docs: man:nginx(8)
   Main PID: 1522566 (nginx)
      Tasks: 8 (limit: 19117)
     Memory: 31.1M
        CPU: 11min 9.741s
     CGroup: /system.slice/nginx.service
             ├─1522566 "nginx: master process /usr/sbin/nginx -g daemon on; master_process on;"
             ├─1778608 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             ├─1778609 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             ├─1778610 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             ├─1778611 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             ├─1778612 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             ├─1778613 "nginx: worker process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" >
             └─1778614 "nginx: cache manager process" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""

Notice: journal has been rotated since unit was started, output may be incomplete.
lines 1-19/19 (END)
[19]+  Stopped                 sudo systemctl status nginx
frappe@vmi2187306:~/frappe-bench$ sudo tail -50 /var/log/nginx/error.log
2025/06/12 01:22:29 [crit] 1778608#1778608: *168527 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 20.102.91.36, server: 0.0.0.0:443
2025/06/12 02:36:21 [crit] 1778608#1778608: *168692 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 101.36.97.172, server: 0.0.0.0:443
2025/06/12 03:35:33 [crit] 1778608#1778608: *168923 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 193.24.123.85, server: 0.0.0.0:443
2025/06/12 03:55:30 [crit] 1778608#1778608: *169166 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 87.236.176.64, server: 0.0.0.0:443
2025/06/12 04:51:23 [crit] 1778608#1778608: *169314 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 185.242.226.109, server: 0.0.0.0:443
2025/06/12 06:46:40 [crit] 1778608#1778608: *169564 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 106.75.63.219, server: 0.0.0.0:443
2025/06/12 08:29:27 [crit] 1778608#1778608: *170444 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 138.197.169.14, server: 0.0.0.0:443
2025/06/12 09:42:07 [crit] 1778608#1778608: *171593 SSL_do_handshake() failed (SSL: error:0A00006C:SSL routines::bad key share) while SSL handshaking, client: 212.102.40.218, server: 0.0.0.0:443
2025/06/12 10:24:05 [error] 1778608#1778608: *172757 connect() failed (111: Unknown error) while connecting to upstream, client: 217.55.147.38, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZF3qs HTTP/1.1",upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZF3qs", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/projects-collection?name=%5B%22like%22%2C%22%251438%25%22%5D"
2025/06/12 10:24:05 [error] 1778608#1778608: *172759 connect() failed (111: Unknown error) while connecting to upstream, client: 102.186.82.179, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJ5k HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJ5k", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/user-profile"
2025/06/12 10:24:05 [error] 1778608#1778608: *172760 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJTE HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJTE", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors/PRO-00058"
2025/06/12 10:24:05 [error] 1778608#1778608: *172761 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJTK HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJTK", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/error-log"
2025/06/12 10:24:05 [error] 1778608#1778608: *172762 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJTT HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJTT", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/currency-exchange"
2025/06/12 10:24:06 [error] 1778608#1778608: *172767 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.115.197, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJTh HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJTh", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/employee/view/List"
2025/06/12 10:24:06 [error] 1778608#1778608: *172768 connect() failed (111: Unknown error) while connecting to upstream, client: 83.110.213.142, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJTg HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJTg", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/e-mails"
2025/06/12 10:24:06 [error] 1778608#1778608: *172771 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.115.197, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZFJpB HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZFJpB", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 10:31:03 [error] 1778608#1778608: *172922 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 10:35:09 [error] 1778608#1778608: *173099 upstream timed out (110: Unknown error) while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /api/method/frappe.desk.form.save.savedocs HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.desk.form.save.savedocs", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/project-contractors/new-project-contractors-edrfqggpds"
2025/06/12 10:35:48 [error] 1778608#1778608: *173176 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.115.197, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZH_C0 HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZH_C0", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 10:35:48 [error] 1778608#1778608: *173178 connect() failed (111: Unknown error) while connecting to upstream, client: 102.186.82.179, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZH-k4 HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZH-k4", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/user-profile"
2025/06/12 10:35:49 [error] 1778608#1778608: *173191 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 10:35:49 [error] 1778609#1778609: *173194 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 10:35:49 [error] 1778608#1778608: *173201 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 10:35:49 [error] 1778608#1778608: *173207 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=2810c6c128a065e317d4a9f970413b6ea4f806c1917072718ccda684 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=2810c6c128a065e317d4a9f970413b6ea4f806c1917072718ccda684", host: "erp.smartvgroup.com"
2025/06/12 10:38:42 [error] 1778608#1778608: *173318 upstream timed out (110: Unknown error) while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /api/method/frappe.desk.form.save.savedocs HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.desk.form.save.savedocs", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/project-contractors/new-project-contractors-mpliozmbdd"
2025/06/12 10:46:14 [error] 1778608#1778608: *173496 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=2c3f0b6786229a11952181c12e57d28c3d53d737d5a9b006cc8b3a28 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=2c3f0b6786229a11952181c12e57d28c3d53d737d5a9b006cc8b3a28", host: "erp.smartvgroup.com"
2025/06/12 10:46:14 [error] 1778608#1778608: *173500 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=e2d55b5d0bd94596263ff38a23b18ef8851396d74dd6903296dd9000 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=e2d55b5d0bd94596263ff38a23b18ef8851396d74dd6903296dd9000", host: "erp.smartvgroup.com"
2025/06/12 10:50:22 [error] 1778608#1778608: *173605 connect() failed (111: Unknown error) while connecting to upstream, client: 102.186.82.179, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZLK6H HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZLK6H", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/user-profile"
2025/06/12 12:05:53 [error] 1778608#1778608: *175215 upstream timed out (110: Unknown error) while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /api/method/frappe.desk.form.save.savedocs HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.desk.form.save.savedocs", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/employee-advance/new-employee-advance-nrotjueowc"
2025/06/12 12:06:46 [error] 1778608#1778608: *175372 upstream prematurely closed connection while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcoHa.0&sid=kBEizYXzDBSICVdAAAAX HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcoHa.0&sid=kBEizYXzDBSICVdAAAAX", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
2025/06/12 12:06:46 [error] 1778608#1778608: *175351 upstream prematurely closed connection while reading response header from upstream, client: 197.46.115.197, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpIU.0&sid=r42b8PowBJrVRhy2AAAh HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpIU.0&sid=r42b8PowBJrVRhy2AAAh", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 12:06:46 [error] 1778608#1778608: *175152 upstream prematurely closed connection while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZco2O.0&sid=eeuh7hqF8d6IiudgAAAa HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZco2O.0&sid=eeuh7hqF8d6IiudgAAAa", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/user/omrelwazeery%40smartvgroup.com"
2025/06/12 12:06:46 [error] 1778608#1778608: *175351 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.115.197, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcphl&sid=r42b8PowBJrVRhy2AAAh HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcphl&sid=r42b8PowBJrVRhy2AAAh", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 12:06:46 [error] 1778608#1778608: *175372 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcpPe&sid=kBEizYXzDBSICVdAAAAX HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpPe&sid=kBEizYXzDBSICVdAAAAX", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
2025/06/12 12:06:46 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcpPp&sid=eeuh7hqF8d6IiudgAAAa HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpPp&sid=eeuh7hqF8d6IiudgAAAa", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/user/omrelwazeery%40smartvgroup.com"
2025/06/12 12:06:47 [error] 1778608#1778608: *175382 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpb_ HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpb_", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors"
2025/06/12 12:06:47 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpc8 HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpc8", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/error-log"
2025/06/12 12:06:47 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpjY HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpjY", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
2025/06/12 12:13:43 [error] 1778608#1778608: *175787 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 12:21:40 [error] 1778608#1778608: *176309 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZgDiP HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZgDiP", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
frappe@vmi2187306:~/frappe-bench$ curl -I http://127.0.0.1:8000/
HTTP/1.1 404 NOT FOUND
Server: gunicorn
Date: Thu, 12 Jun 2025 10:38:41 GMT
Connection: close
Content-Type: text/html; charset=utf-8
Content-Length: 111

frappe@vmi2187306:~/frappe-bench$ curl -I http://127.0.0.1:9009/
HTTP/1.1 404 Not Found
Date: Thu, 12 Jun 2025 10:38:45 GMT
Connection: keep-alive
Keep-Alive: timeout=5

frappe@vmi2187306:~/frappe-bench$ ls -la logs/
total 359636
drwxrwxr-x 2 frappe frappe     4096 Jun  6 23:50 .
drwxrwxr-x 9 frappe frappe     4096 Jan 27 08:34 ..
-rw-rw-r-- 1 frappe frappe   646624 Jun 12 12:00 backup.log
-rw-rw-r-x 1 frappe frappe   168027 Jun 12 12:37 bench.log
-rw-rw-r-- 1 frappe frappe    80359 Jun 12 12:22 database.log
-rw-r--r-- 1 frappe frappe    99430 Jun  1 14:11 database.log.1
-rw-r--r-- 1 frappe frappe      754 Apr  7 11:54 database.log.10
-rw-r--r-- 1 frappe frappe      449 Mar 26 02:32 database.log.11
-rw-r--r-- 1 frappe frappe     4209 Mar 26 02:27 database.log.12
-rw-r--r-- 1 frappe frappe     1439 Mar 27 01:29 database.log.13
-rw-r--r-- 1 frappe frappe     1284 Apr  6 17:04 database.log.14
-rw-r--r-- 1 frappe frappe      533 Apr  1 23:07 database.log.15
-rw-r--r-- 1 frappe frappe    99926 Mar 26 00:46 database.log.16
-rw-r--r-- 1 frappe frappe    38847 Mar  6 17:46 database.log.17
-rw-r--r-- 1 frappe frappe      260 Feb 24 00:43 database.log.18
-rw-r--r-- 1 frappe frappe      260 Feb 23 23:58 database.log.19
-rw-r--r-- 1 frappe frappe     7674 May 13 12:36 database.log.2
-rw-r--r-- 1 frappe frappe     3416 Feb 23 23:48 database.log.20
-rw-r--r-- 1 frappe frappe      244 May 13 09:24 database.log.3
-rw-r--r-- 1 frappe frappe      758 May 13 09:25 database.log.4
-rw-r--r-- 1 frappe frappe      317 May 11 20:05 database.log.5
-rw-r--r-- 1 frappe frappe    99944 May 11 15:16 database.log.6
-rw-r--r-- 1 frappe frappe     2181 Apr  6 21:47 database.log.7
-rw-r--r-- 1 frappe frappe      226 Apr  1 23:02 database.log.8
-rw-r--r-- 1 frappe frappe     1314 Apr  7 09:52 database.log.9
-rw-r--r-- 1 frappe frappe    57922 Jun 12 12:05 frappe.log
-rw-r--r-- 1 frappe frappe    18652 May 26 13:17 frappe.log.1
-rw-r--r-- 1 frappe frappe     7370 May  5 21:14 frappe.log.10
-rw-r--r-- 1 frappe frappe     7062 May  5 21:14 frappe.log.11
-rw-r--r-- 1 frappe frappe     6600 May  5 21:14 frappe.log.12
-rw-r--r-- 1 frappe frappe     7502 May  5 21:14 frappe.log.13
-rw-r--r-- 1 frappe frappe     7458 May  5 21:14 frappe.log.14
-rw-r--r-- 1 frappe frappe     9504 May  5 21:42 frappe.log.15
-rw-r--r-- 1 frappe frappe     6908 May  5 21:13 frappe.log.16
-rw-r--r-- 1 frappe frappe     8206 May  5 21:42 frappe.log.17
-rw-r--r-- 1 frappe frappe    10736 May  5 21:42 frappe.log.18
-rw-r--r-- 1 frappe frappe    99990 May  5 21:05 frappe.log.19
-rw-r--r-- 1 frappe frappe    99955 May 26 13:12 frappe.log.2
-rw-r--r-- 1 frappe frappe    24156 May  5 20:39 frappe.log.20
-rw-r--r-- 1 frappe frappe    33519 May 26 13:17 frappe.log.3
-rw-r--r-- 1 frappe frappe    38490 May 26 13:17 frappe.log.4
-rw-r--r-- 1 frappe frappe     8665 May 26 13:02 frappe.log.5
-rw-r--r-- 1 frappe frappe    97587 May 26 13:17 frappe.log.6
-rw-r--r-- 1 frappe frappe     5368 May  5 21:14 frappe.log.7
-rw-r--r-- 1 frappe frappe     7040 May  5 21:14 frappe.log.8
-rw-r--r-- 1 frappe frappe     6930 May  5 21:14 frappe.log.9
-rw-rw-r-- 1 frappe frappe    11468 Jun 12 12:19 ipython.log
-rw-r--r-- 1 frappe frappe  7648024 May  7 10:46 node-socketio.error.log
-rw-r--r-- 1 frappe frappe 11020114 Jun 12 12:25 node-socketio.log
-rw-r--r-- 1 frappe frappe        0 Oct  3  2024 redis-cache.error.log
-rw-r--r-- 1 frappe frappe    61253 Jun 10 12:26 redis-cache.log
-rw-r--r-- 1 frappe frappe        0 Oct  3  2024 redis-queue.error.log
-rw-r--r-- 1 frappe frappe    61253 Jun 10 12:26 redis-queue.log
-rw-r--r-- 1 frappe frappe     5348 Jan 27 09:08 schedule.error.log
-rw-r--r-- 1 frappe frappe        0 Oct  3  2024 schedule.log
-rw-r--r-- 1 frappe frappe    67279 Jun 11 23:07 scheduler.log
-rw-r--r-- 1 frappe frappe    99815 May 28 23:08 scheduler.log.1
-rw-r--r-- 1 frappe frappe    98013 Jan 27 07:04 scheduler.log.10
-rw-r--r-- 1 frappe frappe    98013 Jan 27 06:27 scheduler.log.11
-rw-r--r-- 1 frappe frappe    98013 Jan 27 05:50 scheduler.log.12
-rw-r--r-- 1 frappe frappe    98204 Jan 27 05:13 scheduler.log.13
-rw-r--r-- 1 frappe frappe    99883 May 28 18:45 scheduler.log.2
-rw-r--r-- 1 frappe frappe    99881 May 28 13:57 scheduler.log.3
-rw-r--r-- 1 frappe frappe    99983 May 26 16:33 scheduler.log.4
-rw-r--r-- 1 frappe frappe    99934 May 26 13:46 scheduler.log.5
-rw-r--r-- 1 frappe frappe    99931 May 26 12:59 scheduler.log.6
-rw-r--r-- 1 frappe frappe    99931 May  8 16:50 scheduler.log.7
-rw-r--r-- 1 frappe frappe    97901 Jan 27 08:46 scheduler.log.8
-rw-r--r-- 1 frappe frappe    98013 Jan 27 07:41 scheduler.log.9
-rw-r--r-- 1 frappe frappe  3477918 Jun 12 12:25 web.error.log
-rw-r--r-- 1 frappe frappe  6228622 Jun 12 12:06 web.log
-rw-r--r-- 1 frappe frappe        0 Jan 26 23:50 worker-error.log
-rw-r--r-- 1 frappe frappe  3304133 Jun 12 10:30 worker.error.log
-rw-r--r-- 1 root   root   25291129 Jun 12 12:36 worker.log
-rw-r--r-- 1 root   root   11143562 Jun 10 12:06 worker.log.1
-rw-r--r-- 1 root   root   52429394 Mar 21 07:08 worker.log.10
-rw-r--r-- 1 root   root   52429115 Jun  6 23:50 worker.log.2
-rw-r--r-- 1 root   root   12904739 Jun  1 09:33 worker.log.3
-rw-r--r-- 1 root   root   52428961 May 28 00:48 worker.log.4
-rw-r--r-- 1 root   root    6345816 May 11 12:16 worker.log.5
-rw-r--r-- 1 root   root   52429007 May  8 14:00 worker.log.6
-rw-r--r-- 1 root   root   14727448 Apr 24 06:09 worker.log.7
-rw-r--r-- 1 root   root   52429036 Apr 13 01:00 worker.log.8
-rw-r--r-- 1 root   root     344859 Mar 21 14:16 worker.log.9
frappe@vmi2187306:~/frappe-bench$ tail -50 logs/web.log
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1205, 'Lock wait timeout exceeded; try restarting transaction')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "apps/frappe/frappe/app.py", line 114, in application
    response = frappe.api.handle(request)
  File "apps/frappe/frappe/api/__init__.py", line 49, in handle
    data = endpoint(**arguments)
  File "apps/frappe/frappe/api/v1.py", line 36, in handle_rpc_call
    return frappe.handler.handle()
  File "apps/frappe/frappe/handler.py", line 49, in handle
    data = execute_cmd(cmd)
  File "apps/frappe/frappe/handler.py", line 85, in execute_cmd
    return frappe.call(method, **frappe.form_dict)
  File "apps/frappe/frappe/__init__.py", line 1775, in call
    return fn(*args, **newargs)
  File "apps/frappe/frappe/utils/typing_validations.py", line 31, in wrapper
    return func(*args, **kwargs)
  File "apps/frappe/frappe/desk/form/save.py", line 39, in savedocs
    doc.save()
  File "apps/frappe/frappe/model/document.py", line 337, in save
    return self._save(*args, **kwargs)
  File "apps/frappe/frappe/model/document.py", line 359, in _save
    return self.insert()
  File "apps/frappe/frappe/model/document.py", line 286, in insert
    self.set_new_name(set_name=set_name, set_child_names=set_child_names)
  File "apps/frappe/frappe/model/document.py", line 496, in set_new_name
    set_new_name(self)
  File "apps/frappe/frappe/model/naming.py", line 166, in set_new_name
    set_name_from_naming_options(autoname, doc)
  File "apps/frappe/frappe/model/naming.py", line 204, in set_name_from_naming_options
    set_name_by_naming_series(doc)
  File "apps/frappe/frappe/model/naming.py", line 245, in set_name_by_naming_series
    doc.name = make_autoname(doc.naming_series + ".#####", "", doc)
  File "apps/frappe/frappe/model/naming.py", line 271, in make_autoname
    return series.generate_next_name(doc, ignore_validate=ignore_validate)
  File "apps/frappe/frappe/model/naming.py", line 71, in generate_next_name
    return parse_naming_series(parts, doc=doc)
  File "apps/frappe/frappe/model/naming.py", line 329, in parse_naming_series
    part = number_generator(name, digits)
  File "apps/frappe/frappe/model/naming.py", line 381, in getseries
    current = (frappe.qb.from_(series).where(series.name == key).for_update().select("current")).run()
  File "apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "apps/frappe/frappe/database/database.py", line 236, in sql
    raise frappe.QueryTimeoutError(e) from e
frappe.exceptions.QueryTimeoutError: (1205, 'Lock wait timeout exceeded; try restarting transaction')

frappe@vmi2187306:~/frappe-bench$ tail -50 logs/worker.log
2025-06-12 12:30:29,916 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|Shorouk Jaber Ali El-Kholi', kwargs={'email_account': 'Shorouk Jaber Ali El-Kholi'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::2cd07ebf-7395-49e4-8c0f-9e94354c2644)
2025-06-12 12:30:31,004 home-frappe-frappe-bench:short: Job OK (smartvision.com::2cd07ebf-7395-49e4-8c0f-9e94354c2644)
2025-06-12 12:30:31,004 Result is kept for 600 seconds
2025-06-12 12:30:31,010 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|supervision  gmail', kwargs={'email_account': 'supervision  gmail'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::4c43771f-a310-4c48-b4f2-3bb56c14c0b7)
2025-06-12 12:30:31,401 home-frappe-frappe-bench:short: Job OK (smartvision.com::91e91fb6-1b5e-482d-ba63-8ebbe02adc00)
2025-06-12 12:30:31,401 Result is kept for 600 seconds
2025-06-12 12:30:31,408 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|supervision\xa0\xa0Svec', kwargs={'email_account': 'supervision\xa0\xa0Svec'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::4a9c5309-e749-4d97-92ae-d746707cac4c)
2025-06-12 12:30:35,547 home-frappe-frappe-bench:short: Job OK (smartvision.com::4a9c5309-e749-4d97-92ae-d746707cac4c)
2025-06-12 12:30:35,547 Result is kept for 600 seconds
2025-06-12 12:30:35,555 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|Surthi Aid Motinakat Kunhiraman Kariyat', kwargs={'email_account': 'Surthi Aid Motinakat Kunhiraman Kariyat'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::3fa49c86-24ea-47f4-8995-2664ccaffa6b)
2025-06-12 12:30:35,560 home-frappe-frappe-bench:short: Job OK (smartvision.com::4c43771f-a310-4c48-b4f2-3bb56c14c0b7)
2025-06-12 12:30:35,560 Result is kept for 600 seconds
2025-06-12 12:30:35,569 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|Tawseef Haider Mohamed Latif', kwargs={'email_account': 'Tawseef Haider Mohamed Latif'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::bfc9e184-1efc-4fd0-a9cc-ed4a6e352cc2)
2025-06-12 12:30:36,631 home-frappe-frappe-bench:short: Job OK (smartvision.com::3fa49c86-24ea-47f4-8995-2664ccaffa6b)
2025-06-12 12:30:36,631 Result is kept for 600 seconds
2025-06-12 12:30:36,638 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|Walid Yehia', kwargs={'email_account': 'Walid Yehia'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::f7ed3bb4-ae53-4d48-8f84-a2cf7a160daf)
2025-06-12 12:30:36,689 home-frappe-frappe-bench:short: Job OK (smartvision.com::bfc9e184-1efc-4fd0-a9cc-ed4a6e352cc2)
2025-06-12 12:30:36,690 Result is kept for 600 seconds
2025-06-12 12:30:36,697 home-frappe-frappe-bench:short: frappe.utils.background_jobs.execute_job(event='all', is_async=True, job_name='pull_from_email_account|Yassin Medhat El-Maghawry', kwargs={'email_account': 'Yassin Medhat El-Maghawry'}, method=<function pull_from_email_account at 0x7feabf72d3f0>, site='smartvision.com', user='Administrator') (smartvision.com::37c7dc33-2de6-4f84-9244-e84d55c4e391)
2025-06-12 12:30:37,777 home-frappe-frappe-bench:short: Job OK (smartvision.com::37c7dc33-2de6-4f84-9244-e84d55c4e391)
2025-06-12 12:30:37,777 Result is kept for 600 seconds
2025-06-12 12:30:40,543 home-frappe-frappe-bench:short: Job OK (smartvision.com::f7ed3bb4-ae53-4d48-8f84-a2cf7a160daf)
2025-06-12 12:30:40,544 Result is kept for 600 seconds
2025-06-12 12:32:00,792 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.automation.doctype.reminder.reminder.send_reminders'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.automation.doctype.reminder.reminder.send_reminders)
2025-06-12 12:32:00,794 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.monitor.flush'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.monitor.flush)
2025-06-12 12:32:01,045 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.monitor.flush)
2025-06-12 12:32:01,046 Result is kept for 600 seconds
2025-06-12 12:32:01,052 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.email.queue.flush'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.email.queue.flush)
2025-06-12 12:32:01,064 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.automation.doctype.reminder.reminder.send_reminders)
2025-06-12 12:32:01,064 Result is kept for 600 seconds
2025-06-12 12:32:01,071 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'hrms.hr.doctype.interview.interview.send_interview_reminder'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::hrms.hr.doctype.interview.interview.send_interview_reminder)
2025-06-12 12:32:01,289 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::hrms.hr.doctype.interview.interview.send_interview_reminder)
2025-06-12 12:32:01,289 Result is kept for 600 seconds
2025-06-12 12:32:01,370 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.email.queue.flush)
2025-06-12 12:32:01,370 Result is kept for 600 seconds
2025-06-12 12:35:01,096 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'zk_integration.zk.doctype.device_log.device_log.execute'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::zk_integration.zk.doctype.device_log.device_log.execute)
2025-06-12 12:35:01,411 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::zk_integration.zk.doctype.device_log.device_log.execute)
2025-06-12 12:35:01,411 Result is kept for 600 seconds
2025-06-12 12:36:01,270 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.automation.doctype.reminder.reminder.send_reminders'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.automation.doctype.reminder.reminder.send_reminders)
2025-06-12 12:36:01,271 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.monitor.flush'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.monitor.flush)
2025-06-12 12:36:01,502 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.automation.doctype.reminder.reminder.send_reminders)
2025-06-12 12:36:01,502 Result is kept for 600 seconds
2025-06-12 12:36:01,510 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'frappe.email.queue.flush'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::frappe.email.queue.flush)
2025-06-12 12:36:01,517 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.monitor.flush)
2025-06-12 12:36:01,517 Result is kept for 600 seconds
2025-06-12 12:36:01,524 home-frappe-frappe-bench:default: frappe.utils.background_jobs.execute_job(event=None, is_async=True, job_name='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., kwargs={'job_type': 'hrms.hr.doctype.interview.interview.send_interview_reminder'}, method='frappe.core.doctype.scheduled_job_type.scheduled_job_type.run_scheduled_jo..., site='smartvision.com', user='Administrator') (smartvision.com::scheduled_job::hrms.hr.doctype.interview.interview.send_interview_reminder)
2025-06-12 12:36:01,797 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::hrms.hr.doctype.interview.interview.send_interview_reminder)
2025-06-12 12:36:01,797 Result is kept for 600 seconds
2025-06-12 12:36:01,856 home-frappe-frappe-bench:default: Job OK (smartvision.com::scheduled_job::frappe.email.queue.flush)
2025-06-12 12:36:01,856 Result is kept for 600 seconds
frappe@vmi2187306:~/frappe-bench$ ps aux | grep frappe
frappe    673733  0.0  0.0  17100  9512 ?        Ss   Apr17   0:00 /lib/systemd/systemd --user
frappe    673734  0.0  0.0 170136  4824 ?        S    Apr17   0:00 (sd-pam)
frappe    675862  0.1  0.0  72404  6876 ?        Ssl  Apr17 150:20 redis-server 127.0.0.1:18003
frappe    675876  0.1  0.0 107732 14784 ?        Ssl  Apr17 158:56 redis-server 127.0.0.1:18001
frappe    675882  0.1  0.0  72404  6748 ?        Ssl  Apr17 151:07 redis-server 127.0.0.1:18002
frappe    758639  0.0  0.4 109556 80700 ?        S    Apr22   0:02 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe serve --port 8001
frappe   2130609  0.2  0.0  83124 14232 ?        Sl   Jun10   7:34 /usr/bin/redis-server 127.0.0.1:13000
frappe   2130610  0.2  0.0  72372 10560 ?        Sl   Jun10   7:08 /usr/bin/redis-server 127.0.0.1:11000
frappe   2130624  0.2  0.1  88244 17488 ?        Sl   Jun10   6:27 /usr/bin/redis-server 127.0.0.1:18010
frappe   2130625  0.2  0.0  72372 10344 ?        Sl   Jun10   5:57 /usr/bin/redis-server 127.0.0.1:18004
root     2217649  0.0  0.0  17188 11020 ?        Ss   10:10   0:00 sshd: frappe [priv]
frappe   2217679  0.0  0.0  17320  8180 ?        S    10:10   0:01 sshd: frappe@pts/0
frappe   2217682  0.0  0.0  15216  9296 pts/0    Ss   10:10   0:00 -bash
frappe   2218206  0.0  0.5 257536 85516 pts/0    Tl   10:16   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218248  0.0  0.6 288148 113208 pts/0   Tl   10:17   0:02 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218374  0.0  0.8 308396 132360 pts/0   Tl   10:20   0:03 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2218624  0.0  0.7 305984 130216 pts/0   Tl   10:25   0:04 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219041  0.0  0.7 290864 115496 pts/0   Tl   10:31   0:02 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219308  0.0  0.5 257724 85304 pts/0    Tl   10:36   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219326  0.0  0.0   8404  1024 pts/0    T    10:36   0:00 tail -f /home/frappe/frappe-bench/logs/web.error.log
frappe   2219509  0.0  0.0  22064  9748 pts/0    T    10:43   0:00 /usr/bin/mariadb --user=_86b0b85ccf42b383 --host=127.0.0.1 --port=3306 --password=x xxxxxxxxxxxxxx --pager=less -SFX --safe-updates --no-auto-rehash _86b0b85ccf42b383
frappe   2219513  0.0  0.0   2892  1000 pts/0    T    10:43   0:00 sh -c less -SFX
frappe   2219514  0.0  0.0   8756  2728 pts/0    T    10:43   0:00 less -SFX
frappe   2219584  0.0  0.7 302132 126244 pts/0   Tl   10:45   0:03 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219706  0.0  0.6 286864 111564 pts/0   Tl   10:46   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2219733  0.0  0.5 114864 87268 pts/0    T    10:47   0:05 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com migrate
frappe   2219785  0.0  0.0  22064  9876 pts/0    T    10:48   0:00 /usr/bin/mariadb --user=_86b0b85ccf42b383 --host=127.0.0.1 --port=3306 --password=x xxxxxxxxxxxxxx --pager=less -SFX --safe-updates --no-auto-rehash _86b0b85ccf42b383
frappe   2219809  0.0  0.0   2892  1004 pts/0    T    10:49   0:00 sh -c less -SFX
frappe   2219810  0.0  0.0   8756  2700 pts/0    T    10:49   0:00 less -SFX
frappe   2221912  0.1  0.6 288792 112928 pts/0   Tl   11:48   0:03 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2223987  0.1  0.5 268756 92664 pts/0    Tl   12:24   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe --site smartvision.com console
frappe   2224031  0.1  0.4 107900 80124 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224032  0.1  0.3 933208 62180 ?        Sl   12:25   0:01 /home/frappe/.nvm/versions/node/v18.20.4/bin/node /home/frappe/frappe-bench/apps/frappe/socketio.js
frappe   2224039  0.0  0.4 116608 75048 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224040  0.0  0.4 110660 67424 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224041  0.0  0.4 116320 75152 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224046  0.0  0.4 117748 73632 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224047  0.0  0.4 119924 78560 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224048  0.1  0.4 118884 77116 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224049  0.0  0.4 118092 77012 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224053  0.1  0.5 122860 82032 ?        S    12:25   0:01 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224054  0.0  0.4 116840 75384 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224055  0.0  0.4 116204 74304 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224056  0.0  0.4 112260 68120 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224057  0.0  0.4 115268 73768 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224058  0.0  0.4 116196 74236 ?        S    12:25   0:00 /home/frappe/frappe-bench/env/bin/python /home/frappfrappe-bench/env/bin/gunicorn -b 127.0.0.1:8000 -w 13 --max-requests 5000 --max-requests-jitter 500 -t 120 --graceful-timeout 30 frappe.app:application --preload
frappe   2224059  0.1  0.3  86504 61284 ?        SN   12:25   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe schedule
frappe   2224060  0.1  0.3 158096 59136 ?        SNl  12:25   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue short,default
frappe   2224061  0.1  0.3 158096 59304 ?        SNl  12:25   0:01 /home/frappe/frappe-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue long,default,short
frappe   2224216 12.1  1.6 1505660 270072 ?      Sl   12:28   1:16 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe serve --port 8001
frappe   2224231  0.1  0.3 636548 58600 ?        Sl   12:28   0:00 /home/frappe/.nvm/versions/node/v18.20.4/bin/node /home/frappe/test-bench/apps/frappe/socketio.js
frappe   2224241  0.1  0.4  98248 70420 ?        SN   12:28   0:01 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe schedule
frappe   2224242  0.2  0.4 169732 68380 ?        SNl  12:28   0:01 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue short,default
frappe   2224243  0.2  0.4 169732 68228 ?        SNl  12:28   0:01 /home/frappe/test-bench/env/bin/python -m frappe.utils.bench_helper frappe worker --queue long,default,short
frappe   2224679  0.0  0.0  12672  3516 pts/0    R+   12:39   0:00 ps aux
frappe   2224680  0.0  0.0   9212  2216 pts/0    S+   12:39   0:00 grep --color=auto frappe
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SHOW PROCESSLIST;"
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
| Id   | User              | Host            | db                | Command | Time | State    | Info             | Progress |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
|  895 | _86b0b85ccf42b383 | localhost:57180 | _86b0b85ccf42b383 | Sleep   |  887 |          | NULL             |    0.000 |
| 1256 | _86b0b85ccf42b383 | localhost:57948 | _86b0b85ccf42b383 | Query   |    0 | starting | SHOW PROCESSLIST |    0.000 |
+------+-------------------+-----------------+-------------------+---------+------+----------+------------------+----------+
frappe@vmi2187306:~/frappe-bench$ tail -f logs/web.error.log
[2025-06-12 12:25:58 +0200] [2224046] [INFO] Booting worker with pid: 2224046
[2025-06-12 12:25:58 +0200] [2224047] [INFO] Booting worker with pid: 2224047
[2025-06-12 12:25:59 +0200] [2224048] [INFO] Booting worker with pid: 2224048
[2025-06-12 12:25:59 +0200] [2224049] [INFO] Booting worker with pid: 2224049
[2025-06-12 12:25:59 +0200] [2224053] [INFO] Booting worker with pid: 2224053
[2025-06-12 12:25:59 +0200] [2224054] [INFO] Booting worker with pid: 2224054
[2025-06-12 12:25:59 +0200] [2224055] [INFO] Booting worker with pid: 2224055
[2025-06-12 12:25:59 +0200] [2224056] [INFO] Booting worker with pid: 2224056
[2025-06-12 12:25:59 +0200] [2224057] [INFO] Booting worker with pid: 2224057
[2025-06-12 12:25:59 +0200] [2224058] [INFO] Booting worker with pid: 2224058
^Z
[20]+  Stopped                 tail -f logs/web.error.log
frappe@vmi2187306:~/frappe-bench$ tail -f logs/web.error.log
[2025-06-12 12:25:58 +0200] [2224046] [INFO] Booting worker with pid: 2224046
[2025-06-12 12:25:58 +0200] [2224047] [INFO] Booting worker with pid: 2224047
[2025-06-12 12:25:59 +0200] [2224048] [INFO] Booting worker with pid: 2224048
[2025-06-12 12:25:59 +0200] [2224049] [INFO] Booting worker with pid: 2224049
[2025-06-12 12:25:59 +0200] [2224053] [INFO] Booting worker with pid: 2224053
[2025-06-12 12:25:59 +0200] [2224054] [INFO] Booting worker with pid: 2224054
[2025-06-12 12:25:59 +0200] [2224055] [INFO] Booting worker with pid: 2224055
[2025-06-12 12:25:59 +0200] [2224056] [INFO] Booting worker with pid: 2224056
[2025-06-12 12:25:59 +0200] [2224057] [INFO] Booting worker with pid: 2224057
[2025-06-12 12:25:59 +0200] [2224058] [INFO] Booting worker with pid: 2224058
^Z
[21]+  Stopped                 tail -f logs/web.error.log
frappe@vmi2187306:~/frappe-bench$ tail -20 logs/web.log
  File "apps/frappe/frappe/model/naming.py", line 166, in set_new_name
    set_name_from_naming_options(autoname, doc)
  File "apps/frappe/frappe/model/naming.py", line 204, in set_name_from_naming_options
    set_name_by_naming_series(doc)
  File "apps/frappe/frappe/model/naming.py", line 245, in set_name_by_naming_series
    doc.name = make_autoname(doc.naming_series + ".#####", "", doc)
  File "apps/frappe/frappe/model/naming.py", line 271, in make_autoname
    return series.generate_next_name(doc, ignore_validate=ignore_validate)
  File "apps/frappe/frappe/model/naming.py", line 71, in generate_next_name
    return parse_naming_series(parts, doc=doc)
  File "apps/frappe/frappe/model/naming.py", line 329, in parse_naming_series
    part = number_generator(name, digits)
  File "apps/frappe/frappe/model/naming.py", line 381, in getseries
    current = (frappe.qb.from_(series).where(series.name == key).for_update().select("current")).run()
  File "apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "apps/frappe/frappe/database/database.py", line 236, in sql
    raise frappe.QueryTimeoutError(e) from e
frappe.exceptions.QueryTimeoutError: (1205, 'Lock wait timeout exceeded; try restarting transaction')

frappe@vmi2187306:~/frappe-bench$ tail -10 /var/log/nginx/error.log
tail: cannot open '/var/log/nginx/error.log' for reading: Permission denied
frappe@vmi2187306:~/frappe-bench$ sudo tail -10 /var/log/nginx/error.log
2025/06/12 12:06:46 [error] 1778608#1778608: *175351 upstream prematurely closed connection while reading response header from upstream, client: 197.46.115.197, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpIU.0&sid=r42b8PowBJrVRhy2AAAh HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpIU.0&sid=r42b8PowBJrVRhy2AAAh", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 12:06:46 [error] 1778608#1778608: *175152 upstream prematurely closed connection while reading response header from upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZco2O.0&sid=eeuh7hqF8d6IiudgAAAa HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZco2O.0&sid=eeuh7hqF8d6IiudgAAAa", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/user/omrelwazeery%40smartvgroup.com"
2025/06/12 12:06:46 [error] 1778608#1778608: *175351 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.115.197, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcphl&sid=r42b8PowBJrVRhy2AAAh HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcphl&sid=r42b8PowBJrVRhy2AAAh", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/team-tasks/Payment%20Follow%20up"
2025/06/12 12:06:46 [error] 1778608#1778608: *175372 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcpPe&sid=kBEizYXzDBSICVdAAAAX HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpPe&sid=kBEizYXzDBSICVdAAAAX", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
2025/06/12 12:06:46 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "POST /socket.io/?EIO=4&transport=polling&t=PTZcpPp&sid=eeuh7hqF8d6IiudgAAAa HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpPp&sid=eeuh7hqF8d6IiudgAAAa", host: "erp.smartvgroup.com", referrer: "https://erp.smartvgroup.com/app/user/omrelwazeery%40smartvgroup.com"
2025/06/12 12:06:47 [error] 1778608#1778608: *175382 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpb_ HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpb_", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors"
2025/06/12 12:06:47 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpc8 HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpc8", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/error-log"
2025/06/12 12:06:47 [error] 1778608#1778608: *175152 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZcpjY HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZcpjY", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
2025/06/12 12:13:43 [error] 1778608#1778608: *175787 connect() failed (111: Unknown error) while connecting to upstream, client: 84.247.165.136, server: smartvision.com, request: "GET /api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910 HTTP/1.1", upstream: "http://127.0.0.1:8000/api/method/frappe.realtime.get_user_info?sid=279a19daeccedea3b54e7ee020600b686edadbf4f998245b29570910", host: "erp.smartvgroup.com"
2025/06/12 12:21:40 [error] 1778608#1778608: *176309 connect() failed (111: Unknown error) while connecting to upstream, client: 197.46.106.141, server: smartvision.com, request: "GET /socket.io/?EIO=4&transport=polling&t=PTZgDiP HTTP/1.1", upstream: "http://127.0.0.1:9009/socket.io/?EIO=4&transport=polling&t=PTZgDiP", host: "erp.smartvgroup.com", referrer:"https://erp.smartvgroup.com/app/project-contractors/PRO-00060"
frappe@vmi2187306:~/frappe-bench$ grep "create_employee_advances" logs/web.log | tail -5
frappe@vmi2187306:~/frappe-bench$ # Edit MariaDB configuration
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
frappe@vmi2187306:~/frappe-bench$ sudo systemctl restart mariadb
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SHOW VARIABLES LIKE 'innodb_rollback_on_timeout';"
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| innodb_rollback_on_timeout | ON    |
+----------------------------+-------+
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SHOW VARIABLES LIKE 'transaction_isolation';"
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SHOW VARIABLES LIKE 'innodb_autoinc_lock_mode';"
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| innodb_autoinc_lock_mode | 2     |
+--------------------------+-------+
frappe@vmi2187306:~/frappe-bench$ bench --site smartvision.com mariadb -e "SHOW VARIABLES LIKE '%isolation%';"
+---------------------------+----------------+
| Variable_name             | Value          |
+---------------------------+----------------+
| innodb_snapshot_isolation | OFF            |
| tx_isolation              | READ-COMMITTED |
+---------------------------+----------------+
frappe@vmi2187306:~/frappe-bench$ bench restart
$ sudo supervisorctl restart frappe-bench-web:
frappe-bench-web:frappe-bench-node-socketio: stopped
frappe-bench-web:frappe-bench-frappe-web: stopped
frappe-bench-web:frappe-bench-frappe-web: started
frappe-bench-web:frappe-bench-node-socketio: started
$ sudo supervisorctl restart frappe-bench-workers:
frappe-bench-workers:frappe-bench-frappe-schedule: stopped
frappe-bench-workers:frappe-bench-frappe-long-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-short-worker-0: stopped
frappe-bench-workers:frappe-bench-frappe-schedule: started
frappe-bench-workers:frappe-bench-frappe-short-worker-0: started
frappe-bench-workers:frappe-bench-frappe-long-worker-0: started
INFO: A newer version of bench is available: 5.22.9 → 5.25.2
frappe@vmi2187306:~/frappe-bench$ tail -f logs/web.error.log
[2025-06-12 12:46:21 +0200] [2225193] [INFO] Booting worker with pid: 2225193
[2025-06-12 12:46:21 +0200] [2225197] [INFO] Booting worker with pid: 2225197
[2025-06-12 12:46:21 +0200] [2225198] [INFO] Booting worker with pid: 2225198
[2025-06-12 12:46:21 +0200] [2225199] [INFO] Booting worker with pid: 2225199
[2025-06-12 12:46:21 +0200] [2225200] [INFO] Booting worker with pid: 2225200
[2025-06-12 12:46:22 +0200] [2225201] [INFO] Booting worker with pid: 2225201
[2025-06-12 12:46:22 +0200] [2225202] [INFO] Booting worker with pid: 2225202
[2025-06-12 12:46:22 +0200] [2225206] [INFO] Booting worker with pid: 2225206
[2025-06-12 12:46:22 +0200] [2225211] [INFO] Booting worker with pid: 2225211
[2025-06-12 12:46:22 +0200] [2225214] [INFO] Booting worker with pid: 2225214
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
ERROR   Property: Invalid value for "CSS Level 2.1" property: var(--gray-900) [14:3: color]
WARNING Property: Unknown Property name. [64:2: word-wrap]
WARNING Property: Unknown Property name. [83:2: columns]
WARNING Property: Unknown Property name. [90:2: background-size]
WARNING Property: Unknown Property name. [98:2: object-fit]
WARNING Property: Unknown Property name. [110:2: -webkit-print-color-adjust]
WARNING Property: Unknown Property name. [158:2: word-break]
WARNING Property: Unknown Property name. [285:3: -webkit-text-size-adjust]
WARNING Property: Unknown Property name. [320:3: transition]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [381:3: display]
WARNING Property: Unknown Property name. [382:3: justify-content]
WARNING Property: Unknown Property name. [383:3: align-items]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [389:3: display]
WARNING Property: Unknown Property name. [390:3: justify-content]
WARNING Property: Unknown Property name. [391:3: align-items]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [396:3: display]
WARNING Property: Unknown Property name. [404:3: flex]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [411:3: display]
WARNING Property: Unknown Property name. [412:3: justify-content]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [546:19: display]
WARNING Property: Unknown Property name. [547:19: justify-content]
WARNING Property: Unknown Property name. [553:19: flex]
WARNING Property: Unknown Property name. [592:5: break-inside]
WARNING Property: Unknown Property name. [603:5: break-inside]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [637:13: display]
WARNING Property: Unknown Property name. [638:13: justify-content]
WARNING Property: Unknown Property name. [639:13: align-items]
WARNING Property: Unknown Property name. [645:13: object-fit]
WARNING Property: Unknown Property name. [651:13: transform]
WARNING Property: Unknown Property name. [655:13: pointer-events]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [702:13: display]
WARNING Property: Unknown Property name. [703:13: justify-content]
WARNING Property: Unknown Property name. [704:13: align-items]
ERROR   Property: Invalid value for "CSS Level 2.1" property: flex [718:13: display]
WARNING Property: Unknown Property name. [719:13: justify-content]
WARNING Property: Unknown Property name. [724:13: flex]
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4
^Z
[22]+  Stopped                 tail -f logs/web.error.log
frappe@vmi2187306:~/frappe-bench$ cd /home/frappe/frappe-bench && bench --site frappe-bench logs
Usage: bench frappe [OPTIONS] COMMAND [ARGS]...
Try 'bench frappe --help' for help.

Error: No such command 'logs'.
frappe@vmi2187306:~/frappe-bench$ tail -n 50 logs/frappe.log
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 649, in connect
    sock = socket.create_connection(
  File "/usr/lib/python3.10/socket.py", line 845, in create_connection
    raise err
  File "/usr/lib/python3.10/socket.py", line 833, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 86, in log_error_snapshot
    log_error(title=str(exception), defer_insert=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 61, in log_error
    error_log = frappe.get_doc(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1340, in get_doc
    doc = frappe.model.document.get_doc(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 83, in get_doc
    controller = get_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 70, in get_controller
    site_controllers[doctype] = import_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 81, in import_controller
    doctype_info = frappe.db.get_value("DocType", doctype, fieldname="*")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 512, in get_value
    result = self.get_values(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 616, in get_values
    out = self._get_values_from_table(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 889, in _get_values_from_table
    return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 204, in sql
    self.connect()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 109, in connect
    self._conn: "MariadbConnection" | "PostgresConnection" = self.get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 107, in get_connection
    conn = self._get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 113, in _get_connection
    return self.create_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 116, in create_connection
    return pymysql.connect(**self.get_connection_settings())
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 361, in __init__
    self.connect()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 716, in connect
    raise exc
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([Errno 111] Connection refused)")
2025-06-12 12:05:53,784 ERROR frappe New Exception collected in error log
Site: smartvision.com
Form Dict: {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save', 'cmd': 'frappe.desk.form.save.savedocs'}
frappe@vmi2187306:~/frappe-bench$    sudo systemctl status mysql
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2025-06-12 12:45:22 CEST; 15min ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
    Process: 2224966 ExecStartPre=/usr/bin/install -m 755 -o mysql -g root -d /var/run/mysqld (code=exited, status=0/SU>
    Process: 2224967 ExecStartPre=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/S>
    Process: 2224969 ExecStartPre=/bin/sh -c [ ! -e /usr/bin/galera_recovery ] && VAR= ||   VAR=`cd /usr/bin/..; /usr/b>
    Process: 2225068 ExecStartPost=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/>
    Process: 2225070 ExecStartPost=/etc/mysql/debian-start (code=exited, status=0/SUCCESS)
   Main PID: 2225053 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 18 (limit: 126178)
     Memory: 788.6M
        CPU: 14.723s
     CGroup: /system.slice/mariadb.service
             └─2225053 /usr/sbin/mariadbd

Jun 12 12:45:22 vmi2187306.contaboserver.net mariadbd[2225053]: Version: '10.6.18-MariaDB-0ubuntu0.22.04.1'  socket: '/>
Jun 12 12:45:22 vmi2187306.contaboserver.net systemd[1]: Started MariaDB 10.6.18 database server.
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225072]: Upgrading MySQL tables if necessary.
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: Looking for 'mariadb' as: /usr/bin/maria>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: Looking for 'mariadb-check' as: /usr/bin>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: This installation of MariaDB is already >
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: There is no need to run mysql_upgrade ag>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: You can use --force if you still want to>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225083]: Checking for insecure root accounts.
Jun 12 12:45:24 vmi2187306.contaboserver.net mariadbd[2225053]: 2025-06-12 12:45:24 0 [Note] InnoDB: Buffer pool(s) loa>
lines 1-28/28 (END)
[23]+  Stopped                 sudo systemctl status mysql
frappe@vmi2187306:~/frappe-bench$    sudo systemctl status mariadb
● mariadb.service - MariaDB 10.6.18 database server
     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2025-06-12 12:45:22 CEST; 15min ago
       Docs: man:mariadbd(8)
             https://mariadb.com/kb/en/library/systemd/
    Process: 2224966 ExecStartPre=/usr/bin/install -m 755 -o mysql -g root -d /var/run/mysqld (code=exited, status=0/SU>
    Process: 2224967 ExecStartPre=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/S>
    Process: 2224969 ExecStartPre=/bin/sh -c [ ! -e /usr/bin/galera_recovery ] && VAR= ||   VAR=`cd /usr/bin/..; /usr/b>
    Process: 2225068 ExecStartPost=/bin/sh -c systemctl unset-environment _WSREP_START_POSITION (code=exited, status=0/>
    Process: 2225070 ExecStartPost=/etc/mysql/debian-start (code=exited, status=0/SUCCESS)
   Main PID: 2225053 (mariadbd)
     Status: "Taking your SQL requests now..."
      Tasks: 18 (limit: 126178)
     Memory: 788.6M
        CPU: 14.732s
     CGroup: /system.slice/mariadb.service
             └─2225053 /usr/sbin/mariadbd

Jun 12 12:45:22 vmi2187306.contaboserver.net mariadbd[2225053]: Version: '10.6.18-MariaDB-0ubuntu0.22.04.1'  socket: '/>
Jun 12 12:45:22 vmi2187306.contaboserver.net systemd[1]: Started MariaDB 10.6.18 database server.
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225072]: Upgrading MySQL tables if necessary.
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: Looking for 'mariadb' as: /usr/bin/maria>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: Looking for 'mariadb-check' as: /usr/bin>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: This installation of MariaDB is already >
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: There is no need to run mysql_upgrade ag>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225075]: You can use --force if you still want to>
Jun 12 12:45:22 vmi2187306.contaboserver.net /etc/mysql/debian-start[2225083]: Checking for insecure root accounts.
Jun 12 12:45:24 vmi2187306.contaboserver.net mariadbd[2225053]: 2025-06-12 12:45:24 0 [Note] InnoDB: Buffer pool(s) loa>
lines 1-28/28 (END)
[24]+  Stopped                 sudo systemctl status mariadb
frappe@vmi2187306:~/frappe-bench$    sudo netstat -tlnp | grep 3306
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      2225053/mariadbd
frappe@vmi2187306:~/frappe-bench$    tail -f logs/frappe.log
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 116, in create_connection
    return pymysql.connect(**self.get_connection_settings())
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 361, in __init__
    self.connect()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 716, in connect
    raise exc
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([Errno 111] Connection refused)")
2025-06-12 12:05:53,784 ERROR frappe New Exception collected in error log
Site: smartvision.com
Form Dict: {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save', 'cmd': 'frappe.desk.form.save.savedocs'}


^Z
[25]+  Stopped                 tail -f logs/frappe.log
frappe@vmi2187306:~/frappe-bench$ tail -n 50 logs/frappe.log
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 649, in connect
    sock = socket.create_connection(
  File "/usr/lib/python3.10/socket.py", line 845, in create_connection
    raise err
  File "/usr/lib/python3.10/socket.py", line 833, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 86, in log_error_snapshot
    log_error(title=str(exception), defer_insert=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 61, in log_error
    error_log = frappe.get_doc(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1340, in get_doc
    doc = frappe.model.document.get_doc(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 83, in get_doc
    controller = get_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 70, in get_controller
    site_controllers[doctype] = import_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 81, in import_controller
    doctype_info = frappe.db.get_value("DocType", doctype, fieldname="*")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 512, in get_value
    result = self.get_values(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 616, in get_values
    out = self._get_values_from_table(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 889, in _get_values_from_table
    return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 204, in sql
    self.connect()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 109, in connect
    self._conn: "MariadbConnection" | "PostgresConnection" = self.get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 107, in get_connection
    conn = self._get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 113, in _get_connection
    return self.create_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 116, in create_connection
    return pymysql.connect(**self.get_connection_settings())
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 361, in __init__
    self.connect()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 716, in connect
    raise exc
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([Errno 111] Connection refused)")
2025-06-12 12:05:53,784 ERROR frappe New Exception collected in error log
Site: smartvision.com
Form Dict: {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save', 'cmd': 'frappe.desk.form.save.savedocs'}
frappe@vmi2187306:~/frappe-bench$ tail -n 50 logs/frappe.log
Traceback (most recent call last):
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 649, in connect
    sock = socket.create_connection(
  File "/usr/lib/python3.10/socket.py", line 845, in create_connection
    raise err
  File "/usr/lib/python3.10/socket.py", line 833, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 86, in log_error_snapshot
    log_error(title=str(exception), defer_insert=True)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/utils/error.py", line 61, in log_error
    error_log = frappe.get_doc(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/__init__.py", line 1340, in get_doc
    doc = frappe.model.document.get_doc(*args, **kwargs)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/document.py", line 83, in get_doc
    controller = get_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 70, in get_controller
    site_controllers[doctype] = import_controller(doctype)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py", line 81, in import_controller
    doctype_info = frappe.db.get_value("DocType", doctype, fieldname="*")
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 512, in get_value
    result = self.get_values(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 616, in get_values
    out = self._get_values_from_table(
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 889, in _get_values_from_table
    return query.run(as_dict=as_dict, debug=debug, update=update, run=run, pluck=pluck)
  File "/home/frappe/frappe-bench/apps/frappe/frappe/query_builder/utils.py", line 87, in execute_query
    result = frappe.db.sql(query, params, *args, **kwargs)  # nosemgrep
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 204, in sql
    self.connect()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/database.py", line 109, in connect
    self._conn: "MariadbConnection" | "PostgresConnection" = self.get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 107, in get_connection
    conn = self._get_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 113, in _get_connection
    return self.create_connection()
  File "/home/frappe/frappe-bench/apps/frappe/frappe/database/mariadb/database.py", line 116, in create_connection
    return pymysql.connect(**self.get_connection_settings())
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 361, in __init__
    self.connect()
  File "/home/frappe/frappe-bench/env/lib/python3.10/site-packages/pymysql/connections.py", line 716, in connect
    raise exc
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server on '127.0.0.1' ([Errno 111] Connection refused)")
2025-06-12 12:05:53,784 ERROR frappe New Exception collected in error log
Site: smartvision.com
Form Dict: {'doc': '{"docstatus":0,"doctype":"Employee Advance","name":"new-employee-advance-nrotjueowc","__islocal":1,"__unsaved":1,"owner":"Administrator","naming_series":"HR-EAD-.YYYY.-","posting_date":"2025-06-11","company":"Orbit","currency":"AED","custom_type":"Advance","repay_unclaimed_amount_from_salary":0,"status":"Draft","__run_link_triggers":false,"employee":"Mahmoud El Saeed","exchange_rate":1,"purpose":"Advance for رسوم امانات","advance_amount":5000,"advance_account":"Employee Advances - OR","project_contractors_reference":"PRO-00048","item_reference":"رسوم امانات","creation":"","modified_by":"Administrator","modified":"","lft":null,"rgt":null,"idx":null}', 'action': 'Save', 'cmd': 'frappe.desk.form.save.savedocs'}
frappe@vmi2187306:~/frappe-bench$ cat sites/frappe-bench/site_config.json
cat: sites/frappe-bench/site_config.json: No such file or directory
frappe@vmi2187306:~/frappe-bench$
